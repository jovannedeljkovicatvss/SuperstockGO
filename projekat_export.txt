FILE: gradle.properties

# Project-wide Gradle settings.
# IDE (e.g. Android Studio) users:
# Gradle settings configured through the IDE *will override*
# any settings specified in this file.
# For more details on how to configure your build environment visit
# http://www.gradle.org/docs/current/userguide/build_environment.html
# Specifies the JVM arguments used for the daemon process.
# The setting is particularly useful for tweaking memory settings.
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
# When configured, Gradle will run in incubating parallel mode.
# This option should only be used with decoupled projects. For more details, visit
# https://developer.android.com/r/tools/gradle-multi-project-decoupled-projects
# org.gradle.parallel=true
# AndroidX package structure to make it clearer which packages are bundled with the
# Android operating system, and which are packaged with your app's APK
# https://developer.android.com/topic/libraries/support-library/androidx-rn
android.useAndroidX=true
# Kotlin code style for this project: "official" or "obsolete":
kotlin.code.style=official
# Enables namespacing of each library's R class so that its R class includes only the
# resources declared in the library itself and none from the library's dependencies,
# thereby reducing the size of the R class for that library
android.nonTransitiveRClass=true
android.suppressUnsupportedCompileSdk=34


FILE: app\google-services.json

{
  "project_info": {
    "project_number": "346496578938",
    "project_id": "superstockgo",
    "storage_bucket": "superstockgo.firebasestorage.app"
  },
  "client": [
    {
      "client_info": {
        "mobilesdk_app_id": "1:346496578938:android:2a8741d5547c95309d92c3",
        "android_client_info": {
          "package_name": "com.jovannedeljkovic.superstockgo"
        }
      },
      "oauth_client": [],
      "api_key": [
        {
          "current_key": "AIzaSyB0r_jmueBJo0oZuVrlVvf3KTqex3iLq8E"
        }
      ],
      "services": {
        "appinvite_service": {
          "other_platform_oauth_client": []
        }
      }
    }
  ],
  "configuration_version": "1"
}


FILE: app\proguard-rules.pro

# Add project specific ProGuard rules here.
# You can control the set of applied configuration files using the
# proguardFiles setting in build.gradle.
#
# For more details, see
#   http://developer.android.com/guide/developing/tools/proguard.html

# If your project uses WebView with JS, uncomment the following
# and specify the fully qualified class name to the JavaScript interface
# class:
#-keepclassmembers class fqcn.of.javascript.interface.for.webview {
#   public *;
#}

# Uncomment this to preserve the line number information for
# debugging stack traces.
#-keepattributes SourceFile,LineNumberTable

# If you keep the line number information, uncomment this to
# hide the original source file name.
#-renamesourcefileattribute SourceFile


FILE: app\src\androidTest\java\com\jovannedeljkovic\superstockgo\ExampleInstrumentedTest.kt

package com.jovannedeljkovic.superstockgo

import androidx.test.platform.app.InstrumentationRegistry
import androidx.test.ext.junit.runners.AndroidJUnit4

import org.junit.Test
import org.junit.runner.RunWith

import org.junit.Assert.*

/**
 * Instrumented test, which will execute on an Android device.
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
@RunWith(AndroidJUnit4::class)
class ExampleInstrumentedTest {
    @Test
    fun useAppContext() {
        // Context of the app under test.
        val appContext = InstrumentationRegistry.getInstrumentation().targetContext
        assertEquals("com.jovannedeljkovic.superstockgo", appContext.packageName)
    }
}


FILE: app\src\main\AndroidManifest.xml

<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">

    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />

    <!-- SMS permisije -->
    <uses-permission android:name="android.permission.SEND_SMS" />
    <uses-permission android:name="android.permission.READ_PHONE_STATE"
        tools:ignore="ProtectedPermissions" />
    <uses-permission android:name="android.permission.READ_SMS" />
    <uses-permission android:name="android.permission.RECEIVE_SMS" />

    <!-- Za notifikacije (Android 13+) -->
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS"
        tools:ignore="UnusedAttribute" />

    <!-- Za file export (PDF/TXT) i backup -->
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"
        android:maxSdkVersion="28" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"
        tools:ignore="ScopedStorage" />

    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"
        android:maxSdkVersion="28" />
    <!-- SMS permisije -->
    <uses-feature android:name="android.hardware.telephony" android:required="false" />
    <application
        android:allowBackup="false"
        android:fullBackupContent="false"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.SuperstockGO"
        tools:targetApi="31">

        <!-- LOGIN AKTIVNOST - PRVA -->
        <activity
            android:name=".LoginActivity"
            android:exported="true"
            android:theme="@style/Theme.SuperstockGO.NoActionBar">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>

        <!-- KATEGORIJE AKTIVNOST -->
        <activity
            android:name=".KategorijeActivity"
            android:exported="false"
            android:theme="@style/Theme.SuperstockGO.NoActionBar" />

        <!-- GLAVNA AKTIVNOST - LISTA PROIZVODA -->
        <activity
            android:name=".MainActivity"
            android:exported="false"
            android:theme="@style/Theme.SuperstockGO.NoActionBar" />

        <!-- AKTIVNOST ZA DODAVANJE/IZMENU -->
        <activity
            android:name=".DodajIzmeniActivity"
            android:exported="false"
            android:theme="@style/Theme.SuperstockGO.NoActionBar" />

        <!-- CLOUD SINHRONIZACIJA -->
        <activity
            android:name=".CloudSyncActivity"
            android:exported="false"
            android:theme="@style/Theme.SuperstockGO.NoActionBar" />

        <!-- STATISTIKE AKTIVNOST - DODAJTE OVO! -->
        <activity
            android:name=".StatsActivity"
            android:exported="false"
            android:theme="@style/Theme.SuperstockGO.NoActionBar"
            android:screenOrientation="portrait" />

        <activity
            android:name=".BackupRestoreActivity"
            android:exported="false"
            android:theme="@style/Theme.SuperstockGO.NoActionBar" />

        <!-- FILE PROVIDER za deljenje fajlova -->
        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="${applicationId}.provider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths" />
        </provider>

        <service
            android:name=".PushNotificationService"
            android:exported="false">
            <intent-filter>
                <action android:name="com.google.firebase.MESSAGING_EVENT" />
            </intent-filter>
        </service>

        <meta-data
            android:name="com.google.firebase.messaging.default_notification_channel_id"
            android:value="low_stock_channel" />

        <meta-data
            android:name="com.google.firebase.messaging.default_notification_icon"
            android:resource="@drawable/ic_notification" />

        <meta-data
            android:name="com.google.firebase.messaging.default_notification_color"
            android:resource="@color/purple_500" />

        <!-- Firebase Database URL -->
        <meta-data
            android:name="firebase_database_url"
            android:value="https://superstockgo-default-rtdb.europe-west1.firebasedatabase.app" />

    </application>

</manifest>


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\BackupRestoreActivity.kt

package com.jovannedeljkovic.superstockgo

import android.app.AlertDialog
import android.content.Intent
import android.net.Uri
import android.os.Build
import android.os.Bundle
import android.os.Environment
import android.provider.Settings
import android.util.Log
import android.widget.*
import androidx.appcompat.app.AppCompatActivity
import androidx.core.content.FileProvider
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.io.File
import androidx.localbroadcastmanager.content.LocalBroadcastManager

class BackupRestoreActivity : AppCompatActivity() {

    private lateinit var repository: Repository
    private lateinit var backupHelper: LocalBackupHelper
    private lateinit var btnCreateBackup: Button
    private lateinit var btnRestoreBackup: Button
    private lateinit var btnExportCSV: Button
    private lateinit var listViewBackups: ListView
    private lateinit var progressBar: ProgressBar
    private lateinit var tvStatus: TextView

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_backup_restore)

        repository = Repository(this)
        backupHelper = LocalBackupHelper(this)

        btnCreateBackup = findViewById(R.id.btnCreateBackup)
        btnRestoreBackup = findViewById(R.id.btnRestoreBackup)
        btnExportCSV = findViewById(R.id.btnExportCSV)
        listViewBackups = findViewById(R.id.listViewBackups)
        progressBar = findViewById(R.id.progressBar)
        tvStatus = findViewById(R.id.tvStatus)

        setupListeners()
        loadBackupList()
    }

    private fun setupListeners() {
        btnCreateBackup.setOnClickListener {
            createBackup()
        }

        btnRestoreBackup.setOnClickListener {
            showRestoreOptions()
        }

        btnExportCSV.setOnClickListener {
            exportToCSV()
        }
    }

    private fun loadBackupList() {
        CoroutineScope(Dispatchers.IO).launch {
            try {
                val backups = backupHelper.getAvailableBackups()

                withContext(Dispatchers.Main) {
                    if (backups.isEmpty()) {
                        tvStatus.text = "Nema backup fajlova"
                        return@withContext
                    }

                    val backupNames = backups.map { file ->
                        val date = java.text.SimpleDateFormat("dd.MM.yyyy HH:mm", java.util.Locale.getDefault())
                            .format(java.util.Date(file.lastModified()))
                        "${file.nameWithoutExtension} ($date)"
                    }

                    val adapter = ArrayAdapter(
                        this@BackupRestoreActivity,
                        android.R.layout.simple_list_item_1,
                        backupNames
                    )
                    listViewBackups.adapter = adapter

                    listViewBackups.setOnItemClickListener { _, _, position, _ ->
                        if (position < backups.size) {
                            val backupFile = backups[position]
                            showBackupOptionsDialog(backupFile)
                        }
                    }

                    tvStatus.text = "Pronaðeno ${backups.size} backup fajlova"
                }
            } catch (e: Exception) {
                Log.e("BackupRestore", "Greška pri uèitavanju backup-a: ${e.message}")
            }
        }
    }

    private fun createBackup() {
        progressBar.visibility = ProgressBar.VISIBLE
        tvStatus.text = "Kreiranje backup-a..."

        CoroutineScope(Dispatchers.IO).launch {
            try {
                repository.sviProizvodi { proizvodi ->
                    if (proizvodi.isEmpty()) {
                        runOnUiThread {
                            progressBar.visibility = ProgressBar.GONE
                            Toast.makeText(
                                this@BackupRestoreActivity,
                                "Nema podataka za backup",
                                Toast.LENGTH_SHORT
                            ).show()
                        }
                        return@sviProizvodi
                    }

                    // Kreiraj backup
                    val backupFile = backupHelper.createBackup(proizvodi)

                    runOnUiThread {
                        progressBar.visibility = ProgressBar.GONE

                        if (backupFile != null) {
                            tvStatus.text = "Backup kreiran!"

                            AlertDialog.Builder(this@BackupRestoreActivity)
                                .setTitle("? Backup uspešan!")
                                .setMessage("Backup je saèuvan u:\n${backupFile.absolutePath}")
                                .setPositiveButton("OK") { _, _ ->
                                    loadBackupList()
                                }
                                .show()
                        } else {
                            Toast.makeText(
                                this@BackupRestoreActivity,
                                "Greška pri kreiranju backup-a",
                                Toast.LENGTH_SHORT
                            ).show()
                        }
                    }
                }
            } catch (e: Exception) {
                runOnUiThread {
                    progressBar.visibility = ProgressBar.GONE
                    Toast.makeText(
                        this@BackupRestoreActivity,
                        "Greška: ${e.message}",
                        Toast.LENGTH_SHORT
                    ).show()
                }
            }
        }
    }

    private fun showRestoreOptions() {
        val backups = backupHelper.getAvailableBackups()

        if (backups.isEmpty()) {
            Toast.makeText(this, "Nema dostupnih backup fajlova", Toast.LENGTH_SHORT).show()
            return
        }

        val backupNames = backups.map { it.name }.toTypedArray()

        AlertDialog.Builder(this)
            .setTitle("Odaberite backup za restore")
            .setItems(backupNames) { _, which ->
                val selectedBackup = backups[which]
                confirmRestore(selectedBackup)
            }
            .setNegativeButton("Otkaži", null)
            .show()
    }

    private fun confirmRestore(backupFile: File) {
        AlertDialog.Builder(this)
            .setTitle("Potvrda restore-a")
            .setMessage("Da li želite da RESTORE-UJETE podatke iz backup-a?\n\n" +
                    "Fajl: ${backupFile.name}\n" +
                    "?? Ova akcija æe ZAMENITI postojeæe lokalne podatke!")
            .setPositiveButton("Restore") { _, _ ->
                performRestore(backupFile)  // OVO JE KLJUÈNO - DODAJTE OVO
            }
            .setNegativeButton("Otkaži", null)
            .show()
    }

    private fun performRestore(backupFile: File) {
        progressBar.visibility = ProgressBar.VISIBLE
        tvStatus.text = "?? Uèitavam backup podatke..."

        CoroutineScope(Dispatchers.IO).launch {
            try {
                // 1. Uèitaj proizvode iz backup fajla
                val backupProizvodi = backupHelper.restoreFromBackup(backupFile)

                if (backupProizvodi.isEmpty()) {
                    runOnUiThread {
                        progressBar.visibility = ProgressBar.GONE
                        Toast.makeText(
                            this@BackupRestoreActivity,
                            "Backup fajl je prazan ili nevažeæi",
                            Toast.LENGTH_SHORT
                        ).show()
                    }
                    return@launch
                }

                runOnUiThread {
                    tvStatus.text = "?? Restore u toku (${backupProizvodi.size} proizvoda)..."
                }

                // 2. Obriši sve postojeæe podatke
                repository.sviProizvodi { postojeciProizvodi ->
                    // Obriši sve postojeæe proizvode
                    var obrisano = 0
                    val ukupno = postojeciProizvodi.size

                    if (ukupno > 0) {
                        postojeciProizvodi.forEach { proizvod ->
                            repository.obrisiProizvod(proizvod) { success ->
                                obrisano++
                                Log.d("Restore", "Obrisan stari proizvod: $obrisano/$ukupno")

                                // Kada su svi obrisani, dodaj nove
                                if (obrisano == ukupno) {
                                    addNewProductsFromBackup(backupProizvodi)
                                }
                            }
                        }
                    } else {
                        // Nema postojeæih podataka, direktno dodaj
                        addNewProductsFromBackup(backupProizvodi)
                    }
                }

            } catch (e: Exception) {
                runOnUiThread {
                    progressBar.visibility = ProgressBar.GONE
                    Toast.makeText(
                        this@BackupRestoreActivity,
                        "Greška pri restore: ${e.message}",
                        Toast.LENGTH_SHORT
                    ).show()
                }
            }
        }
    }

    private fun addNewProductsFromBackup(backupProizvodi: List<Proizvod>) {
        var dodato = 0
        val ukupno = backupProizvodi.size

        backupProizvodi.forEach { proizvod ->
            // Resetuj ID na 0 da se generiše novi ID
            val proizvodZaDodavanje = proizvod.copy(id = 0)

            repository.dodajProizvod(proizvodZaDodavanje) { success, message ->
                dodato++
                Log.d("Restore", "Dodat proizvod iz backup-a: $dodato/$ukupno")

                // Kada su svi dodati
                if (dodato == ukupno) {
                    runOnUiThread {
                        progressBar.visibility = ProgressBar.GONE
                        tvStatus.text = "? Restore završen!"

                        AlertDialog.Builder(this@BackupRestoreActivity)
                            .setTitle("? Restore uspešan!")
                            .setMessage("Uspešno je restore-ovano $ukupno proizvoda iz backup-a.")
                            .setPositiveButton("OK") { _, _ ->
                                // Osveži listu backup fajlova
                                loadBackupList()

                                // Pošalji broadcast da se osveže MainActivity
                                val intent = Intent("PODACI_OSVEŽENI")
                                LocalBroadcastManager.getInstance(this@BackupRestoreActivity).sendBroadcast(intent)
                            }
                            .show()
                    }
                }
            }
        }
    }

    // Opciono: Kreiraj backup pre restore-a kao sigurnosnu kopiju
    private fun createSafetyBackupBeforeRestore(onComplete: () -> Unit) {
        repository.sviProizvodi { postojeciProizvodi ->
            if (postojeciProizvodi.isNotEmpty()) {
                val safetyBackup = backupHelper.createBackup(postojeciProizvodi)
                if (safetyBackup != null) {
                    Log.d("Restore", "Sigurnosni backup kreiran: ${safetyBackup.name}")
                }
            }
            onComplete()
        }
    }

    private fun exportToCSV() {
        progressBar.visibility = ProgressBar.VISIBLE
        tvStatus.text = "Export u CSV..."

        CoroutineScope(Dispatchers.IO).launch {
            try {
                repository.sviProizvodi { proizvodi ->
                    val csvFile = backupHelper.exportToCSV(proizvodi)

                    runOnUiThread {
                        progressBar.visibility = ProgressBar.GONE

                        if (csvFile != null) {
                            AlertDialog.Builder(this@BackupRestoreActivity)
                                .setTitle("? CSV Export uspešan")
                                .setMessage("Fajl je saèuvan u:\n${csvFile.absolutePath}")
                                .setPositiveButton("OK", null)
                                .show()
                        } else {
                            Toast.makeText(
                                this@BackupRestoreActivity,
                                "Greška pri exportu u CSV",
                                Toast.LENGTH_SHORT
                            ).show()
                        }
                    }
                }
            } catch (e: Exception) {
                runOnUiThread {
                    progressBar.visibility = ProgressBar.GONE
                    Toast.makeText(
                        this@BackupRestoreActivity,
                        "Greška: ${e.message}",
                        Toast.LENGTH_SHORT
                    ).show()
                }
            }
        }
    }

    private fun showBackupOptionsDialog(backupFile: File) {
        val options = arrayOf("Pregledaj", "Obriši", "Otkaži")

        AlertDialog.Builder(this)
            .setTitle("Opcije za: ${backupFile.name}")
            .setItems(options) { _, which ->
                when (which) {
                    0 -> previewBackup(backupFile) // Pregledaj
                    1 -> deleteBackup(backupFile) // Obriši
                    // 2 -> Otkaži
                }
            }
            .show()
    }

    private fun deleteBackup(backupFile: File) {
        AlertDialog.Builder(this)
            .setTitle("Brisanje backup-a")
            .setMessage("Da li ste sigurni da želite da obrišete ovaj backup?")
            .setPositiveButton("Obriši") { _, _ ->
                if (backupFile.delete()) {
                    Toast.makeText(this, "Backup obrisan", Toast.LENGTH_SHORT).show()
                    loadBackupList()
                }
            }
            .setNegativeButton("Otkaži", null)
            .show()
    }

    private fun previewBackup(backupFile: File) {
        CoroutineScope(Dispatchers.IO).launch {
            try {
                val proizvodi = backupHelper.restoreFromBackup(backupFile)

                withContext(Dispatchers.Main) {
                    val previewText = StringBuilder()
                    previewText.append("Backup: ${backupFile.name}\n")
                    previewText.append("Broj proizvoda: ${proizvodi.size}\n\n")

                    proizvodi.take(10).forEachIndexed { index, proizvod ->
                        previewText.append("${index + 1}. ${proizvod.naziv} (${proizvod.kolicina} kom)\n")
                    }

                    if (proizvodi.size > 10) {
                        previewText.append("\ni još ${proizvodi.size - 10} proizvoda...")
                    }

                    AlertDialog.Builder(this@BackupRestoreActivity)
                        .setTitle("Pregled backup-a")
                        .setMessage(previewText.toString())
                        .setPositiveButton("OK", null)
                        .show()
                }
            } catch (e: Exception) {
                withContext(Dispatchers.Main) {
                    Toast.makeText(
                        this@BackupRestoreActivity,
                        "Greška pri pregledu: ${e.message}",
                        Toast.LENGTH_SHORT
                    ).show()
                }
            }
        }
    }
    fun onBackClicked(view: android.view.View) {
        finish()
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\CloudSyncActivity.kt

package com.jovannedeljkovic.superstockgo

import android.content.Context
import android.content.Intent
import android.os.Bundle
import android.util.Log
import android.widget.Button
import android.widget.ProgressBar
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import kotlinx.coroutines.*
import kotlinx.coroutines.tasks.await
import android.os.Handler
import android.os.Looper
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken
import androidx.appcompat.app.AlertDialog
import androidx.localbroadcastmanager.content.LocalBroadcastManager

class CloudSyncActivity : AppCompatActivity() {

    private lateinit var btnBackup: Button
    private lateinit var btnRestore: Button
    private lateinit var progressBar: ProgressBar
    private lateinit var tvStatus: TextView
    private lateinit var btnSyncBothWays: Button

    private lateinit var repository: Repository
    private lateinit var firebaseHelper: FirebaseHelper

    private val coroutineScope = CoroutineScope(Dispatchers.Main + SupervisorJob())

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_cloud_sync)

        repository = Repository(this)
        firebaseHelper = FirebaseHelper(this)

        btnBackup = findViewById(R.id.btnBackup)
        btnRestore = findViewById(R.id.btnRestore)
        progressBar = findViewById(R.id.progressBar)
        tvStatus = findViewById(R.id.tvStatus)
        btnSyncBothWays = findViewById(R.id.btnSyncBothWays)

        btnBackup.setOnClickListener {
            Log.d("CloudSync", "Klik na Backup dugme")
            backupToCloud()
        }

        btnRestore.setOnClickListener {
            Log.d("CloudSync", "Klik na Restore dugme")
            restoreFromCloud()
        }

        btnSyncBothWays.setOnClickListener {
            Log.d("CloudSync", "Klik na Dvosmerna komunikacija dugme")
            simpleTwoWaySync()
        }

        // Proveri da li je korisnik ulogovan
        val currentUser = firebaseHelper.getCurrentUser()
        if (currentUser == null) {
            tvStatus.text = "? Niste prijavljeni"
            btnBackup.isEnabled = false
            btnRestore.isEnabled = false
            btnSyncBothWays.isEnabled = false
            Toast.makeText(this, "Morate biti prijavljeni za Cloud sinhronizaciju", Toast.LENGTH_LONG).show()
        } else {
            tvStatus.text = "? Prijavljen: ${currentUser.email}"
            checkSyncStatus()
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        coroutineScope.cancel()
    }

    private fun checkSyncStatus() {
        coroutineScope.launch {
            try {
                val lokalniProizvodi = withContext(Dispatchers.IO) {
                    getLocalProductsSuspended()
                }
                val localCount = lokalniProizvodi.size

                delay(1000)

                val cloudProizvodi = withContext(Dispatchers.IO) {
                    getCloudProductsSuspended()
                }
                val cloudCount = cloudProizvodi.size

                tvStatus.text = "?? Stanje: Lokalno: $localCount | Cloud: $cloudCount"

                if (localCount == 0 && cloudCount > 0) {
                    Toast.makeText(this@CloudSyncActivity,
                        "Imate podatke u Cloud-u, možete ih restore-ovati",
                        Toast.LENGTH_SHORT).show()
                } else if (localCount > 0 && cloudCount == 0) {
                    Toast.makeText(this@CloudSyncActivity,
                        "Imate lokalne podatke, možete ih backup-ovati",
                        Toast.LENGTH_SHORT).show()
                } else if (localCount != cloudCount) {
                    Toast.makeText(this@CloudSyncActivity,
                        "Podaci nisu sinhronizovani. Preporuèujemo dvosmernu sinhronizaciju.",
                        Toast.LENGTH_LONG).show()
                }
            } catch (e: Exception) {
                Log.e("CloudSync", "Greška pri proveri stanja: ${e.message}")
                tvStatus.text = "? Greška pri proveri stanja"
            }
        }
    }

    private suspend fun getCloudProductsSuspended(): List<Proizvod> {
        return try {
            firebaseHelper.restoreFromCloud()
        } catch (e: Exception) {
            Log.e("CloudSync", "Greška pri uèitavanju cloud podataka: ${e.message}")
            emptyList()
        }
    }

    private fun backupToCloud() {
        Log.d("CloudSync", "=== POÈINJE BACKUP ===")

        progressBar.visibility = ProgressBar.VISIBLE
        tvStatus.text = "?? Uèitavam lokalne podatke..."
        btnBackup.isEnabled = false

        repository.sviProizvodi { lokalniProizvodi ->
            Log.d("CloudSync", "Dobio ${lokalniProizvodi.size} lokalnih proizvoda")

            if (lokalniProizvodi.isEmpty()) {
                runOnUiThread {
                    progressBar.visibility = ProgressBar.GONE
                    btnBackup.isEnabled = true
                    tvStatus.text = "? Nema podataka za backup"
                    Toast.makeText(this,
                        "Nema podataka za èuvanje. Dodajte prvo neke proizvode.",
                        Toast.LENGTH_SHORT).show()
                }
                return@sviProizvodi
            }

            tvStatus.text = "?? Šaljem u Cloud (${lokalniProizvodi.size} proizvoda)..."

            firebaseHelper.backupToCloudSimple(lokalniProizvodi) { success, message ->
                runOnUiThread {
                    progressBar.visibility = ProgressBar.GONE
                    btnBackup.isEnabled = true

                    if (success) {
                        tvStatus.text = "? Backup uspešan!"
                        Toast.makeText(this@CloudSyncActivity,
                            "? $message",
                            Toast.LENGTH_LONG).show()
                    } else {
                        tvStatus.text = "? Backup nije uspeo"
                        Toast.makeText(this@CloudSyncActivity,
                            "? $message",
                            Toast.LENGTH_LONG).show()
                    }
                }
            }
        }
    }

    private fun restoreFromCloud() {
        Log.d("CloudSync", "=== POÈINJE SMART RESTORE ===")

        progressBar.visibility = ProgressBar.VISIBLE
        tvStatus.text = "?? Uèitavam iz Cloud-a..."
        btnRestore.isEnabled = false

        firebaseHelper.restoreFromCloudSimple { cloudProizvodi ->
            // Takoðe uèitaj kategorije iz Cloud-a
            restoreCategoriesFromCloud { cloudCategories ->
                runOnUiThread {
                    if (cloudProizvodi.isEmpty() && cloudCategories.isEmpty()) {
                        progressBar.visibility = ProgressBar.GONE
                        btnRestore.isEnabled = true
                        tvStatus.text = "?? Nema podataka u Cloud-u"
                        Toast.makeText(this@CloudSyncActivity,
                            "Nema podataka u Cloud-u za restore.",
                            Toast.LENGTH_SHORT).show()
                        return@runOnUiThread
                    }

                    tvStatus.text = "?? Uporeðujem sa lokalnim podacima..."

                    repository.sviProizvodi { lokalniProizvodi ->
                        // Uèitaj lokalne kategorije
                        val lokalneKategorije = getLocalCategories()

                        coroutineScope.launch {
                            // 1. Prvo sinhronizuj kategorije
                            processCategoryRestore(lokalneKategorije, cloudCategories)

                            // 2. Onda sinhronizuj proizvode
                            processRestore(lokalniProizvodi, cloudProizvodi)
                        }
                    }
                }
            }
        }
    }

    private fun restoreCategoriesFromCloud(onComplete: (List<Kategorija>) -> Unit) {
        coroutineScope.launch {
            try {
                val currentUser = firebaseHelper.getCurrentUser()
                val userId = currentUser?.uid ?: return@launch onComplete(emptyList())

                val categories = withContext(Dispatchers.IO) {
                    val categoriesRef = firebaseHelper.getDatabaseReference()
                        .child("categories")
                        .child(userId)

                    try {
                        val snapshot = categoriesRef.get().await()
                        val kategorije = mutableListOf<Kategorija>()

                        snapshot.children.forEach { child ->
                            val emoji = child.child("emoji").getValue(String::class.java) ?: ""
                            val name = child.child("name").getValue(String::class.java) ?: ""
                            val color = child.child("color").getValue(Int::class.java) ?: android.R.color.holo_blue_light

                            if (name.isNotEmpty() && emoji.isNotEmpty()) {
                                kategorije.add(Kategorija(emoji, name, color))
                            }
                        }

                        kategorije
                    } catch (e: Exception) {
                        Log.e("CloudSync", "Greška pri uèitavanju kategorija: ${e.message}")
                        emptyList()
                    }
                }

                withContext(Dispatchers.Main) {
                    onComplete(categories)
                    Log.d("CloudSync", "? Uèitano ${categories.size} kategorija iz Cloud-a")
                }
            } catch (e: Exception) {
                Log.e("CloudSync", "Greška pri uèitavanju kategorija: ${e.message}")
                withContext(Dispatchers.Main) {
                    onComplete(emptyList())
                }
            }
        }
    }

    private suspend fun processCategoryRestore(
        lokalneKategorije: List<Kategorija>,
        cloudCategories: List<Kategorija>
    ) {
        try {
            // Dodaj kategorije koje postoje u Cloud-u, a ne postoje lokalno
            cloudCategories.forEach { cloudCategory ->
                val postoji = lokalneKategorije.any {
                    it.naziv == cloudCategory.naziv ||
                            it.ikona == cloudCategory.ikona
                }

                if (!postoji) {
                    // Dodaj u lokalnu bazu
                    addCategoryToLocalStorage(cloudCategory)
                }
            }

            Log.d("CloudSync", "? Kategorije sinhronizovane")
        } catch (e: Exception) {
            Log.e("CloudSync", "? Greška pri sinhronizaciji kategorija: ${e.message}")
        }
    }

    private fun addCategoryToLocalStorage(kategorija: Kategorija) {
        try {
            val currentUser = FirebaseHelper(this).getCurrentUser()
            val userId = currentUser?.uid ?: "offline_user"

            val sharedPref = getSharedPreferences("categories_$userId", Context.MODE_PRIVATE)
            val categoriesJson = sharedPref.getString("custom_categories", "[]")

            val type = object : TypeToken<MutableList<Kategorija>>() {}.type
            val categories = Gson().fromJson<MutableList<Kategorija>>(categoriesJson, type) ?: mutableListOf()

            categories.add(kategorija)

            val updatedJson = Gson().toJson(categories)
            sharedPref.edit().putString("custom_categories", updatedJson).apply()

            Log.d("CloudSync", "? Dodata kategorija: ${kategorija.naziv}")
        } catch (e: Exception) {
            Log.e("CloudSync", "? Greška pri dodavanju kategorije: ${e.message}")
        }
    }

    private suspend fun processRestore(lokalniProizvodi: List<Proizvod>, cloudProizvodi: List<Proizvod>) {
        try {
            Log.d("CloudSync", "=== PROCES RESTORE - POÈINJE ===")

            // Ukloni duplikate iz cloud podataka
            val jedinstveniCloudMap = mutableMapOf<String, Proizvod>()
            cloudProizvodi.forEach { proizvod ->
                val key = proizvod.getUniqueKey()
                if (!jedinstveniCloudMap.containsKey(key)) {
                    jedinstveniCloudMap[key] = proizvod
                }
            }

            val jedinstveniCloudProizvodi = jedinstveniCloudMap.values.toList()

            // Proveri šta treba dodati/ažurirati
            val toAdd = mutableListOf<Proizvod>()
            val toUpdate = mutableListOf<Proizvod>()

            for (cloudProizvod in jedinstveniCloudProizvodi) {
                val cloudKey = cloudProizvod.getUniqueKey()
                val lokalni = lokalniProizvodi.find { it.getUniqueKey() == cloudKey }

                if (lokalni == null) {
                    toAdd.add(cloudProizvod)
                } else {
                    val trebaAzurirati = lokalni.naziv != cloudProizvod.naziv ||
                            lokalni.kategorija != cloudProizvod.kategorija ||
                            lokalni.kolicina != cloudProizvod.kolicina

                    if (trebaAzurirati) {
                        val azuriranProizvod = cloudProizvod.copy(id = lokalni.id)
                        toUpdate.add(azuriranProizvod)
                    }
                }
            }

            if (toAdd.isEmpty() && toUpdate.isEmpty()) {
                withContext(Dispatchers.Main) {
                    progressBar.visibility = ProgressBar.GONE
                    btnRestore.isEnabled = true
                    tvStatus.text = "? Podaci su veæ sinhronizovani"
                    Toast.makeText(this@CloudSyncActivity,
                        "? Podaci su veæ sinhronizovani. Nema promena.",
                        Toast.LENGTH_SHORT).show()
                }
                return
            }

            // Izvrši dodavanje i ažuriranje
            var uspesnoDodato = 0
            var uspesnoAzurirano = 0
            var greske = 0

            for (proizvod in toAdd) {
                try {
                    val deferred = CompletableDeferred<Boolean>()
                    repository.dodajProizvod(proizvod) { success, _ ->
                        deferred.complete(success)
                    }
                    val success = deferred.await()
                    if (success) {
                        uspesnoDodato++
                    } else {
                        greske++
                    }
                    delay(100)
                } catch (e: Exception) {
                    greske++
                }
            }

            for (proizvod in toUpdate) {
                try {
                    val deferred = CompletableDeferred<Boolean>()
                    repository.azurirajProizvod(proizvod) { success ->
                        deferred.complete(success)
                    }
                    val success = deferred.await()
                    if (success) {
                        uspesnoAzurirano++
                    } else {
                        greske++
                    }
                    delay(100)
                } catch (e: Exception) {
                    greske++
                }
            }

            delay(1000)

            withContext(Dispatchers.Main) {
                progressBar.visibility = ProgressBar.GONE
                btnRestore.isEnabled = true

                val poruka = StringBuilder()
                poruka.append("? Restore završen!\n")
                if (uspesnoDodato > 0) poruka.append("Dodato: $uspesnoDodato\n")
                if (uspesnoAzurirano > 0) poruka.append("Ažurirano: $uspesnoAzurirano\n")
                if (greske > 0) poruka.append("Grešaka: $greske\n")

                tvStatus.text = "? Restore završen"
                Toast.makeText(this@CloudSyncActivity,
                    poruka.toString(),
                    Toast.LENGTH_LONG).show()

                val intent = Intent("PODACI_OSVEŽENI")
                LocalBroadcastManager.getInstance(this@CloudSyncActivity).sendBroadcast(intent)

                Handler(Looper.getMainLooper()).postDelayed({
                    checkSyncStatus()
                }, 2000)
            }

        } catch (e: Exception) {
            Log.e("CloudSync", "? GREŠKA U PROCESU RESTORE: ${e.message}")
            withContext(Dispatchers.Main) {
                progressBar.visibility = ProgressBar.GONE
                btnRestore.isEnabled = true
                tvStatus.text = "? Greška pri restore-u"
                Toast.makeText(this@CloudSyncActivity,
                    "Greška: ${e.message}",
                    Toast.LENGTH_LONG).show()
            }
        }
    }

    // ========== KLJUÈNA METODA: DVOSMERNA KOMUNIKACIJA ==========
    // OVO JE KOJE KORISNIK KLIKNE KADA ŽELI DA SINHRONIZUJE
    private fun simpleTwoWaySync() {
        Log.d("CloudSync", "=== POÈINJE DVOSMERNA SINHRONIZACIJA ===")

        progressBar.visibility = ProgressBar.VISIBLE
        tvStatus.text = "?? Dvosmerna sinhronizacija..."
        btnSyncBothWays.isEnabled = false

        coroutineScope.launch {
            try {
                // 1. Uzmi lokalne podatke
                tvStatus.text = "?? Uèitavam lokalne podatke..."
                val lokalniProizvodi = withContext(Dispatchers.IO) {
                    getLocalProductsSuspended()
                }

                // 2. Uzmi lokalne kategorije
                val lokalneKategorije = getLocalCategories()

                if (lokalniProizvodi.isEmpty() && lokalneKategorije.isEmpty()) {
                    withContext(Dispatchers.Main) {
                        progressBar.visibility = ProgressBar.GONE
                        btnSyncBothWays.isEnabled = true
                        tvStatus.text = "?? Nema lokalnih podataka"
                        Toast.makeText(this@CloudSyncActivity,
                            "Nema lokalnih podataka za sinhronizaciju.",
                            Toast.LENGTH_SHORT).show()
                    }
                    return@launch
                }

                // 3. Proveri da li je korisnik prijavljen
                val currentUser = firebaseHelper.getCurrentUser()
                if (currentUser == null) {
                    withContext(Dispatchers.Main) {
                        progressBar.visibility = ProgressBar.GONE
                        btnSyncBothWays.isEnabled = true
                        tvStatus.text = "?? Niste prijavljeni"
                        Toast.makeText(this@CloudSyncActivity,
                            "Niste prijavljeni. Ne možete sinhronizovati sa Cloud-om.",
                            Toast.LENGTH_LONG).show()
                    }
                    return@launch
                }

                // 4. Obriši sve iz Cloud-a
                tvStatus.text = "?? Brišem stare podatke iz Cloud-a..."
                val userId = currentUser.uid

                try {
                    val userInventoryRef = firebaseHelper.getDatabaseReference()
                        .child("inventory")
                        .child(userId)
                    userInventoryRef.removeValue().await()

                    val userCategoriesRef = firebaseHelper.getDatabaseReference()
                        .child("categories")
                        .child(userId)
                    userCategoriesRef.removeValue().await()

                    Log.d("CloudSync", "? Stari cloud podaci obrisani")
                    delay(1000)
                } catch (e: Exception) {
                    Log.e("CloudSync", "?? Nije uspelo brisanje starih podataka: ${e.message}")
                }

                // 5. Pošalji LOKALNE PROIZVODE u CLOUD
                tvStatus.text = "?? Šaljem ${lokalniProizvodi.size} proizvoda u Cloud..."
                val backupSuccess = try {
                    firebaseHelper.backupToCloud(lokalniProizvodi)
                } catch (e: Exception) {
                    Log.e("CloudSync", "? Greška pri backup-u: ${e.message}")
                    false
                }

                // 6. Pošalji LOKALNE KATEGORIJE u CLOUD (koristeæi suspend funkciju)
                if (lokalneKategorije.isNotEmpty()) {
                    tvStatus.text = "?? Šaljem ${lokalneKategorije.size} kategorija u Cloud..."
                    val categoriesSuccess = withContext(Dispatchers.IO) {
                        backupCategoriesToCloud(lokalneKategorije)
                    }
                    Log.d("CloudSync", "Kategorije backup: ${if (categoriesSuccess) "?" else "?"}")
                }

                delay(3000)

                // 7. Proveri rezultat
                withContext(Dispatchers.Main) {
                    progressBar.visibility = ProgressBar.GONE
                    btnSyncBothWays.isEnabled = true

                    if (backupSuccess) {
                        tvStatus.text = "? Sinhronizacija uspešna!"
                        Toast.makeText(this@CloudSyncActivity,
                            "? Sinhronizovano ${lokalniProizvodi.size} proizvoda u Cloud" +
                                    if (lokalneKategorije.isNotEmpty()) " i ${lokalneKategorije.size} kategorija" else "",
                            Toast.LENGTH_LONG).show()

                        val intent = Intent("PODACI_OSVEŽENI")
                        LocalBroadcastManager.getInstance(this@CloudSyncActivity).sendBroadcast(intent)

                        Handler(Looper.getMainLooper()).postDelayed({
                            checkSyncStatus()
                        }, 2000)
                    } else {
                        tvStatus.text = "? Greška pri sinhronizaciji"
                        Toast.makeText(this@CloudSyncActivity,
                            "Greška pri slanju podataka u Cloud",
                            Toast.LENGTH_LONG).show()
                    }
                }

            } catch (e: Exception) {
                Log.e("CloudSync", "? Greška u simpleTwoWaySync: ${e.message}")
                withContext(Dispatchers.Main) {
                    progressBar.visibility = ProgressBar.GONE
                    btnSyncBothWays.isEnabled = true
                    tvStatus.text = "? Greška pri sinhronizaciji"
                    Toast.makeText(this@CloudSyncActivity,
                        "Greška: ${e.message}",
                        Toast.LENGTH_LONG).show()
                }
            }
        }
    }
    private suspend fun backupCategoriesToCloud(categories: List<Kategorija>): Boolean {
        return withContext(Dispatchers.IO) {
            try {
                val currentUser = firebaseHelper.getCurrentUser()
                val userId = currentUser?.uid ?: return@withContext false

                val categoriesRef = firebaseHelper.getDatabaseReference()
                    .child("categories")
                    .child(userId)

                // Konvertuj kategorije u mapu
                val categoriesMap = mutableMapOf<String, Any>()
                categories.forEachIndexed { index, kategorija ->
                    categoriesMap["category_$index"] = mapOf(
                        "emoji" to kategorija.ikona,
                        "name" to kategorija.naziv,
                        "color" to kategorija.boja
                    )
                }

                categoriesRef.setValue(categoriesMap).await()
                Log.d("CloudSync", "? Kategorije saèuvane u Cloud: ${categories.size}")
                true
            } catch (e: Exception) {
                Log.e("CloudSync", "? Greška pri èuvanju kategorija: ${e.message}")
                false
            }
        }
    }

    // Dodajte ovu metodu da dobijete lokalne kategorije
    private fun getLocalCategories(): List<Kategorija> {
        return try {
            val currentUser = FirebaseHelper(this).getCurrentUser()
            val userId = currentUser?.uid ?: "offline_user"

            val sharedPref = getSharedPreferences("categories_$userId", Context.MODE_PRIVATE)
            val categoriesJson = sharedPref.getString("custom_categories", "[]")

            val type = object : TypeToken<MutableList<Kategorija>>() {}.type
            Gson().fromJson<MutableList<Kategorija>>(categoriesJson, type) ?: emptyList()
        } catch (e: Exception) {
            Log.e("CloudSync", "Greška pri uèitavanju lokalnih kategorija: ${e.message}")
            emptyList()
        }
    }

    private suspend fun getLocalProductsSuspended(): List<Proizvod> {
        return try {
            repository.getProizvodiSuspended()
        } catch (e: Exception) {
            Log.e("CloudSync", "Greška pri uèitavanju lokalnih proizvoda: ${e.message}")
            emptyList()
        }
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\Constants.kt

// Constants.kt
package com.jovannedeljkovic.superstockgo

object Constants {

    // OSNOVNE KATEGORIJE - LAKO PROMENITI NA JEDNOM MESTU
    object Kategorije {
        const val HRANA = "Hrana"
        const val PICE = "Piæe"
        const val OPREMA = "Oprema"
        const val ODECA = "Odeæa"
        const val HIGIJENA = "Higijena"
        const val TEHNIKA = "Tehnika"
        const val SVE_STAVKE = "Sve stavke"
        const val NISKA_ZALIHA = "Niska zaliha"
        const val DODAJ_PROIZVOD = "Dodaj proizvod"

        object SyncSettings {
            var AUTO_SYNC_ENABLED = false  // Postavite na false da onemoguæite automatsku sinhronizaciju
        }
        // Lista svih osnovnih kategorija
        val OSNOVNE = listOf(HRANA, PICE, OPREMA, ODECA, HIGIJENA, TEHNIKA)
        val SVE = listOf(HRANA, PICE, OPREMA, ODECA, HIGIJENA, TEHNIKA,
            SVE_STAVKE, NISKA_ZALIHA, DODAJ_PROIZVOD)

        // Mapiranje kategorija na Unicode emoji
        val EMOJI_MAP = mapOf(
            HRANA to "??",       // ??
            PICE to "??",        // ??
            OPREMA to "??",      // ??
            ODECA to "??",       // ??
            HIGIJENA to "??",    // ??
            TEHNIKA to "??",     // ??
            SVE_STAVKE to "??",  // ??
            NISKA_ZALIHA to "??", // ??
            DODAJ_PROIZVOD to "?" // ?
        )

        // Mapiranje kategorija na boje
        val BOJA_MAP = mapOf(
            HRANA to android.R.color.holo_green_light,
            PICE to android.R.color.holo_blue_light,
            OPREMA to android.R.color.holo_orange_light,
            ODECA to android.R.color.holo_purple,
            HIGIJENA to android.R.color.holo_blue_dark,
            TEHNIKA to android.R.color.holo_red_light,
            SVE_STAVKE to android.R.color.darker_gray,
            NISKA_ZALIHA to android.R.color.holo_red_dark,
            DODAJ_PROIZVOD to android.R.color.holo_green_dark
        )
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\DBHelper.kt

package com.jovannedeljkovic.superstockgo

import android.content.ContentValues
import android.content.Context
import android.database.sqlite.SQLiteDatabase
import android.database.sqlite.SQLiteOpenHelper
import android.util.Log

class DBHelper(context: Context) : SQLiteOpenHelper(context, DATABASE_NAME, null, DATABASE_VERSION) {

    companion object {
        private const val DATABASE_NAME = "superstock.db"
        private const val DATABASE_VERSION = 2  // POVIŠENA VERZIJA ZBOG MIGRACIJE
        private const val TABLE_NAME = "inventar"
        private const val COLUMN_ID = "id"
        private const val COLUMN_USER_ID = "user_id"  // NOVA KOLONA ZA IZOLACIJU
        private const val COLUMN_NAZIV = "naziv"
        private const val COLUMN_KATEGORIJA = "kategorija"
        private const val COLUMN_KOLICINA = "kolicina"
    }

    override fun onCreate(db: SQLiteDatabase) {
        val createTable = """
            CREATE TABLE $TABLE_NAME (
                $COLUMN_ID INTEGER PRIMARY KEY AUTOINCREMENT,
                $COLUMN_USER_ID TEXT NOT NULL,
                $COLUMN_NAZIV TEXT NOT NULL,
                $COLUMN_KATEGORIJA TEXT NOT NULL,
                $COLUMN_KOLICINA INTEGER DEFAULT 0
            )
        """.trimIndent()
        db.execSQL(createTable)
        Log.d("DBHelper", "Tabela $TABLE_NAME kreirana sa user_id kolonom")
    }

    override fun onUpgrade(db: SQLiteDatabase, oldVersion: Int, newVersion: Int) {
        if (oldVersion < 2) {
            // MIGRACIJA: dodaj user_id kolonu za stare podatke
            db.execSQL("ALTER TABLE $TABLE_NAME ADD COLUMN $COLUMN_USER_ID TEXT DEFAULT 'unknown'")
            Log.d("DBHelper", "Migracija: dodata user_id kolona u tabelu")
        }
    }

    // === CRUD METODE SA USER_ID ===

    fun dodajProizvod(proizvod: Proizvod, userId: String): Long {
        val db = writableDatabase
        val values = ContentValues().apply {
            put(COLUMN_USER_ID, userId)
            put(COLUMN_NAZIV, proizvod.naziv)
            put(COLUMN_KATEGORIJA, proizvod.kategorija)
            put(COLUMN_KOLICINA, proizvod.kolicina)
        }
        val id = db.insert(TABLE_NAME, null, values)
        Log.d("DBHelper", "Dodat proizvod za user $userId: ${proizvod.naziv}, ID: $id")
        return id
    }

    fun sviProizvodi(userId: String): List<Proizvod> {
        val proizvodi = mutableListOf<Proizvod>()
        val db = readableDatabase

        // SAMO PROIZVODI ZA ODOGOVARAJUÆEG KORISNIKA
        val cursor = db.rawQuery(
            "SELECT * FROM $TABLE_NAME WHERE $COLUMN_USER_ID = ? ORDER BY $COLUMN_NAZIV ASC",
            arrayOf(userId)
        )

        Log.d("DBHelper", "Uèitavam proizvode za user: $userId")

        with(cursor) {
            while (moveToNext()) {
                val id = getInt(getColumnIndexOrThrow(COLUMN_ID))
                val naziv = getString(getColumnIndexOrThrow(COLUMN_NAZIV))
                val kategorija = getString(getColumnIndexOrThrow(COLUMN_KATEGORIJA))
                val kolicina = getInt(getColumnIndexOrThrow(COLUMN_KOLICINA))

                Log.d("DBHelper", "Proèitano: ID=$id, Naziv='$naziv', Kategorija='$kategorija', Kolièina=$kolicina")

                proizvodi.add(Proizvod(id, naziv, kategorija, kolicina))
            }
            close()
        }

        Log.d("DBHelper", "Ukupno proèitano proizvoda za user $userId: ${proizvodi.size}")
        return proizvodi
    }

    fun azurirajProizvod(proizvod: Proizvod, userId: String): Int {
        val db = writableDatabase
        val values = ContentValues().apply {
            put(COLUMN_NAZIV, proizvod.naziv)
            put(COLUMN_KATEGORIJA, proizvod.kategorija)
            put(COLUMN_KOLICINA, proizvod.kolicina)
        }

        // SAMO PROIZVODI KOJI PRIpadaju OVOM KORISNIKU
        val result = db.update(
            TABLE_NAME,
            values,
            "$COLUMN_ID = ? AND $COLUMN_USER_ID = ?",
            arrayOf(proizvod.id.toString(), userId)
        )
        Log.d("DBHelper", "Ažuriran proizvod ID=${proizvod.id} za user $userId, promena: $result")
        return result
    }

    fun obrisiProizvod(id: Int, userId: String): Int {
        val db = writableDatabase

        // SAMO PROIZVODI KOJI PRIpadaju OVOM KORISNIKU
        val result = db.delete(
            TABLE_NAME,
            "$COLUMN_ID = ? AND $COLUMN_USER_ID = ?",
            arrayOf(id.toString(), userId)
        )
        Log.d("DBHelper", "Obrisan proizvod ID=$id za user $userId, rezultat: $result")
        return result
    }

    fun pronadjiProizvod(id: Int, userId: String): Proizvod? {
        val db = readableDatabase
        val cursor = db.query(
            TABLE_NAME,
            null,
            "$COLUMN_ID = ? AND $COLUMN_USER_ID = ?",
            arrayOf(id.toString(), userId),
            null, null, null
        )

        var proizvod: Proizvod? = null
        cursor.use {
            if (it.moveToFirst()) {
                proizvod = Proizvod(
                    id = it.getInt(it.getColumnIndexOrThrow(COLUMN_ID)),
                    naziv = it.getString(it.getColumnIndexOrThrow(COLUMN_NAZIV)),
                    kategorija = it.getString(it.getColumnIndexOrThrow(COLUMN_KATEGORIJA)),
                    kolicina = it.getInt(it.getColumnIndexOrThrow(COLUMN_KOLICINA))
                )
            }
        }
        return proizvod
    }

    // === MIGRACIJA STARIH PODATAKA ===

    fun migrirajStarePodatke(userId: String) {
        val db = writableDatabase
        try {
            // Proveri da li ima podataka bez user_id ili sa starim user_id
            val cursor = db.rawQuery(
                "SELECT COUNT(*) FROM $TABLE_NAME WHERE $COLUMN_USER_ID = 'unknown' OR $COLUMN_USER_ID = '' OR $COLUMN_USER_ID IS NULL",
                null
            )

            cursor.use {
                if (it.moveToFirst() && it.getInt(0) > 0) {
                    // Ažuriraj stare podatke sa novim user_id
                    val values = ContentValues().apply {
                        put(COLUMN_USER_ID, userId)
                    }
                    val updated = db.update(
                        TABLE_NAME,
                        values,
                        "$COLUMN_USER_ID = 'unknown' OR $COLUMN_USER_ID = '' OR $COLUMN_USER_ID IS NULL",
                        null
                    )
                    Log.d("DBHelper", "Migrirano $updated podataka za user: $userId")
                } else {
                    Log.d("DBHelper", "Nema podataka za migraciju za user: $userId")
                }
            }
        } catch (e: Exception) {
            Log.e("DBHelper", "Greška pri migraciji: ${e.message}")
        }
    }

    // === PROVERA TABELE (ZA DEBUG) ===

    fun proveriTabelu(): Boolean {
        val db = readableDatabase
        val cursor = db.rawQuery(
            "SELECT name FROM sqlite_master WHERE type='table' AND name='$TABLE_NAME'",
            null
        )
        val exists = cursor.count > 0
        cursor.close()
        Log.d("DBHelper", "Tabela $TABLE_NAME postoji: $exists")
        return exists
    }

    fun brojProizvodaPoKorisniku(userId: String): Int {
        val db = readableDatabase
        val cursor = db.rawQuery(
            "SELECT COUNT(*) FROM $TABLE_NAME WHERE $COLUMN_USER_ID = ?",
            arrayOf(userId)
        )
        cursor.use {
            return if (it.moveToFirst()) {
                it.getInt(0)
            } else {
                0
            }
        }
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\DodajIzmeniActivity.kt

package com.jovannedeljkovic.superstockgo

import android.app.ProgressDialog
import androidx.appcompat.app.AlertDialog
import android.Manifest
import android.app.NotificationChannel
import android.app.NotificationManager
import android.app.PendingIntent
import android.content.Intent
import android.content.pm.PackageManager
import android.os.Build
import android.os.Bundle
import android.telephony.SmsManager
import android.util.Log
import android.widget.ArrayAdapter
import android.widget.Button
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.app.ActivityCompat
import androidx.core.app.NotificationCompat
import androidx.core.app.NotificationManagerCompat
import androidx.core.content.ContextCompat
import com.google.android.material.textfield.TextInputEditText
import com.google.android.material.textfield.MaterialAutoCompleteTextView
import java.text.SimpleDateFormat
import java.util.*
import androidx.localbroadcastmanager.content.LocalBroadcastManager
import android.app.Activity


class DodajIzmeniActivity : AppCompatActivity() {

    private lateinit var etNaziv: TextInputEditText
    private lateinit var autoCompleteKategorija: MaterialAutoCompleteTextView
    private lateinit var etKolicina: TextInputEditText
    private lateinit var btnSacuvaj: Button

    // KORISTI REPOSITORY UMESTO DBHelper
    private lateinit var repository: Repository
    private var proizvodId: Int = 0
    private var kategorijaIzMain: String = ""

    companion object {
        private const val SMS_PERMISSION_CODE = 100
        private const val NOTIFICATION_CHANNEL_ID = "low_stock_channel"
        private const val SMS_PHONE_NUMBER = "+381646361287"
    }

    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray
    ) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)

        if (requestCode == SMS_PERMISSION_CODE) {
            if (grantResults.isNotEmpty() && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                Toast.makeText(this, "SMS dozvola odobrena", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "SMS dozvola odbijena", Toast.LENGTH_SHORT).show()
            }
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_dodaj_izmeni)

        // INICIJALIZUJ REPOSITORY UMESTO DBHelper
        repository = Repository(this)

        etNaziv = findViewById(R.id.etNaziv)
        autoCompleteKategorija = findViewById(R.id.autoCompleteKategorija)
        etKolicina = findViewById(R.id.etKolicina)
        btnSacuvaj = findViewById(R.id.btnSacuvaj)

        val kategorijeAdapter = ArrayAdapter(this,
            android.R.layout.simple_dropdown_item_1line, kategorije)
        autoCompleteKategorija.setAdapter(kategorijeAdapter)

        proizvodId = intent.getIntExtra("PROIZVOD_ID", 0)
        kategorijaIzMain = intent.getStringExtra("KATEGORIJA") ?: ""

        if (proizvodId > 0) {
            ucitajProizvod(proizvodId)
        } else if (kategorijaIzMain.isNotEmpty()) {
            autoCompleteKategorija.setText(kategorijaIzMain)
            autoCompleteKategorija.isEnabled = false
        }

        btnSacuvaj.setOnClickListener {
            sacuvajProizvod()
        }

        proveriSMSDozvolu()
    }

    private fun proveriSMSDozvolu() {
        if (ContextCompat.checkSelfPermission(
                this,
                Manifest.permission.SEND_SMS
            ) != PackageManager.PERMISSION_GRANTED
        ) {
            ActivityCompat.requestPermissions(
                this,
                arrayOf(Manifest.permission.SEND_SMS),
                SMS_PERMISSION_CODE
            )
        }
    }

    // U DodajIzmeniActivity.kt, POPRAVI metodu ucitajProizvod:

    // U DodajIzmeniActivity.kt, zamenite ucitajProizvod metodu:
    private fun ucitajProizvod(id: Int) {
        repository.pronadjiProizvod(id) { proizvod ->
            runOnUiThread {
                if (proizvod != null) {
                    etNaziv.setText(proizvod.naziv)
                    autoCompleteKategorija.setText(proizvod.kategorija)
                    etKolicina.setText(proizvod.kolicina.toString())
                } else {
                    Toast.makeText(this, "Proizvod nije prona en", Toast.LENGTH_SHORT).show()
                }
            }
        }
    }
    private fun sacuvajProizvod() {
        val naziv = etNaziv.text.toString().trim()
        val kategorija = if (!autoCompleteKategorija.isEnabled) {
            kategorijaIzMain
        } else {
            autoCompleteKategorija.text.toString().trim()
        }
        val kolicinaStr = etKolicina.text.toString().trim()

        // VALIDACIJA
        if (naziv.isEmpty()) {
            etNaziv.error = "Unesite naziv proizvoda"
            etNaziv.requestFocus()
            return
        }

        if (kategorija.isEmpty()) {
            autoCompleteKategorija.error = "Izaberite kategoriju"
            autoCompleteKategorija.requestFocus()
            return
        }

        if (kolicinaStr.isEmpty()) {
            etKolicina.error = "Unesite kolièinu"
            etKolicina.requestFocus()
            return
        }

        val kolicina = try {
            kolicinaStr.toInt()
        } catch (e: NumberFormatException) {
            etKolicina.error = "Kolièina mora biti broj"
            etKolicina.requestFocus()
            return
        }

        if (kolicina < 0) {
            etKolicina.error = "Kolièina ne može biti negativna"
            etKolicina.requestFocus()
            return
        }

        // KREIRAJ PROIZVOD
        val proizvod = Proizvod(
            id = if (proizvodId > 0) proizvodId else 0,
            naziv = naziv,
            kategorija = kategorija,
            kolicina = kolicina
        )

        Log.d("DodajIzmeni", "?? Èuvanje proizvoda: $naziv, Kat: $kategorija, Kol: $kolicina, ID: ${proizvod.id}")

        // KREIRAJ I PRIKAŽI PROGRESS DIALOG
        val progressDialog = ProgressDialog(this)
        progressDialog.setTitle("Èuvanje...")
        progressDialog.setMessage("Saèuvavam proizvod '$naziv'")
        progressDialog.setCancelable(false)
        progressDialog.show()

        // ONEMOGUÆI DUGME DA SE NE KLIKNE VIŠE PUTA
        btnSacuvaj.isEnabled = false

        if (proizvodId > 0) {
            // AŽURIRANJE POSTOJEÆEG PROIZVODA
            Log.d("DodajIzmeni", "?? Ažuriranje postojeæeg proizvoda ID=$proizvodId")

            repository.azurirajProizvod(proizvod) { success ->
                progressDialog.dismiss()
                runOnUiThread {
                    btnSacuvaj.isEnabled = true

                    if (success) {
                        Log.d("DodajIzmeni", "? Proizvod '$naziv' ažuriran")
                        Toast.makeText(this, "? Proizvod '$naziv' ažuriran", Toast.LENGTH_SHORT).show()

                        // SMS i notifikacija ako je kolièina 0
                        if (kolicina <= 0) {
                            Log.d("DodajIzmeni", "?? Kolièina 0 - šaljem SMS")
                            posaljiSMSObavestenje(naziv, kategorija, kolicina)
                            pokusajLokalnuNotifikaciju(naziv, kategorija, kolicina)
                        }

                        // POSTAVI REZULTAT ZA MAIN ACTIVITY
                        setResult(Activity.RESULT_OK, Intent().apply {
                            putExtra("ACTION", "UPDATE")
                            putExtra("PROIZVOD_NAZIV", naziv)
                        })

                        // POŠALJI LOCAL BROADCAST ZA OSVEŽAVANJE
                        val broadcastIntent = Intent("PROIZVOD_DODAT")
                        LocalBroadcastManager.getInstance(this@DodajIzmeniActivity).sendBroadcast(broadcastIntent)

                        // Takoðe pošalji za podatke osvežene
                        val syncIntent = Intent("PODACI_OSVEŽENI")
                        LocalBroadcastManager.getInstance(this@DodajIzmeniActivity).sendBroadcast(syncIntent)

                        finish()

                    } else {
                        Log.e("DodajIzmeni", "? Greška pri ažuriranju '$naziv'")
                        Toast.makeText(this, "? Greška pri ažuriranju", Toast.LENGTH_SHORT).show()
                    }
                }
            }
        } else {
            // DODAVANJE NOVOG PROIZVODA
            Log.d("DodajIzmeni", "? Dodavanje novog proizvoda")

            repository.dodajProizvod(proizvod) { success, message ->
                progressDialog.dismiss()
                runOnUiThread {
                    btnSacuvaj.isEnabled = true

                    if (success) {
                        Log.d("DodajIzmeni", "? Proizvod '$naziv' $message")
                        Toast.makeText(this, "? Proizvod '$naziv' $message", Toast.LENGTH_SHORT).show()

                        // SMS i notifikacija ako je kolièina 0
                        if (kolicina <= 0) {
                            Log.d("DodajIzmeni", "?? Kolièina 0 - šaljem SMS")
                            posaljiSMSObavestenje(naziv, kategorija, kolicina)
                            pokusajLokalnuNotifikaciju(naziv, kategorija, kolicina)
                        }

                        // POSTAVI REZULTAT ZA MAIN ACTIVITY
                        setResult(Activity.RESULT_OK, Intent().apply {
                            putExtra("ACTION", "ADD")
                            putExtra("PROIZVOD_NAZIV", naziv)
                            putExtra("PROIZVOD_KATEGORIJA", kategorija)
                        })

                        // POŠALJI LOCAL BROADCAST ZA OSVEŽAVANJE
                        val broadcastIntent = Intent("PROIZVOD_DODAT")
                        LocalBroadcastManager.getInstance(this@DodajIzmeniActivity).sendBroadcast(broadcastIntent)

                        // Takoðe pošalji za podatke osvežene
                        val syncIntent = Intent("PODACI_OSVEŽENI")
                        LocalBroadcastManager.getInstance(this@DodajIzmeniActivity).sendBroadcast(syncIntent)

                        finish()

                    } else {
                        Log.e("DodajIzmeni", "? Greška: $message")
                        Toast.makeText(this, "? Greška: $message", Toast.LENGTH_LONG).show()
                    }
                }
            }
        }
    }
    private fun posaljiSMSObavestenje(nazivProizvoda: String, kategorija: String, kolicina: Int) {
        Log.d("SMS", "Pokreæem slanje SMS-a za: $nazivProizvoda")

        if (ContextCompat.checkSelfPermission(
                this,
                Manifest.permission.SEND_SMS
            ) == PackageManager.PERMISSION_GRANTED
        ) {
            Log.d("SMS", "Ima dozvolu za SMS")
            posaljiSMS(nazivProizvoda, kategorija, kolicina)
        } else {
            Log.d("SMS", "Nema dozvolu za SMS")
            Toast.makeText(this,
                "Nema dozvole za slanje SMS.",
                Toast.LENGTH_LONG).show()
        }
    }

    private fun posaljiSMS(nazivProizvoda: String, kategorija: String, kolicina: Int) {
        try {
            Log.d("SMS", "Pokušavam slanje SMS na broj: $SMS_PHONE_NUMBER")

            if (SMS_PHONE_NUMBER.isBlank() || SMS_PHONE_NUMBER == "+381000000000") {
                Toast.makeText(this,
                    "Molimo podesite validan telefon broj u kodu aplikacije",
                    Toast.LENGTH_LONG).show()
                return
            }

            val vreme = SimpleDateFormat("dd.MM.yyyy HH:mm", Locale.getDefault()).format(Date())
            val poruka = """
                ?? SuperstockGO UPOZORENJE!
                Proizvod: $nazivProizvoda
                Kategorija: $kategorija
                Kolièina: $kolicina
                Vreme: $vreme
                
                HITNO: Proizvod je ponestao!
            """.trimIndent()

            Log.d("SMS", "Poruka: $poruka")

            val smsManager = SmsManager.getDefault()

            if (!android.util.Patterns.PHONE.matcher(SMS_PHONE_NUMBER).matches()) {
                Toast.makeText(this, "Nevalidan telefon broj: $SMS_PHONE_NUMBER", Toast.LENGTH_LONG).show()
                return
            }

            val parts = smsManager.divideMessage(poruka)

            smsManager.sendMultipartTextMessage(
                SMS_PHONE_NUMBER,
                null,
                parts,
                null,
                null
            )

            Log.d("SMS", "SMS uspešno poslat!")
            Toast.makeText(this, "SMS obaveštenje poslato na $SMS_PHONE_NUMBER", Toast.LENGTH_LONG).show()

        } catch (e: SecurityException) {
            Log.e("SMS", "SecurityException: ${e.message}")
            Toast.makeText(this,
                "Greška: Nema dozvole za slanje SMS.",
                Toast.LENGTH_LONG).show()
        } catch (e: IllegalArgumentException) {
            Log.e("SMS", "IllegalArgumentException: ${e.message}")
            Toast.makeText(this, "Nevalidan telefon broj", Toast.LENGTH_LONG).show()
        } catch (e: Exception) {
            Log.e("SMS", "Greška pri slanju SMS: ${e.message}")
            Toast.makeText(this, "Greška pri slanju SMS: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    private fun pokusajLokalnuNotifikaciju(nazivProizvoda: String, kategorija: String, kolicina: Int) {
        try {
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                val channel = NotificationChannel(
                    NOTIFICATION_CHANNEL_ID,
                    "Niska zaliha",
                    NotificationManager.IMPORTANCE_HIGH
                ).apply {
                    description = "Obaveštenja o niskoj zaliži proizvoda"
                    enableVibration(true)
                    vibrationPattern = longArrayOf(0, 500, 200, 500)
                }

                val notificationManager = getSystemService(NotificationManager::class.java)
                notificationManager.createNotificationChannel(channel)
            }

            val intent = Intent(this, MainActivity::class.java).apply {
                flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK
                putExtra("FILTER", "LOW_STOCK")
            }

            val pendingIntent = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                PendingIntent.getActivity(
                    this,
                    0,
                    intent,
                    PendingIntent.FLAG_IMMUTABLE or PendingIntent.FLAG_UPDATE_CURRENT
                )
            } else {
                PendingIntent.getActivity(
                    this,
                    0,
                    intent,
                    PendingIntent.FLAG_UPDATE_CURRENT
                )
            }

            val notification = NotificationCompat.Builder(this, NOTIFICATION_CHANNEL_ID)
                .setSmallIcon(R.mipmap.ic_launcher)
                .setContentTitle("?? Niska zaliha!")
                .setContentText("Proizvod '$nazivProizvoda' je ponestao!")
                .setStyle(NotificationCompat.BigTextStyle()
                    .bigText("Proizvod: $nazivProizvoda\nKategorija: $kategorija\nTrenutna kolièina: $kolicina\n\nHITNO: Dodajte novu zalihu!"))
                .setPriority(NotificationCompat.PRIORITY_HIGH)
                .setContentIntent(pendingIntent)
                .setAutoCancel(true)
                .setVibrate(longArrayOf(0, 500, 200, 500))
                .build()

            with(NotificationManagerCompat.from(this)) {
                if (areNotificationsEnabled()) {
                    notify(System.currentTimeMillis().toInt(), notification)
                    Log.d("DodajIzmeniActivity", "Lokalna notifikacija poslata za: $nazivProizvoda")
                }
            }

        } catch (e: Exception) {
            Log.e("DodajIzmeniActivity", "Greška pri slanju notifikacije: ${e.message}")
        }
    }


    override fun onDestroy() {
        super.onDestroy()
        try {
            //repository.zatvoriBazu()
            Log.d("DodajIzmeniActivity", "Repository baza zatvorena")
        } catch (e: Exception) {
            Log.e("DodajIzmeniActivity", "Greška pri zatvaranju baze: ${e.message}")
        }
    }

    private val kategorije = listOf(
        "?? Hrana",
        "?? Piæe",
        "?? Kancelarijski materijal",
        "?? Odeæa i obuæa",
        "?? Sredstva za èišæenje",
        "?? Elektronika"
    )
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\EmojiHelper.kt

package com.jovannedeljkovic.superstockgo

object EmojiHelper {

    // === UI EMOJI (za TextView, RecyclerView, Toolbar) ===
    object UI {
        // Kategorije
        const val HRANA = "??"
        const val PICE = "??"
        const val OPREMA = "??"
        const val ODECA = "??"
        const val HIGIJENA = "??"
        const val TEHNIKA = "??"
        const val SVE_STAVKE = "??"
        const val NISKA_ZALIHA = "??"
        const val DODAJ_PROIZVOD = "?"

        // Akcije
        const val CHECK = "?"
        const val WARNING = "??"
        const val ERROR = "?"
        const val INFO = "??"
        const val CLOUD = "??"
        const val FOLDER = "??"
        const val STATS = "??"
        const val BACKUP = "??"
        const val SYNC = "??"
        const val SMS = "??"
        const val EMAIL = "??"
        const val PDF = "??"
        const val CSV = "??"
        const val LOGOUT = "??"
        const val CLEAN = "??"
        const val ADD = "?"
        const val EDIT = "??"
        const val DELETE = "???"
        const val HOME = "??"
        const val USER = "??"
        const val OFFLINE = "??"
        const val UPLOAD = "??"
        const val DOWNLOAD = "??"
    }

    // === SYSTEM EMOJI (za Toast, Log, SMS) - jednostavni simboli ===
    object System {
        const val CHECK = "[?]"
        const val WARNING = "[!]"
        const val ERROR = "[?]"
        const val INFO = "[i]"
        const val CLOUD = "[C]"
        const val FOLDER = "[F]"
        const val STATS = "[#]"
        const val BACKUP = "[B]"
        const val SYNC = "[?]"
        const val SMS = "[SMS]"
        const val EMAIL = "[@]"
        const val PDF = "[PDF]"
        const val CSV = "[CSV]"
        const val LOGOUT = "[X]"
        const val CLEAN = "[C]"
        const val ADD = "[+]"
        const val EDIT = "[E]"
        const val DELETE = "[D]"
        const val HOME = "[H]"
        const val USER = "[U]"
        const val OFFLINE = "[O]"
        const val UPLOAD = "[^]"
        const val DOWNLOAD = "[¡]"
    }

    // === ALTERNATIVNI SIMBOLI (za SMS/Email) ===
    object Text {
        const val CHECK = "[OK]"
        const val WARNING = "[UPOZORENJE]"
        const val ERROR = "[GREŠKA]"
        const val INFO = "[INFO]"
        const val CLOUD = "[CLOUD]"
        const val BACKUP = "[BACKUP]"
        const val SYNC = "[SINHRONIZACIJA]"
        const val SMS = "[SMS]"
        const val LOW_STOCK = "[NISKA ZALIHA]"
        const val OUT_OF_STOCK = "[NEMA NA STANJU]"
    }

    // === POMOÆNE METODE ===

    // Za Toast poruke
    fun forToast(type: String): String {
        return when(type.lowercase()) {
            "check", "success", "ok" -> System.CHECK
            "warning", "alert" -> System.WARNING
            "error", "fail" -> System.ERROR
            "info" -> System.INFO
            "cloud" -> System.CLOUD
            "backup" -> System.BACKUP
            "sync" -> System.SYNC
            "sms" -> System.SMS
            "email" -> System.EMAIL
            "pdf" -> System.PDF
            "csv" -> System.CSV
            "logout" -> System.LOGOUT
            "clean" -> System.CLEAN
            "add" -> System.ADD
            "edit" -> System.EDIT
            "delete" -> System.DELETE
            else -> ""
        }
    }

    // Za UI (TextView, Toolbar, CardView)
    fun forUI(type: String): String {
        return when(type.lowercase()) {
            "check", "success", "ok" -> UI.CHECK
            "warning", "alert" -> UI.WARNING
            "error", "fail" -> UI.ERROR
            "info" -> UI.INFO
            "cloud" -> UI.CLOUD
            "backup" -> UI.BACKUP
            "sync" -> UI.SYNC
            "sms" -> UI.SMS
            "email" -> UI.EMAIL
            "pdf" -> UI.PDF
            "csv" -> UI.CSV
            "logout" -> UI.LOGOUT
            "clean" -> UI.CLEAN
            "add" -> UI.ADD
            "edit" -> UI.EDIT
            "delete" -> UI.DELETE
            "home" -> UI.HOME
            "user" -> UI.USER
            "offline" -> UI.OFFLINE
            "upload" -> UI.UPLOAD
            "download" -> UI.DOWNLOAD
            else -> ""
        }
    }

    // Za SMS/Email
    fun forText(type: String): String {
        return when(type.lowercase()) {
            "check", "success", "ok" -> Text.CHECK
            "warning", "alert" -> Text.WARNING
            "error", "fail" -> Text.ERROR
            "info" -> Text.INFO
            "cloud" -> Text.CLOUD
            "backup" -> Text.BACKUP
            "sync" -> Text.SYNC
            "sms" -> Text.SMS
            "low_stock" -> Text.LOW_STOCK
            "out_of_stock" -> Text.OUT_OF_STOCK
            else -> ""
        }
    }

    // === POSTOJEÆE METODE (saèuvajte ih) ===

    // Osnovne kategorije emoji
    val osnovneKategorijeEmoji = listOf(
        UI.HRANA to "Hrana",
        UI.PICE to "Piæe",
        UI.OPREMA to "Kancelarijski materijal",
        UI.ODECA to "Odeæa i obuæa",
        UI.HIGIJENA to "Sredstva za èišæenje",
        UI.TEHNIKA to "Elektronika",
        UI.SVE_STAVKE to "Sve stavke",
        UI.NISKA_ZALIHA to "Niska zaliha",
        UI.DODAJ_PROIZVOD to "Dodaj proizvod"
    )

    // Lista svih dostupnih emoji za spinner
    val sviEmoji = listOf(
        UI.HRANA, UI.PICE, UI.OPREMA, UI.ODECA, UI.HIGIJENA, UI.TEHNIKA,
        "???", "??", "??", "??", "??", "??", "??", "??", "??", "??",
        "??", "??", "??", "??", "??", "??", "??", "??", "??", "??",
        "??", UI.ADD, "?", UI.CHECK, UI.ERROR, "?", "??", "??", "??", "??", "??"
    )

    // Konvertuj emoji u èitljiv tekst (za debug)
    fun emojiToText(emoji: String): String {
        return when(emoji) {
            UI.HRANA -> "Hamburger"
            UI.PICE -> "Cup with straw"
            UI.OPREMA -> "Memo"
            UI.ODECA -> "T-Shirt"
            UI.HIGIJENA -> "Broom"
            UI.TEHNIKA -> "Mobile phone"
            UI.SVE_STAVKE -> "Briefcase"
            UI.NISKA_ZALIHA -> "Warning"
            UI.DODAJ_PROIZVOD -> "Plus"
            else -> "Unknown emoji"
        }
    }

    // Provera da li string sadrži emoji
    fun containsEmoji(text: String): Boolean {
        val regex = Regex("""\p{So}""")
        return regex.containsMatchIn(text)
    }

    // Ekstraktuj emoji iz teksta
    fun extractEmoji(text: String): String {
        val regex = Regex("""(\p{So})""")
        val match = regex.find(text)
        return match?.value ?: ""
    }

    // Ekstraktuj naziv bez emoji
    fun extractNameWithoutEmoji(text: String): String {
        val regex = Regex("""\p{So}\s*""")
        return text.replace(regex, "").trim()
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\FirebaseHelper.kt

package com.jovannedeljkovic.superstockgo

import android.content.Context
import android.util.Log
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.auth.ktx.auth
import com.google.firebase.database.*
import com.google.firebase.database.ktx.database
import com.google.firebase.ktx.Firebase
import kotlinx.coroutines.tasks.await
import kotlinx.coroutines.withTimeout
import kotlinx.coroutines.*
import kotlinx.coroutines.sync.Mutex
import kotlinx.coroutines.sync.withLock

class FirebaseHelper(private val context: Context) {

    private val auth: FirebaseAuth = Firebase.auth
    private val database: FirebaseDatabase = Firebase.database("https://superstockgo-default-rtdb.europe-west1.firebasedatabase.app")
    private val coroutineScope = CoroutineScope(Dispatchers.IO + SupervisorJob())

    fun getDatabase(): FirebaseDatabase {
        return database
    }

    fun getAuth(): FirebaseAuth {
        return auth
    }

    companion object {
        const val PATH_INVENTORY = "inventory"
        const val PATH_USERS = "users"
    }

    // Login sistem
    fun login(email: String, password: String, onComplete: (Boolean, String?) -> Unit) {
        auth.signInWithEmailAndPassword(email, password)
            .addOnCompleteListener { task ->
                if (task.isSuccessful) {
                    val userId = auth.currentUser?.uid
                    onComplete(true, userId)
                } else {
                    onComplete(false, task.exception?.message)
                }
            }
    }

    // Register
    fun register(email: String, password: String, role: String = "user", onComplete: (Boolean, String?) -> Unit) {
        auth.createUserWithEmailAndPassword(email, password)
            .addOnCompleteListener { task ->
                if (task.isSuccessful) {
                    val userId = auth.currentUser?.uid
                    val userRef = database.reference.child(PATH_USERS).child(userId!!)
                    userRef.setValue(mapOf(
                        "email" to email,
                        "role" to role,
                        "createdAt" to System.currentTimeMillis()
                    ))
                        .addOnSuccessListener {
                            onComplete(true, userId)
                        }
                        .addOnFailureListener {
                            onComplete(false, it.message)
                        }
                } else {
                    onComplete(false, task.exception?.message)
                }
            }
    }

    fun logout() {
        auth.signOut()
    }

    fun getCurrentUser(): com.google.firebase.auth.FirebaseUser? {
        return auth.currentUser
    }

    // Dodajte ovu metodu u FirebaseHelper klasu:
    suspend fun backupCategoriesToCloud(categories: List<Kategorija>): Boolean {
        return withContext(Dispatchers.IO) {
            try {
                val userId = auth.currentUser?.uid ?: return@withContext false

                val categoriesRef = database.reference.child("categories").child(userId)

                // Konvertuj kategorije u mapu
                val categoriesMap = mutableMapOf<String, Any>()
                categories.forEachIndexed { index, kategorija ->
                    categoriesMap["category_$index"] = mapOf(
                        "emoji" to kategorija.ikona,
                        "name" to kategorija.naziv,
                        "color" to kategorija.boja
                    )
                }

                categoriesRef.setValue(categoriesMap).await()
                Log.d("FirebaseHelper", "? Kategorije saèuvane u Cloud: ${categories.size}")
                true
            } catch (e: Exception) {
                Log.e("FirebaseHelper", "? Greška pri èuvanju kategorija: ${e.message}")
                false
            }
        }
    }

    fun restoreCategoriesFromCloud(onComplete: (List<Kategorija>) -> Unit) {
        coroutineScope.launch(Dispatchers.IO) {
            try {
                val userId = auth.currentUser?.uid ?: return@launch onComplete(emptyList())

                val categoriesRef = database.reference.child("categories").child(userId)
                val snapshot = categoriesRef.get().await()

                val kategorije = mutableListOf<Kategorija>()

                snapshot.children.forEach { child ->
                    val emoji = child.child("emoji").getValue(String::class.java) ?: ""
                    val name = child.child("name").getValue(String::class.java) ?: ""
                    val color = child.child("color").getValue(Int::class.java) ?: android.R.color.holo_blue_light

                    if (name.isNotEmpty() && emoji.isNotEmpty()) {
                        kategorije.add(Kategorija(emoji, name, color))
                    }
                }

                withContext(Dispatchers.Main) {
                    onComplete(kategorije)
                    Log.d("FirebaseHelper", "? Uèitano ${kategorije.size} kategorija iz Cloud-a")
                }
            } catch (e: Exception) {
                Log.e("FirebaseHelper", "Greška pri uèitavanju kategorija: ${e.message}")
                withContext(Dispatchers.Main) {
                    onComplete(emptyList())
                }
            }
        }
    }
    // Cloud backup
    suspend fun backupToCloud(proizvodi: List<Proizvod>): Boolean {
        return withTimeout(30000) {
            try {
                Log.d("FirebaseHelper", "=== BACKUP START ===")
                Log.d("FirebaseHelper", "Broj proizvoda: ${proizvodi.size}")

                val userId = auth.currentUser?.uid
                if (userId == null) {
                    Log.e("FirebaseHelper", "? User ID je NULL")
                    return@withTimeout false
                }

                Log.d("FirebaseHelper", "? User ID: $userId")

                // Proveri duplikate pre slanja
                val jedinstveniProizvodi = mutableListOf<Proizvod>()
                val naziviSet = mutableSetOf<String>()

                proizvodi.forEach { proizvod ->
                    val kljuc = "${proizvod.naziv}|${proizvod.kategorija}"
                    if (!naziviSet.contains(kljuc)) {
                        naziviSet.add(kljuc)
                        jedinstveniProizvodi.add(proizvod)
                    } else {
                        Log.w("FirebaseHelper", "Preskaèem duplikat: ${proizvod.naziv}")
                    }
                }

                Log.d("FirebaseHelper", "Original: ${proizvodi.size}, Bez duplikata: ${jedinstveniProizvodi.size}")

                // Kreiraj putanju
                val userInventoryRef = database.reference.child("inventory").child(userId)

                // Obriši stari inventar
                Log.d("FirebaseHelper", "Brišem stari inventar...")
                try {
                    userInventoryRef.removeValue().await()
                    Log.d("FirebaseHelper", "? Stari inventar obrisan")
                } catch (e: Exception) {
                    Log.e("FirebaseHelper", "?? Greška pri brisanju: ${e.message}")
                }

                // Dodaj sve proizvode
                Log.d("FirebaseHelper", "Dodajem ${jedinstveniProizvodi.size} proizvoda...")

                var uspešnoDodato = 0
                for ((index, proizvod) in jedinstveniProizvodi.withIndex()) {
                    try {
                        val proizvodId = proizvod.id.toString()
                        if (proizvodId == "0") {
                            // Ako je ID 0, generiši novi
                            val newId = (System.currentTimeMillis() % 1000000).toInt() + index + 1
                            val proizvodMap = mapOf(
                                "id" to newId,
                                "naziv" to proizvod.naziv,
                                "kategorija" to proizvod.kategorija,
                                "kolicina" to proizvod.kolicina,
                                "lastUpdated" to System.currentTimeMillis()
                            )
                            userInventoryRef.child(newId.toString()).setValue(proizvodMap).await()
                        } else {
                            val proizvodMap = mapOf(
                                "id" to proizvod.id,
                                "naziv" to proizvod.naziv,
                                "kategorija" to proizvod.kategorija,
                                "kolicina" to proizvod.kolicina,
                                "lastUpdated" to System.currentTimeMillis()
                            )
                            userInventoryRef.child(proizvodId).setValue(proizvodMap).await()
                        }

                        uspešnoDodato++
                        Log.d("FirebaseHelper", "? ${proizvod.naziv} dodat")

                    } catch (e: Exception) {
                        Log.e("FirebaseHelper", "? Greška pri dodavanju ${proizvod.naziv}: ${e.message}")
                    }

                    // Mali delay izmeðu proizvoda
                    kotlinx.coroutines.delay(50)
                }

                Log.d("FirebaseHelper", "=== BACKUP COMPLETE ===")
                Log.d("FirebaseHelper", "Uspešno dodato $uspešnoDodato/${jedinstveniProizvodi.size} proizvoda")

                return@withTimeout uspešnoDodato > 0

            } catch (e: Exception) {
                Log.e("FirebaseHelper", "? EXCEPTION u backupToCloud: ${e.message}", e)
                false
            }
        }
    }
    fun backupCategoriesToCloud(categories: List<Kategorija>, onComplete: (Boolean) -> Unit) {
        val userId = auth.currentUser?.uid ?: return onComplete(false)

        coroutineScope.launch(Dispatchers.IO) {
            try {
                val categoriesRef = database.reference.child("categories").child(userId)

                // Konvertuj kategorije u mapu
                val categoriesMap = mutableMapOf<String, Any>()
                categories.forEachIndexed { index, kategorija ->
                    categoriesMap["category_$index"] = mapOf(
                        "emoji" to kategorija.ikona,
                        "name" to kategorija.naziv,
                        "color" to kategorija.boja
                    )
                }

                categoriesRef.setValue(categoriesMap).await()

                withContext(Dispatchers.Main) {
                    onComplete(true)
                    Log.d("FirebaseHelper", "Kategorije saèuvane u Cloud: ${categories.size}")
                }
            } catch (e: Exception) {
                Log.e("FirebaseHelper", "Greška pri èuvanju kategorija: ${e.message}")
                withContext(Dispatchers.Main) {
                    onComplete(false)
                }
            }
        }
    }


    fun addProductToCloud(proizvod: Proizvod, onComplete: (Boolean) -> Unit) {
        val userId = auth.currentUser?.uid ?: return onComplete(false)

        val proizvodRef = database.reference
            .child(PATH_INVENTORY)
            .child(userId)
            .child(proizvod.id.toString())

        val proizvodMap = mapOf(
            "id" to proizvod.id,
            "naziv" to proizvod.naziv,
            "kategorija" to proizvod.kategorija,
            "kolicina" to proizvod.kolicina,
            "lastUpdated" to System.currentTimeMillis()
        )

        proizvodRef.setValue(proizvodMap)
            .addOnSuccessListener {
                onComplete(true)
                Log.d("FirebaseHelper", "Proizvod ${proizvod.naziv} dodat u cloud")
            }
            .addOnFailureListener {
                onComplete(false)
                Log.e("FirebaseHelper", "Greška pri dodavanju proizvoda u cloud: ${it.message}")
            }
    }

    suspend fun restoreFromCloud(): List<Proizvod> {
        return try {
            val userId = auth.currentUser?.uid ?: return emptyList()
            val snapshot = database.reference.child(PATH_INVENTORY).child(userId).get().await()

            val proizvodi = mutableListOf<Proizvod>()
            val naziviSet = mutableSetOf<String>() // Za praæenje duplikata
            var duplikati = 0

            for (child in snapshot.children) {
                val id = child.child("id").getValue(Int::class.java) ?: 0
                val naziv = child.child("naziv").getValue(String::class.java) ?: ""
                val kategorija = child.child("kategorija").getValue(String::class.java) ?: ""
                val kolicina = child.child("kolicina").getValue(Int::class.java) ?: 0

                val proizvod = Proizvod(id, naziv, kategorija, kolicina)
                val uniqueKey = proizvod.getUniqueKey() // KORISTIMO NOVU METODU

                // Proveri duplikate
                if (!naziviSet.contains(uniqueKey)) {
                    naziviSet.add(uniqueKey)
                    proizvodi.add(proizvod)
                    Log.d("FirebaseHelper", "? Uèitano: $naziv (ID: $id, Key: $uniqueKey)")
                } else {
                    duplikati++
                    Log.w("FirebaseHelper", "? Duplikat preskoèen: $naziv")
                }
            }

            Log.d("FirebaseHelper", "Uèitano ${proizvodi.size} jedinstvenih proizvoda iz Cloud-a")
            Log.d("FirebaseHelper", "Preskoèeno $duplikati duplikata")
            proizvodi
        } catch (e: Exception) {
            Log.e("FirebaseHelper", "Greška pri restore: ${e.message}")
            emptyList()
        }
    }

    // Pojednostavljena metoda za èuvanje
    fun saveProductSimple(proizvod: Proizvod, onComplete: (Boolean) -> Unit) {
        try {
            val userId = auth.currentUser?.uid
            if (userId == null) {
                onComplete(false)
                return
            }

            val ref = database.reference.child("inventory").child(userId)

            val proizvodMap = hashMapOf(
                "id" to proizvod.id,
                "naziv" to proizvod.naziv,
                "kategorija" to proizvod.kategorija,
                "kolicina" to proizvod.kolicina,
                "lastUpdated" to System.currentTimeMillis()
            )

            ref.child(proizvod.id.toString()).setValue(proizvodMap)
                .addOnSuccessListener {
                    Log.d("FirebaseHelper", "Proizvod saèuvan: ${proizvod.naziv}")
                    onComplete(true)
                }
                .addOnFailureListener { e ->
                    Log.e("FirebaseHelper", "Greška: ${e.message}")
                    onComplete(false)
                }

        } catch (e: Exception) {
            Log.e("FirebaseHelper", "Greška: ${e.message}")
            onComplete(false)
        }
    }

    fun loadProductsSimple(onComplete: (List<Proizvod>) -> Unit) {
        try {
            val userId = auth.currentUser?.uid
            if (userId == null) {
                onComplete(emptyList())
                return
            }

            val ref = database.reference.child("inventory").child(userId)

            ref.addListenerForSingleValueEvent(object : ValueEventListener {
                override fun onDataChange(snapshot: DataSnapshot) {
                    val proizvodi = mutableListOf<Proizvod>()

                    for (child in snapshot.children) {
                        val proizvod = Proizvod(
                            id = child.child("id").getValue(Int::class.java) ?: 0,
                            naziv = child.child("naziv").getValue(String::class.java) ?: "",
                            kategorija = child.child("kategorija").getValue(String::class.java) ?: "",
                            kolicina = child.child("kolicina").getValue(Int::class.java) ?: 0
                        )
                        proizvodi.add(proizvod)
                    }

                    Log.d("FirebaseHelper", "Uèitano ${proizvodi.size} proizvoda")
                    onComplete(proizvodi)
                }

                override fun onCancelled(error: DatabaseError) {
                    Log.e("FirebaseHelper", "Greška: ${error.message}")
                    onComplete(emptyList())
                }
            })

        } catch (e: Exception) {
            Log.e("FirebaseHelper", "Greška: ${e.message}")
            onComplete(emptyList())
        }
    }

    // Metoda za brisanje proizvoda iz Firebase
    fun obrisiProizvodIzFirebase(proizvod: Proizvod, onComplete: (Boolean) -> Unit) {
        val userId = auth.currentUser?.uid ?: return onComplete(false)

        Log.d("FirebaseHelper", "Brišem proizvod iz Firebase: ${proizvod.naziv} (ID: ${proizvod.id})")

        // VAŽNO: Proveri da li koristiš pravi put
        val proizvodRef = database.reference
            .child(PATH_INVENTORY)
            .child(userId)
            .child(proizvod.id.toString())  // OVO JE KLJUÈNO: .child(proizvod.id.toString())

        proizvodRef.removeValue()
            .addOnSuccessListener {
                Log.d("FirebaseHelper", "? Proizvod obrisan iz Firebase: ${proizvod.naziv}")
                onComplete(true)
            }
            .addOnFailureListener { e ->
                Log.e("FirebaseHelper", "? Greška pri brisanju iz Firebase: ${e.message}")
                onComplete(false)
            }
    }

    fun isFirebaseConfigured(): Boolean {
        return try {
            // Proveri da li Firebase inicijalizovan
            Firebase.auth.currentUser != null || Firebase.database.reference.key != null
        } catch (e: Exception) {
            false
        }
    }

    // Metoda za direktno dobijanje database reference
    fun getDatabaseReference(): DatabaseReference {
        return database.reference
    }

    // ===== NOVE METODE ZA CloudSyncActivity =====

    fun backupToCloudSimple(proizvodi: List<Proizvod>, onComplete: (Boolean, String) -> Unit) {
        coroutineScope.launch(Dispatchers.IO) {
            try {
                val success = backupToCloud(proizvodi)
                withContext(Dispatchers.Main) {
                    if (success) {
                        onComplete(true, "Backup uspešan! Saèuvano ${proizvodi.size} proizvoda.")
                    } else {
                        onComplete(false, "Backup nije uspeo.")
                    }
                }
            } catch (e: Exception) {
                Log.e("FirebaseHelper", "Greška u backupToCloudSimple: ${e.message}")
                withContext(Dispatchers.Main) {
                    onComplete(false, "Greška: ${e.message}")
                }
            }
        }
    }

    fun restoreFromCloudSimple(onComplete: (List<Proizvod>) -> Unit) {
        coroutineScope.launch(Dispatchers.IO) {
            try {
                val proizvodi = restoreFromCloud()
                withContext(Dispatchers.Main) {
                    onComplete(proizvodi)
                }
            } catch (e: Exception) {
                Log.e("FirebaseHelper", "Greška u restoreFromCloudSimple: ${e.message}")
                withContext(Dispatchers.Main) {
                    onComplete(emptyList())
                }
            }
        }
    }

    fun deleteProductFromCloud(proizvod: Proizvod, onComplete: (Boolean) -> Unit) {
        val userId = auth.currentUser?.uid ?: return onComplete(false)

        database.reference
            .child(PATH_INVENTORY)
            .child(userId)
            .child(proizvod.id.toString())
            .removeValue()
            .addOnSuccessListener {
                onComplete(true)
                Log.d("FirebaseHelper", "Proizvod obrisan iz cloud-a: ${proizvod.naziv}")
            }
            .addOnFailureListener { e ->
                onComplete(false)
                Log.e("FirebaseHelper", "Greška pri brisanju iz cloud-a: ${e.message}")
            }
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\Kategorija.kt

package com.jovannedeljkovic.superstockgo

data class Kategorija(
    val ikona: String,
    val naziv: String,
    val boja: Int
)


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\KategorijaAdapter.kt

package com.jovannedeljkovic.superstockgo

import android.content.Context
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.*
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AlertDialog
import androidx.cardview.widget.CardView
import androidx.recyclerview.widget.RecyclerView
import androidx.core.content.ContextCompat

class KategorijaAdapter(
    private val kategorije: List<Kategorija>,
    private val onKategorijaClick: (Kategorija) -> Unit,
    private val onEditCategoryClick: ((Kategorija) -> Unit)? = null,
    private val onDeleteCategoryClick: ((Kategorija) -> Unit)? = null,
    private val onRestoreCategoryClick: ((Kategorija) -> Unit)? = null,
    private val onUpdateCategoryClick: ((Kategorija, Kategorija) -> Unit)? = null // NOVO
) : RecyclerView.Adapter<KategorijaAdapter.KategorijaViewHolder>() {

    // OSNOVNE KATEGORIJE KONSTANTE
    private val osnovneKategorijeNazivi = Constants.Kategorije.SVE

    // POMOÆNE LISTE ZA DETEKCIJU
    private val originalOsnovneNazivi = listOf(
        "Hrana", "Piæe", "Oprema", "Odeæa", "Higijena", "Tehnika"
    )

    class KategorijaViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) {
        val cardView: CardView = itemView.findViewById(R.id.cardKategorija)
        val tvIkona: TextView = itemView.findViewById(R.id.tvIkona)
        val tvNaziv: TextView = itemView.findViewById(R.id.tvNazivKategorija)
    }

    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): KategorijaViewHolder {
        val view = LayoutInflater.from(parent.context)
            .inflate(R.layout.item_kategorija, parent, false)
        return KategorijaViewHolder(view)
    }

    override fun onBindViewHolder(holder: KategorijaViewHolder, position: Int) {
        val kategorija = kategorije[position]

        holder.tvIkona.text = kategorija.ikona
        holder.tvNaziv.text = kategorija.naziv
        holder.cardView.setCardBackgroundColor(
            ContextCompat.getColor(holder.itemView.context, kategorija.boja)
        )

        // Proveri da li je ovo originalna osnovna kategorija
        val isOriginalOsnovna = originalOsnovneNazivi.contains(kategorija.naziv)

        // Proveri da li je modifikovana verzija osnovne kategorije
        val isModifiedOsnovna = isModifiedOsnovnaCategory(kategorija.naziv)

        // LONG CLICK - razlièito ponašanje za razlièite tipove kategorija
        holder.itemView.setOnLongClickListener {
            when {
                // Ako je ORIGINALNA osnovna kategorija - dozvoli edit
                isOriginalOsnovna -> {
                    onEditCategoryClick?.invoke(kategorija)
                    true
                }

                // Ako je MODIFIKOVANA osnovna kategorija - prikaži opciju za vraæanje
                isModifiedOsnovna -> {
                    showRestoreOptionsDialog(holder.itemView.context, kategorija)
                    true
                }

                // Ako je PRAVA custom kategorija (nije osnovna) - prikaži opcije za brisanje/izmenu
                else -> {
                    showCustomCategoryOptions(holder.itemView.context, kategorija)
                    true
                }
            }
        }

        // SHORT CLICK - navigacija
        holder.itemView.setOnClickListener {
            onKategorijaClick(kategorija)
        }
    }

    override fun getItemCount(): Int = kategorije.size

    // ========== POMOÆNE METODE ==========

    /**
     * Proverava da li je kategorija modifikovana verzija osnovne kategorije
     * Na primer: "Hrana1", "Hrana (Voæe)", "Piæe2" itd.
     */
    private fun isModifiedOsnovnaCategory(categoryName: String): Boolean {
        // Proveri da li naziv poèinje sa nekom od osnovnih kategorija
        return originalOsnovneNazivi.any { baseName ->
            categoryName.startsWith(baseName) && categoryName != baseName
        }
    }

    /**
     * Pronalazi originalni naziv za modifikovanu kategoriju
     */
    private fun findOriginalName(modifiedName: String): String? {
        return originalOsnovneNazivi.find { modifiedName.startsWith(it) }
    }

    /**
     * Dijalog opcija za vraæanje modifikovane kategorije na original
     */
    private fun showRestoreOptionsDialog(context: Context, kategorija: Kategorija) {
        val originalName = findOriginalName(kategorija.naziv)

        if (originalName != null) {
            AlertDialog.Builder(context)
                .setTitle("Opcije za '${kategorija.naziv}'")
                .setMessage("Ova kategorija je izmenjena verzija originalne '$originalName'")
                .setPositiveButton("Vrati na '$originalName'") { _, _ ->
                    // Pozovi callback za vraæanje na original
                    onRestoreCategoryClick?.invoke(
                        Kategorija(
                            ikona = Constants.Kategorije.EMOJI_MAP[originalName] ?: "\uD83D\uDCDC",
                            naziv = originalName,
                            boja = Constants.Kategorije.BOJA_MAP[originalName] ?: android.R.color.holo_blue_light
                        )
                    )
                }
                .setNegativeButton("Obriši ovu kategoriju") { _, _ ->
                    // Pozovi callback za brisanje
                    onDeleteCategoryClick?.invoke(kategorija)
                }
                .setNeutralButton("Otkaži", null)
                .show()
        } else {
            // Ako ne možemo pronaæi original, tretiraj kao custom kategoriju
            showCustomCategoryOptions(context, kategorija)
        }
    }

    /**
     * Dijalog opcija za prave custom kategorije
     */
    private fun showCustomCategoryOptions(context: Context, kategorija: Kategorija) {
        val options = arrayOf("Obriši", "Izmeni", "Otkaži")

        AlertDialog.Builder(context)
            .setTitle("Opcije za '${kategorija.naziv}'")
            .setItems(options) { _, which ->
                when (which) {
                    0 -> { // Brisanje
                        AlertDialog.Builder(context)
                            .setTitle("Potvrda brisanja")
                            .setMessage("Da li ste sigurni da želite da obrišete '${kategorija.naziv}'?\n\nProizvodi u ovoj kategoriji NEÆE biti obrisani.")
                            .setPositiveButton("Obriši") { _, _ ->
                                onDeleteCategoryClick?.invoke(kategorija)
                            }
                            .setNegativeButton("Otkaži", null)
                            .show()
                    }
                    1 -> { // Izmena
                        showEditCustomCategoryDialog(context, kategorija)
                    }
                    // 2 -> Otkaži
                }
            }
            .show()
    }

    private fun showEditCustomCategoryDialog(context: Context, kategorija: Kategorija) {
        val inflater = LayoutInflater.from(context)
        val dialogView = inflater.inflate(R.layout.dialog_add_category, null)

        val etNaziv = dialogView.findViewById<EditText>(R.id.etNazivKategorije)
        val spEmoji = dialogView.findViewById<Spinner>(R.id.spEmoji)
        val spBoja = dialogView.findViewById<Spinner>(R.id.spBoja)

        // Postavi postojeæe vrednosti
        etNaziv.setText(kategorija.naziv)

        // ========== LISTA EMOJI-JA ==========
        val emojiList = listOf(
            "\uD83C\uDF54", "\uD83E\uDD64", "\uD83D\uDCDD", "\uD83D\uDC55", "\uD83E\uDDF9",
            "\uD83D\uDCF1", "\uD83D\uDECD", "\uD83D\uDCBC", "\uD83C\uDF7A", "\uD83C\uDF2E",
            "\uD83C\uDF6A", "\uD83C\uDF69", "\uD83E\uDD5E", "\uD83C\uDF53", "\uD83E\uDDC0",
            "\uD83D\uDD27", "\uD83D\uDE9B", "\uD83D\uDE97", "\uD83C\uDFA7", "\uD83D\uDCF7",
            "\uD83D\uDCBB", "\uD83D\uDCFA", "\uD83D\uDCE6", "\uD83D\uDED2", "\uD83D\uDCB0",
            "\uD83D\uDCB5", "\u002B\uFE0F\u20E3", "\u2796", "\u2705", "\u274C",
            "\u2B55", "\uD83D\uDD34", "\uD83D\uDFE2", "\uD83D\uDFE1", "\uD83D\uDD35", "\uD83D\uDD36"
        )

        val emojiOpisi = listOf(
            "?? Hamburger", "?? Èaša sa slamkom", "?? Beleške", "?? Majica", "?? Metla",
            "?? Mobilni telefon", "??? Shopping torbe", "?? Aktovka", "?? Èaša piva", "?? Tako",
            "?? Keks", "?? Krofna", "?? Hleb", "?? Jagoda", "?? Sir", "?? Kljuè", "?? Kamion",
            "?? Automobil", "?? Slušalice", "?? Kamera", "?? Laptop", "?? Televizor", "?? Paket",
            "?? Kolica", "?? Kesica novca", "?? Novèanica", "? Plus", "? Minus", "? Taèno",
            "? Pogrešno", "? Krug", "?? Crveni krug", "?? Zeleni krug", "?? Žuti krug",
            "?? Plavi krug", "?? Narandžasti dijamant"
        )

        // ========== LISTA BOJA ==========
        val bojeList = listOf(
            "Zelena svetla" to R.color.green_light,
            "Zelena" to android.R.color.holo_green_light,
            "Zelena tamna" to android.R.color.holo_green_dark,
            "Plava svetla" to R.color.blue_light,
            "Plava" to android.R.color.holo_blue_light,
            "Plava tamna" to android.R.color.holo_blue_dark,
            "Narandžasta" to android.R.color.holo_orange_light,
            "Narandžasta tamna" to android.R.color.holo_orange_dark,
            "Ljubièasta" to android.R.color.holo_purple,
            "Ljubièasta svetla" to R.color.purple_light,
            "Crvena" to android.R.color.holo_red_light,
            "Crvena tamna" to android.R.color.holo_red_dark,
            "Siva" to android.R.color.darker_gray,
            "Žuta" to android.R.color.holo_orange_dark,
            "Tirkizna" to android.R.color.holo_blue_bright
        )

        // Postavi adaptere za spinner-e
        val emojiAdapter = ArrayAdapter(context, android.R.layout.simple_spinner_item, emojiOpisi)
        val bojeAdapter = ArrayAdapter(context, android.R.layout.simple_spinner_item, bojeList.map { it.first })

        emojiAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
        bojeAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)

        spEmoji.adapter = emojiAdapter
        spBoja.adapter = bojeAdapter

        // Selektuj trenutni emoji
        val emojiPosition = emojiList.indexOf(kategorija.ikona)
        if (emojiPosition >= 0) {
            spEmoji.setSelection(emojiPosition)
        }

        // Selektuj trenutnu boju
        val bojaIndex = bojeList.indexOfFirst { it.second == kategorija.boja }
        if (bojaIndex >= 0) {
            spBoja.setSelection(bojaIndex)
        }

        AlertDialog.Builder(context)
            .setTitle("Izmeni kategoriju '${kategorija.naziv}'")
            .setView(dialogView)
            .setPositiveButton("Saèuvaj") { _, _ ->
                val noviNaziv = etNaziv.text.toString().trim()
                val emojiIndex = spEmoji.selectedItemPosition
                val noviEmoji = emojiList[emojiIndex]
                val novaBoja = bojeList[spBoja.selectedItemPosition].second

                if (noviNaziv.isEmpty()) {
                    Toast.makeText(context, "Unesite naziv kategorije", Toast.LENGTH_SHORT).show()
                    return@setPositiveButton
                }

                if (noviNaziv == kategorija.naziv &&
                    noviEmoji == kategorija.ikona &&
                    novaBoja == kategorija.boja) {
                    Toast.makeText(context, "Niste napravili nikakve promene", Toast.LENGTH_SHORT).show()
                    return@setPositiveButton
                }

                // Kreiraj ažuriranu kategoriju
                val azuriranaKategorija = Kategorija(noviEmoji, noviNaziv, novaBoja)

                // Pozovi callback za ažuriranje
                onUpdateCategoryClick?.invoke(kategorija, azuriranaKategorija)

                Toast.makeText(context,
                    "Kategorija '${kategorija.naziv}' ažurirana",
                    Toast.LENGTH_SHORT).show()
            }
            .setNegativeButton("Otkaži", null)
            .show()
    }
    /**
     * Update podataka u adapteru
     */
    fun updateData(newKategorije: List<Kategorija>) {
        // Ova metoda bi trebala biti u adapteru, ali koristimo notifyDataSetChanged
        // Ako želite bolje performanse, koristite ListAdapter umesto RecyclerView.Adapter
        // Za sada æemo koristiti notifyDataSetChanged u aktivnosti
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\KategorijaHelper.kt

package com.jovannedeljkovic.superstockgo

object KategorijaHelper {

    // Ekstraktuj èisti naziv iz pune kategorije (bez emoji)
    fun extractCleanName(fullCategory: String): String {
        return fullCategory.replace(Regex("^[\\p{So}\\s]+"), "").trim()
    }

    // Kreiraj punu kategoriju (sa emoji)
    fun createFullCategory(emoji: String, name: String): String {
        return "$emoji $name".trim()
    }

    // Proveri da li su dve kategorije iste (ignoriše emoji)
    fun areCategoriesEqual(category1: String, category2: String): Boolean {
        val clean1 = extractCleanName(category1)
        val clean2 = extractCleanName(category2)
        return clean1 == clean2
    }

    // Pronaði sve proizvode sa odreðenom kategorijom
    fun findProductsByCategory(products: List<Proizvod>, categoryName: String): List<Proizvod> {
        val cleanCategoryName = extractCleanName(categoryName)
        return products.filter { product ->
            val cleanProductCategory = extractCleanName(product.kategorija)
            cleanProductCategory == cleanCategoryName
        }
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\KategorijeActivity.kt

package com.jovannedeljkovic.superstockgo

import android.content.Context
import android.content.Intent
import android.os.Bundle
import android.util.Log
import android.widget.*
import androidx.appcompat.app.AlertDialog
import androidx.appcompat.app.AppCompatActivity
import androidx.appcompat.widget.Toolbar
import androidx.core.content.ContextCompat
import androidx.recyclerview.widget.GridLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken
import android.graphics.Color
import android.os.Handler
import android.os.Looper
import android.text.SpannableString
import android.text.style.ForegroundColorSpan
import android.view.Gravity
import android.view.LayoutInflater
import android.view.Menu
import android.view.MenuItem
import android.app.ProgressDialog
import android.text.Spannable
import android.text.SpannableStringBuilder
import android.text.style.StyleSpan
import kotlinx.coroutines.*
import androidx.localbroadcastmanager.content.LocalBroadcastManager


class KategorijeActivity : AppCompatActivity() {

    private val customCategories = mutableListOf<Kategorija>()
    private lateinit var adapter: KategorijaAdapter
    private lateinit var recyclerView: RecyclerView
    private lateinit var repository: Repository
    private val coroutineScope = CoroutineScope(Dispatchers.Main + SupervisorJob())

    companion object {
        // Pomoæna metoda za ekstrakciju èistog naziva iz kategorije (bez emoji)
        fun extractCategoryName(fullCategory: String): String {
            // Ukloni emoji i dodatni whitespace
            return fullCategory.replace(Regex("^[\\p{So}\\s]+"), "").trim()
        }

        // Pomoæna metoda za kreiranje pune kategorije (sa emoji)
        fun createFullCategory(emoji: String, name: String): String {
            return "$emoji $name"
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_kategorije)

        // ========== TOOLBAR SETUP ==========
        val toolbar: Toolbar = findViewById(R.id.toolbar)

        // 1. Postavi toolbar
        setSupportActionBar(toolbar)

        toolbar.setBackgroundColor(ContextCompat.getColor(this, R.color.purple_500))
        toolbar.setTitleTextColor(ContextCompat.getColor(this, android.R.color.white))
        toolbar.setSubtitleTextColor(ContextCompat.getColor(this, android.R.color.white))
        // 2. Postavi naslove
        supportActionBar?.title = "SuperstockGO"

        // 3. Postavi subtitle sa email-om korisnika
        repository = Repository(this)
        val firebaseHelper = FirebaseHelper(this)
        val currentUser = firebaseHelper.getCurrentUser()
        if (currentUser != null) {
            supportActionBar?.subtitle = "?? ${currentUser.email}"
        } else {
            supportActionBar?.subtitle = "?? Offline mod"
        }

        // 4. FORSIRAJ beli tekst za naslove
        toolbar.setTitleTextColor(ContextCompat.getColor(this, android.R.color.white))
        toolbar.setSubtitleTextColor(ContextCompat.getColor(this, android.R.color.white))

        // 5. Postavi overflow ikonu na belo
        try {
            val overflowIcon = toolbar.overflowIcon
            if (overflowIcon != null) {
                val whiteOverflowIcon = overflowIcon.mutate()
                whiteOverflowIcon.setTint(ContextCompat.getColor(this, android.R.color.white))
                toolbar.overflowIcon = whiteOverflowIcon
            }
        } catch (e: Exception) {
            Log.e("KategorijeActivity", "Greška pri postavljanju overflow ikone: ${e.message}")
        }

        val addButton = Button(this).apply {
            text = "+ Dodaj kategoriju"
            setTextColor(ContextCompat.getColor(this@KategorijeActivity, android.R.color.white))
            setBackgroundColor(Color.TRANSPARENT)
            setOnClickListener {
                showAddCategoryDialog()
            }
        }
        toolbar.addView(addButton)
        // Ovo je KLJUÈNO za crni tekst u popup meniju
        toolbar.popupTheme = R.style.Theme_SuperstockGO_LightPopup

        // ========== INICIJALIZACIJA ==========
        // Inicijalizacija RecyclerView
        recyclerView = findViewById(R.id.rvKategorije)
        recyclerView.layoutManager = GridLayoutManager(this, 2)

        // Inicijalizacija Repository (ako veæ niste)
        if (!::repository.isInitialized) {
            repository = Repository(this)
        }

        // Migracija starih podataka
        repository.migrirajPodatkeZaTrenutnogKorisnika()

        // Uèitaj custom kategorije iz svih izvora - PROMENJENO OVDE!
        loadCategoriesFromAllSources() // ZAMENJENO: loadCustomCategories()

        // Postavi adapter sa potrebnim callback-ovima
        setupAdapter()

        // Proveri duplikate pri pokretanju
        checkForDuplicates()

        // Proveri potencijalne probleme
        checkForIssues()

        Log.d("KategorijeActivity", "? KategorijeActivity onCreate završen")
    }


    private fun checkForDuplicates() {
        repository.sviProizvodi { proizvodi ->
            val naziviSet = mutableSetOf<String>()
            val duplicates = mutableListOf<Proizvod>()

            proizvodi.forEach { proizvod ->
                val kljuc = "${proizvod.naziv}|${proizvod.kategorija}"
                if (naziviSet.contains(kljuc)) {
                    duplicates.add(proizvod)
                } else {
                    naziviSet.add(kljuc)
                }
            }

            if (duplicates.isNotEmpty()) {
                Log.w("KategorijeActivity", "Pronaðeno ${duplicates.size} duplikata")
                // Možete prikazati upozorenje ili automatski ukloniti duplikate
                Toast.makeText(this,
                    "Pronaðeno ${duplicates.size} dupliranih proizvoda",
                    Toast.LENGTH_LONG).show()
            }
        }
    }

    /**
     * Postavi subtitle sa informacijama o korisniku
     */
    /**
     * Postavi subtitle sa informacijama o korisniku
     */
    private fun updateToolbarSubtitle() {
        val toolbar: Toolbar = findViewById(R.id.toolbar)
        val userEmail = repository.getCurrentUserEmail()

        if (repository.isUserLoggedIn()) {
            toolbar.subtitle = userEmail ?: "Prijavljen"
        } else {
            toolbar.subtitle = "Niste prijavljeni (offline mod)"

            // Ako nije prijavljen, možda želite da prikažete poruku
            Toast.makeText(this,
                "Radite u offline modu. Podaci æe biti saèuvani samo lokalno.",
                Toast.LENGTH_LONG).show()
        }
    }


    /**
     * Postavi adapter sa svim potrebnim callback-ovima
     */
    private fun setupAdapter() {
        // Uèitaj zamenjene kategorije iz SharedPreferences
        val sharedPref = getSharedPreferences("replaced_categories", Context.MODE_PRIVATE)
        val replacedCategories = sharedPref.all

        // Kreiraj osnovne kategorije, ali preskoèi one koje su zamenjene
        val osnovneKategorije = Constants.Kategorije.SVE
            .filter { naziv -> !replacedCategories.containsKey(naziv) }
            .map { naziv ->
                Kategorija(
                    ikona = Constants.Kategorije.EMOJI_MAP[naziv] ?: "\uD83D\uDCDC",
                    naziv = naziv,
                    boja = Constants.Kategorije.BOJA_MAP[naziv] ?: android.R.color.holo_blue_light
                )
            }

        // Kombinuj osnovne + custom kategorije
        val sveKategorije = osnovneKategorije + customCategories

        // Kreiraj adapter sa svim callback-ovima
        adapter = KategorijaAdapter(
            kategorije = sveKategorije,
            onKategorijaClick = { kategorija ->
                handleKategorijaClick(kategorija)
            },
            onEditCategoryClick = { kategorija ->
                // Edit za originalne osnovne kategorije
                if (Constants.Kategorije.OSNOVNE.contains(kategorija.naziv)) {
                    showEditCategoryDialog(kategorija)
                }
            },
            onDeleteCategoryClick = { kategorija ->
                // Brisanje custom kategorija
                showDeleteCategoryConfirmation(kategorija)
            },
            onUpdateCategoryClick = { staraKategorija, novaKategorija ->
                updateCustomCategory(staraKategorija, novaKategorija)
            },
            onRestoreCategoryClick = { originalKategorija ->
                // Ovo je NOVO: handle za vraæanje na original
                showRestoreToOriginalDialog(originalKategorija)
            }
        )

        recyclerView.adapter = adapter

        // Debug informacije
        Log.d("KategorijeActivity", "Ukupno kategorija: ${sveKategorije.size}")
        Log.d("KategorijeActivity", "Osnovne: ${osnovneKategorije.size}, Custom: ${customCategories.size}")
        Log.d("KategorijeActivity", "Zamenjene kategorije: ${replacedCategories.keys}")
    }

    private fun updateCustomCategory(staraKategorija: Kategorija, novaKategorija: Kategorija) {
        // Pronaði i zameni u listi
        val index = customCategories.indexOfFirst { it.naziv == staraKategorija.naziv }
        if (index != -1) {
            customCategories[index] = novaKategorija
            saveCustomCategories()
            setupAdapter()

            // Ažuriraj sve proizvode sa starom kategorijom
            repository.sviProizvodi { proizvodi ->
                proizvodi.forEach { proizvod ->
                    if (proizvod.kategorija.contains(staraKategorija.naziv)) {
                        val novaKategorijaPunNaziv = "${novaKategorija.ikona} ${novaKategorija.naziv}"
                        val azuriranProizvod = proizvod.copy(kategorija = novaKategorijaPunNaziv)
                        repository.azurirajProizvod(azuriranProizvod) { success ->
                            if (success) {
                                Log.d("UpdateCategory", "Ažuriran proizvod: ${proizvod.naziv}")
                            }
                        }
                    }
                }

                runOnUiThread {
                    Toast.makeText(this,
                        "Kategorija ažurirana za sve proizvode",
                        Toast.LENGTH_SHORT).show()
                }
            }
        }
    }
    /**
     * Proverava potencijalne probleme
     */
    /**
     * Proverava potencijalne probleme
     */
    private fun checkForIssues() {
        // Proveri da li Firebase radi
        val firebaseHelper = FirebaseHelper(this)
        if (!firebaseHelper.isFirebaseConfigured()) {
            Toast.makeText(this,
                "Firebase nije pravilno konfigurisan. Cloud funkcionalnosti neæe raditi.",
                Toast.LENGTH_LONG).show()
        }

        // Proveri broj proizvoda
        repository.brojProizvodaZaKorisnika { broj ->
            Log.d("KategorijeActivity", "Korisnik ima $broj proizvoda")
            if (broj == 0) {
                // Možete prikazati poruku za novog korisnika
                // showWelcomeMessage()
            }
        }
    }

    /**
     * Potvrda brisanja kategorije
     */
    private fun showDeleteCategoryConfirmation(kategorija: Kategorija) {
        AlertDialog.Builder(this)
            .setTitle("Brisanje kategorije")
            .setMessage("Da li ste sigurni da želite da obrišete '${kategorija.naziv}'?\n\n" +
                    "Proizvodi u ovoj kategoriji NEÆE biti obrisani, ali æe ostati bez kategorije.")
            .setPositiveButton("Obriši") { _, _ ->
                // Ukloni kategoriju iz liste
                customCategories.removeAll { it.naziv == kategorija.naziv }
                saveCustomCategories()
                setupAdapter()

                Toast.makeText(this, "Kategorija '${kategorija.naziv}' obrisana", Toast.LENGTH_SHORT).show()
            }
            .setNegativeButton("Otkaži", null)
            .show()
    }


    /**
     * Vraæanje na originalnu kategoriju
     */
    private fun showRestoreToOriginalDialog(originalKategorija: Kategorija) {
        AlertDialog.Builder(this)
            .setTitle("Vraæanje na original")
            .setMessage("Da li želite da vratite kategoriju '${originalKategorija.naziv}'?\n\n" +
                    "Svi proizvodi æe biti prebaèeni u originalnu kategoriju.")
            .setPositiveButton("Vrati") { _, _ ->
                // Ukloni custom verziju
                val modifiedName = findModifiedCategoryName(originalKategorija.naziv)
                if (modifiedName != null) {
                    customCategories.removeAll { it.naziv == modifiedName }
                }

                // Ukloni iz shared preferences
                val sharedPref = getSharedPreferences("replaced_categories", Context.MODE_PRIVATE)
                sharedPref.edit().remove(originalKategorija.naziv).apply()

                // Saèuvaj promene
                saveCustomCategories()

                // Ažuriraj proizvode da koriste originalnu kategoriju
                updateProductsToOriginalCategory(originalKategorija, modifiedName)

                Toast.makeText(this, "Kategorija vraæena na original", Toast.LENGTH_SHORT).show()
            }
            .setNegativeButton("Otkaži", null)
            .show()
    }

    /**
     * Pronalazi modifikovano ime kategorije (ako postoji)
     */
    private fun findModifiedCategoryName(originalName: String): String? {
        return customCategories.find {
            it.naziv.startsWith(originalName) && it.naziv != originalName
        }?.naziv
    }

    /**
     * Ažurira proizvode da koriste originalnu kategoriju
     */
    private fun updateProductsToOriginalCategory(original: Kategorija, modifiedName: String?) {
        if (modifiedName != null) {
            val modifiedKategorija = customCategories.find { it.naziv == modifiedName }
            if (modifiedKategorija != null) {
                val staraKategorijaPunNaziv = "${modifiedKategorija.ikona} ${modifiedKategorija.naziv}"
                val novaKategorijaPunNaziv = "${original.ikona} ${original.naziv}"

                repository.sviProizvodi { sviProizvodi ->
                    val proizvodiZaAzuriranje = sviProizvodi.filter {
                        it.kategorija == staraKategorijaPunNaziv
                    }

                    if (proizvodiZaAzuriranje.isEmpty()) {
                        // Nema proizvoda za ažuriranje
                        runOnUiThread {
                            setupAdapter()
                            Toast.makeText(this,
                                "Nema proizvoda u ovoj kategoriji za vraæanje",
                                Toast.LENGTH_SHORT).show()
                        }

                        // Pošalji LOCAL broadcast
                        sendCategoryRestoredBroadcast(novaKategorijaPunNaziv)
                        return@sviProizvodi
                    }

                    var uspesnoAzurirano = 0
                    val ukupnoZaAzuriranje = proizvodiZaAzuriranje.size

                    proizvodiZaAzuriranje.forEach { proizvod ->
                        val azuriranProizvod = proizvod.copy(kategorija = novaKategorijaPunNaziv)
                        repository.azurirajProizvod(azuriranProizvod) { success ->
                            uspesnoAzurirano++

                            Log.d("RestoreCategory",
                                "Ažuriran proizvod: ${proizvod.naziv} ($uspesnoAzurirano/$ukupnoZaAzuriranje)")

                            // Kada su svi ažurirani
                            if (uspesnoAzurirano == ukupnoZaAzuriranje) {
                                runOnUiThread {
                                    setupAdapter()
                                    Toast.makeText(this,
                                        "? Vraæeno $uspesnoAzurirano proizvoda u originalnu kategoriju",
                                        Toast.LENGTH_SHORT).show()
                                }

                                // Pošalji LOCAL broadcast
                                sendCategoryRestoredBroadcast(novaKategorijaPunNaziv)
                            }
                        }
                    }
                }
            }
        } else {
            // Nema modifikovane kategorije
            runOnUiThread {
                setupAdapter()
            }

            // Pošalji LOCAL broadcast
            sendCategoryRestoredBroadcast("${original.ikona} ${original.naziv}")
        }
    }

    /**
     * Pomoæna metoda za slanje LOCAL broadcast-a
     */
    private fun sendCategoryRestoredBroadcast(originalKategorija: String) {
        val intent = Intent("KATEGORIJA_VRAÆENA")
        intent.putExtra("ORIGINAL_KATEGORIJA", originalKategorija)
        LocalBroadcastManager.getInstance(this).sendBroadcast(intent)
        Log.d("RestoreCategory", "? LOCAL broadcast poslat: KATEGORIJA_VRAÆENA - $originalKategorija")
    }

    private fun saveCustomCategories() {
        try {
            val currentUser = FirebaseHelper(this).getCurrentUser()
            val userId = currentUser?.uid ?: "offline_user_${System.currentTimeMillis()}"

            // IZOLACIJA: svaki korisnik ima svoje shared preferences
            val sharedPref = getSharedPreferences("categories_$userId", Context.MODE_PRIVATE)
            val categoriesJson = Gson().toJson(customCategories)

            with(sharedPref.edit()) {
                putString("custom_categories", categoriesJson)
                apply()
            }
            Log.d("KategorijeActivity", "Saèuvano ${customCategories.size} custom kategorija za user: $userId")

        } catch (e: Exception) {
            Log.e("KategorijeActivity", "Greška pri èuvanju kategorija: ${e.message}")
        }
    }

    private fun loadCustomCategories() {
        try {
            val currentUser = FirebaseHelper(this).getCurrentUser()
            val userId = currentUser?.uid ?: "offline_user"

            // IZOLACIJA: uèitaj samo kategorije ovog korisnika
            val sharedPref = getSharedPreferences("categories_$userId", Context.MODE_PRIVATE)
            val categoriesJson = sharedPref.getString("custom_categories", "[]")

            val type = object : TypeToken<MutableList<Kategorija>>() {}.type
            val loadedCategories = Gson().fromJson<MutableList<Kategorija>>(categoriesJson, type)

            if (loadedCategories != null) {
                customCategories.clear()
                customCategories.addAll(loadedCategories)
                Log.d("KategorijeActivity", "Uèitano ${customCategories.size} custom kategorija za user: $userId")
            }

        } catch (e: Exception) {
            Log.e("KategorijeActivity", "Greška pri uèitavanju kategorija: ${e.message}")
        }
    }

    private fun clearCurrentUserData() {
        try {
            val currentUser = FirebaseHelper(this).getCurrentUser()
            val userId = currentUser?.uid ?: "offline_user"

            // Obriši shared preferences za ovog korisnika
            val sharedPref = getSharedPreferences("categories_$userId", Context.MODE_PRIVATE)
            sharedPref.edit().clear().apply()

            Log.d("KategorijeActivity", "Obrisani podaci za user: $userId")
        } catch (e: Exception) {
            Log.e("KategorijeActivity", "Greška pri brisanju podataka: ${e.message}")
        }
    }

    private fun handleKategorijaClick(kategorija: Kategorija) {
        Log.d("KategorijeActivity", "Kliknuta kategorija: ${kategorija.naziv}")
        Log.d("KategorijeActivity", "Kategorija ikona: ${kategorija.ikona}")

        when (kategorija.naziv) {
            "Dodaj proizvod" -> {
                startActivity(Intent(this, DodajIzmeniActivity::class.java))
            }
            "Sve stavke" -> {
                startActivity(Intent(this, MainActivity::class.java).apply {
                    putExtra("FILTER", "ALL")
                })
            }
            "Niska zaliha" -> {
                startActivity(Intent(this, MainActivity::class.java).apply {
                    putExtra("FILTER", "LOW_STOCK")
                })
            }
            else -> {
                // VAŽNO: Šaljemo PUNU kategoriju sa emoji
                val filter = "${kategorija.ikona} ${kategorija.naziv}"
                Log.d("KategorijeActivity", "Šaljem filter: '$filter'")

                startActivity(Intent(this, MainActivity::class.java).apply {
                    putExtra("FILTER", filter)
                })
            }
        }
    }

    override fun onCreateOptionsMenu(menu: Menu): Boolean {
        Log.d("KategorijeActivity", "Kreiranje menija")

        // Ne uèitavaj iz XML-a, kreiraj ruèno
        menu.clear()

        // KORISTITE PRAVE UNICODE KARAKTERE (copy-paste emoji):
        menu.add(0, 1000, 1, "?? Sortiraj kategorije").apply {
            val spannable = android.text.SpannableString(title)
            spannable.setSpan(
                android.text.style.ForegroundColorSpan(Color.BLACK),
                0,
                spannable.length,
                android.text.Spannable.SPAN_EXCLUSIVE_EXCLUSIVE
            )
            title = spannable
        }

        // KOPIRAJTE EMOJI-JE SA OVOG SPISKA:
        // ?? ?? ?? ?? ?? ??

        menu.add(0, 1001, 1, "?? Cloud Sync").apply {
            // Forsiraj crni tekst
            val spannable = android.text.SpannableString(title)
            spannable.setSpan(
                android.text.style.ForegroundColorSpan(Color.BLACK),
                0,
                spannable.length,
                android.text.Spannable.SPAN_EXCLUSIVE_EXCLUSIVE
            )
            // Podebljaj tekst
            spannable.setSpan(
                android.text.style.StyleSpan(android.graphics.Typeface.BOLD),
                0,
                spannable.length,
                android.text.Spannable.SPAN_EXCLUSIVE_EXCLUSIVE
            )
            title = spannable
        }

        menu.add(0, 1002, 2, "?? Oèisti duplikate").apply {
            val spannable = android.text.SpannableString(title)
            spannable.setSpan(
                android.text.style.ForegroundColorSpan(Color.BLACK),
                0,
                spannable.length,
                android.text.Spannable.SPAN_EXCLUSIVE_EXCLUSIVE
            )
            spannable.setSpan(
                android.text.style.StyleSpan(android.graphics.Typeface.BOLD),
                0,
                spannable.length,
                android.text.Spannable.SPAN_EXCLUSIVE_EXCLUSIVE
            )
            title = spannable
        }

        menu.add(0, 1003, 3, "?? Statistike").apply {
            val spannable = android.text.SpannableString(title)
            spannable.setSpan(
                android.text.style.ForegroundColorSpan(Color.BLACK),
                0,
                spannable.length,
                android.text.Spannable.SPAN_EXCLUSIVE_EXCLUSIVE
            )
            spannable.setSpan(
                android.text.style.StyleSpan(android.graphics.Typeface.BOLD),
                0,
                spannable.length,
                android.text.Spannable.SPAN_EXCLUSIVE_EXCLUSIVE
            )
            title = spannable
        }

        menu.add(0, 1004, 4, "?? Odjava").apply {
            val spannable = SpannableString(title)
            spannable.setSpan(
                ForegroundColorSpan(Color.BLACK),
                0,
                spannable.length,
                Spannable.SPAN_EXCLUSIVE_EXCLUSIVE
            )
            spannable.setSpan(
                android.text.style.StyleSpan(android.graphics.Typeface.BOLD),
                0,
                spannable.length,
                android.text.Spannable.SPAN_EXCLUSIVE_EXCLUSIVE
            )
            title = spannable
        }

        menu.add(0, 1005, 5, "?? Lokalni Backup").apply {
            val spannable = android.text.SpannableString(title)
            spannable.setSpan(
                android.text.style.ForegroundColorSpan(Color.BLACK),
                0,
                spannable.length,
                android.text.Spannable.SPAN_EXCLUSIVE_EXCLUSIVE
            )
            title = spannable
        }

        return true
    }

    override fun onOptionsItemSelected(item: MenuItem): Boolean {
        return when (item.itemId) {

            1000 -> { // Sortiraj kategorije
                showSortCategoriesDialog()
                true
            }

            1001 -> { // Cloud Sync
                startActivity(Intent(this, CloudSyncActivity::class.java))
                true
            }
            1002 -> { // Oèisti duplikate
                showCleanDuplicatesDialog()
                true
            }
            1003 -> { // Statistike
                startActivity(Intent(this, StatsActivity::class.java))  // OVO
                true
            }
            1004 -> { // Odjava
                showLogoutDialog()
                true
            }

            1005 -> { // LOKALNI BACKUP - OVO DODAJTE!
                startActivity(Intent(this, BackupRestoreActivity::class.java))
                true
            }
            else -> super.onOptionsItemSelected(item)
        }
    }

    private fun loadCategoriesFromAllSources() {
        // 1. Uèitaj lokalne custom kategorije
        loadCustomCategories()

        // 2. Proveri da li ima podataka u Cloud-u
        val firebaseHelper = FirebaseHelper(this)
        val currentUser = firebaseHelper.getCurrentUser()

        if (currentUser != null) {
            // 3. Uèitaj kategorije iz Cloud-a (ako postoje)
            loadCloudCategories(currentUser.uid)
        } else {
            // Ako nije prijavljen, samo pokaži lokalne
            setupAdapter()
        }
    }

    private fun loadCloudCategories(userId: String) {
        coroutineScope.launch {
            try {
                val firebaseHelper = FirebaseHelper(this@KategorijeActivity)
                val cloudProizvodi = withContext(Dispatchers.IO) {
                    firebaseHelper.restoreFromCloud()
                }

                if (cloudProizvodi.isNotEmpty()) {
                    // 4. Ekstraktuj sve jedinstvene kategorije iz cloud proizvoda
                    val cloudCategories = cloudProizvodi
                        .map { it.kategorija }
                        .distinct()
                        .filter { !isOsnovnaKategorija(it) } // Filtriraj samo custom

                    // 5. Dodaj custom kategorije koje ne postoje lokalno
                    addMissingCategoriesFromCloud(cloudCategories)

                    withContext(Dispatchers.Main) {
                        setupAdapter()
                    }
                } else {
                    setupAdapter()
                }
            } catch (e: Exception) {
                Log.e("KategorijeActivity", "Greška pri uèitavanju cloud kategorija: ${e.message}")
                setupAdapter()
            }
        }
    }

    private fun isOsnovnaKategorija(fullCategory: String): Boolean {
        val categoryName = KategorijeActivity.extractCategoryName(fullCategory)
        return Constants.Kategorije.OSNOVNE.contains(categoryName) ||
                Constants.Kategorije.SVE.contains(categoryName)
    }

    private fun addMissingCategoriesFromCloud(cloudCategories: List<String>) {
        cloudCategories.forEach { fullCategory ->
            try {
                val categoryName = KategorijeActivity.extractCategoryName(fullCategory)
                val emoji = extractEmoji(fullCategory)

                // Proveri da li veæ postoji
                val postoji = customCategories.any { it.naziv == categoryName }

                if (!postoji && !isOsnovnaKategorija(fullCategory)) {
                    // Kreiraj novu kategoriju
                    val novaKategorija = Kategorija(
                        ikona = emoji,
                        naziv = categoryName,
                        boja = getRandomColor()
                    )
                    customCategories.add(novaKategorija)
                }
            } catch (e: Exception) {
                Log.e("KategorijeActivity", "Greška pri dodavanju kategorije: ${e.message}")
            }
        }

        // Saèuvaj ažurirane kategorije
        saveCustomCategories()
    }

    private fun getRandomColor(): Int {
        val boje = listOf(
            R.color.green_light,
            android.R.color.holo_green_light,
            R.color.blue_light,
            android.R.color.holo_blue_light,
            android.R.color.holo_orange_light,
            android.R.color.holo_purple,
            R.color.purple_light,
            android.R.color.holo_red_light
        )
        return boje.random()
    }




    private fun showSortCategoriesDialog() {
        val items = arrayOf(
            "Naziv (A › Z)",
            "Naziv (Z › A)",
            "Po broju proizvoda"
        )

        AlertDialog.Builder(this)
            .setTitle("?? Sortiraj kategorije")
            .setItems(items) { _, which ->
                when (which) {
                    0 -> sortCategoriesByName(true)
                    1 -> sortCategoriesByName(false)
                    2 -> sortCategoriesByProductCount()
                }
            }
            .setNegativeButton("Otkaži", null)
            .show()
    }

    private fun sortCategoriesByProductCount() {
        // Ovo je kompleksnije - treba prebrojati proizvode po kategoriji
        Toast.makeText(this, "Funkcionalnost u razvoju", Toast.LENGTH_SHORT).show()
    }
    private fun sortCategoriesByName(ascending: Boolean) {
        if (ascending) {
            customCategories.sortBy { it.naziv }
        } else {
            customCategories.sortByDescending { it.naziv }
        }
        saveCustomCategories()
        setupAdapter()
        Toast.makeText(this, "Kategorije sortirane", Toast.LENGTH_SHORT).show()
    }
    /**
     * Prikazuje dijalog za odjavu
     */
    private fun showLogoutDialog() {
        AlertDialog.Builder(this)
            .setTitle("?? Odjava")
            .setMessage("Da li ste sigurni da želite da se odjavite?\n\n" +
                    "Napomena: Vaši lokalni podaci æe ostati saèuvani.")
            .setPositiveButton("Odjavi se") { dialog, _ ->
                dialog.dismiss()
                performLogout()
            }
            .setNegativeButton("Otkaži") { dialog, _ ->
                dialog.dismiss()
            }
            .show()
    }


    private fun showCleanDuplicatesDialog() {
        AlertDialog.Builder(this)
            .setTitle("?? Èišæenje duplikata")
            .setMessage("Da li želite da skenirate bazu i obrišete sve duplirane proizvode?\n\n" +
                    "Ova akcija æe:\n" +
                    "1. Pronaæi sve proizvode sa istim nazivom i kategorijom\n" +
                    "2. Zadržati prvi pronaðeni proizvod\n" +
                    "3. Obrisati sve ostale duplikate")
            .setPositiveButton("Skeniraj i oèisti") { dialog, _ ->
                dialog.dismiss()
                startCleaningDuplicates()
            }
            .setNegativeButton("Otkaži") { dialog, _ ->
                dialog.dismiss()
            }
            .setIcon(android.R.drawable.ic_dialog_alert)
            .show()
    }

    /**
     * Pokreæe proces èišæenja duplikata
     */
    private fun startCleaningDuplicates() {
        val progressDialog = ProgressDialog(this).apply {
            setTitle("?? Skeniranje duplikata")
            setMessage("Proveravam bazu podataka...\nMolimo saèekajte.")
            setCancelable(false)
            show()
        }

        repository.proveriIIspraviDuplikate { brojDuplikata ->
            runOnUiThread {
                progressDialog.dismiss()

                if (brojDuplikata > 0) {
                    AlertDialog.Builder(this@KategorijeActivity)
                        .setTitle("? Èišæenje završeno")
                        .setMessage("Obrisano je $brojDuplikata dupliranih proizvoda.")
                        .setPositiveButton("OK") { dialog, _ ->
                            dialog.dismiss()
                            // Osveži prikaz ako je potrebno
                        }
                        .show()
                } else {
                    Toast.makeText(
                        this@KategorijeActivity,
                        "? Nema dupliranih proizvoda u bazi",
                        Toast.LENGTH_LONG
                    ).show()
                }
            }
        }
    }
    private fun performLogout() {
        // Firebase logout
        FirebaseHelper(this).logout()

        Toast.makeText(this, "Uspešno odjavljeni", Toast.LENGTH_SHORT).show()

        // Vrati na LoginActivity
        val intent = Intent(this, LoginActivity::class.java)
        startActivity(intent)
        finish()
    }

    private fun showAddCategoryDialog() {
        val dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_add_category, null)
        val etNaziv = dialogView.findViewById<EditText>(R.id.etNazivKategorije)
        val spEmoji = dialogView.findViewById<Spinner>(R.id.spEmoji)
        val spBoja = dialogView.findViewById<Spinner>(R.id.spBoja)


        // Lista emoji-ja kao Unicode stringovi
        val emojiList = listOf(
            "\uD83C\uDF54", // ?? Hamburger
            "\uD83E\uDD64", // ?? Cup with straw
            "\uD83D\uDCDD", // ?? Memo
            "\uD83D\uDC55", // ?? T-Shirt
            "\uD83E\uDDF9", // ?? Broom
            "\uD83D\uDCF1", // ?? Mobile phone
            "\uD83D\uDECD", // ??? Shopping bags
            "\uD83D\uDCBC", // ?? Briefcase
            "\uD83C\uDF7A", // ?? Beer mug
            "\uD83C\uDF2E", // ?? Taco
            "\uD83C\uDF6A", // ?? Cookie
            "\uD83C\uDF69", // ?? Doughnut
            "\uD83E\uDD5E", // ?? Bread
            "\uD83C\uDF53", // ?? Strawberry
            "\uD83E\uDDC0", // ?? Cheese wedge
            "\uD83D\uDD27", // ?? Wrench
            "\uD83D\uDE9B", // ?? Articulated lorry
            "\uD83D\uDE97", // ?? Automobile
            "\uD83C\uDFA7", // ?? Headphone
            "\uD83D\uDCF7", // ?? Camera
            "\uD83D\uDCBB", // ?? Laptop
            "\uD83D\uDCFA", // ?? Television
            "\uD83D\uDCE6", // ?? Package
            "\uD83D\uDED2", // ?? Shopping cart
            "\uD83D\uDCB0", // ?? Money bag
            "\uD83D\uDCB5", // ?? Dollar banknote
            "\u002B\uFE0F\u20E3", // ? Plus
            "\u2796", // ? Minus
            "\u2705", // ? Check mark
            "\u274C", // ? Cross mark
            "\u2B55", // ? Hollow red circle
            "\uD83D\uDD34", // ?? Red circle
            "\uD83D\uDFE2", // ?? Green circle
            "\uD83D\uDFE1", // ?? Yellow circle
            "\uD83D\uDD35", // ?? Blue circle
            "\uD83D\uDD36"  // ?? Large orange diamond
        )

        // Opisi emoji-ja za prikaz u spinneru
        val emojiOpisi = listOf(
            "?? Hamburger",
            "?? Èaša sa slamkom",
            "?? Beleške",
            "?? Majica",
            "?? Metla",
            "?? Mobilni telefon",
            "??? Shopping torbe",
            "?? Aktovka",
            "?? Èaša piva",
            "?? Tako",
            "?? Keks",
            "?? Krofna",
            "?? Hleb",
            "?? Jagoda",
            "?? Sir",
            "?? Kljuè",
            "?? Kamion",
            "?? Automobil",
            "?? Slušalice",
            "?? Kamera",
            "?? Laptop",
            "?? Televizor",
            "?? Paket",
            "?? Kolica",
            "?? Kesica novca",
            "?? Novèanica",
            "? Plus",
            "? Minus",
            "? Taèno",
            "? Pogrešno",
            "? Krug",
            "?? Crveni krug",
            "?? Zeleni krug",
            "?? Žuti krug",
            "?? Plavi krug",
            "?? Narandžasti dijamant"
        )

        // Lista boja
        val bojeList = listOf(
            "Zelena svetla" to R.color.green_light,
            "Zelena" to android.R.color.holo_green_light,
            "Zelena tamna" to android.R.color.holo_green_dark,
            "Plava svetla" to R.color.blue_light,
            "Plava" to android.R.color.holo_blue_light,
            "Plava tamna" to android.R.color.holo_blue_dark,
            "Narandžasta" to android.R.color.holo_orange_light,
            "Narandžasta tamna" to android.R.color.holo_orange_dark,
            "Ljubièasta" to android.R.color.holo_purple,
            "Ljubièasta svetla" to R.color.purple_light,
            "Crvena" to android.R.color.holo_red_light,
            "Crvena tamna" to android.R.color.holo_red_dark,
            "Siva" to android.R.color.darker_gray,
            "Žuta" to android.R.color.holo_orange_dark,
            "Tirkizna" to android.R.color.holo_blue_bright
        )

        // Postavi adaptere za spinner-e
        val emojiAdapter = ArrayAdapter(this, android.R.layout.simple_spinner_item, emojiOpisi)
        val bojeAdapter = ArrayAdapter(this, android.R.layout.simple_spinner_item, bojeList.map { it.first })

        emojiAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
        bojeAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)

        spEmoji.adapter = emojiAdapter
        spBoja.adapter = bojeAdapter

        AlertDialog.Builder(this)
            .setTitle("Dodaj novu kategoriju")
            .setView(dialogView)
            .setPositiveButton("Dodaj") { _, _ ->
                val naziv = etNaziv.text.toString().trim()
                val emojiIndex = spEmoji.selectedItemPosition
                val emoji = emojiList[emojiIndex] // VAŽNO: Uzmi Unicode iz liste
                val bojaResId = bojeList[spBoja.selectedItemPosition].second

                if (naziv.isEmpty()) {
                    Toast.makeText(this, "Unesite naziv kategorije", Toast.LENGTH_SHORT).show()
                    return@setPositiveButton
                }

                // Proveri da li kategorija veæ postoji
                if (customCategories.any { it.naziv == naziv }) {
                    Toast.makeText(this, "Kategorija veæ postoji", Toast.LENGTH_SHORT).show()
                    return@setPositiveButton
                }

                // Dodaj novu kategoriju
                val novaKategorija = Kategorija(emoji, naziv, bojaResId)
                customCategories.add(novaKategorija)

                // Saèuvaj i osveži
                saveCustomCategories()
                setupAdapter()

                Toast.makeText(this, "Kategorija '$naziv' dodata", Toast.LENGTH_SHORT).show()
            }
            .setNegativeButton("Otkaži", null)
            .show()
    }

    private fun showDeleteSingleCategoryDialog(kategorija: Kategorija) {
        AlertDialog.Builder(this)
            .setTitle("Obriši kategoriju")
            .setMessage("Da li ste sigurni da želite da obrišete '${kategorija.naziv}'?\n\nNapomena: Proizvodi u ovoj kategoriji neæe biti obrisani.")
            .setPositiveButton("Obriši") { _, _ ->
                customCategories.remove(kategorija)
                saveCustomCategories()
                setupAdapter()

                Toast.makeText(this, "Kategorija '${kategorija.naziv}' obrisana", Toast.LENGTH_SHORT).show()
            }
            .setNegativeButton("Otkaži", null)
            .show()
    }

    private fun showDeleteMultipleCategoriesDialog() {
        if (customCategories.isEmpty()) {
            Toast.makeText(this, "Nema custom kategorija za brisanje", Toast.LENGTH_SHORT).show()
            return
        }

        val kategorijeNazivi = customCategories.map { it.naziv }.toTypedArray()
        val checkedItems = BooleanArray(customCategories.size) { false }

        AlertDialog.Builder(this)
            .setTitle("Obriši kategorije")
            .setMultiChoiceItems(kategorijeNazivi, checkedItems) { _, which, isChecked ->
                checkedItems[which] = isChecked
            }
            .setPositiveButton("Obriši oznaèene") { _, _ ->
                val kategorijeZaBrisanje = mutableListOf<Kategorija>()

                for (i in checkedItems.indices) {
                    if (checkedItems[i]) {
                        kategorijeZaBrisanje.add(customCategories[i])
                    }
                }

                if (kategorijeZaBrisanje.isNotEmpty()) {
                    customCategories.removeAll(kategorijeZaBrisanje)
                    saveCustomCategories()
                    setupAdapter()

                    Toast.makeText(this, "Obrisano ${kategorijeZaBrisanje.size} kategorija", Toast.LENGTH_SHORT).show()
                }
            }
            .setNegativeButton("Otkaži", null)
            .show()
    }

    /**
     * Dijalog za editovanje (zamenjivanje) originalne kategorije
     */
    private fun showEditCategoryDialog(oldKategorija: Kategorija) {
        val dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_add_category, null)
        val etNaziv = dialogView.findViewById<EditText>(R.id.etNazivKategorije)
        val spEmoji = dialogView.findViewById<Spinner>(R.id.spEmoji)
        val spBoja = dialogView.findViewById<Spinner>(R.id.spBoja)

        // Postavi postojeæe vrednosti
        etNaziv.setText(oldKategorija.naziv)

        // Lista emoji-ja kao Unicode stringovi
        val emojiList = listOf(
            "\uD83C\uDF54", // ?? Hamburger
            "\uD83E\uDD64", // ?? Cup with straw
            "\uD83D\uDCDD", // ?? Memo
            "\uD83D\uDC55", // ?? T-Shirt
            "\uD83E\uDDF9", // ?? Broom
            "\uD83D\uDCF1", // ?? Mobile phone
            "\uD83D\uDECD", // ??? Shopping bags
            "\uD83D\uDCBC", // ?? Briefcase
            "\uD83C\uDF7A", // ?? Beer mug
            "\uD83C\uDF2E", // ?? Taco
            "\uD83C\uDF6A", // ?? Cookie
            "\uD83C\uDF69", // ?? Doughnut
            "\uD83E\uDD5E", // ?? Bread
            "\uD83C\uDF53", // ?? Strawberry
            "\uD83E\uDDC0", // ?? Cheese wedge
            "\uD83D\uDD27", // ?? Wrench
            "\uD83D\uDE9B", // ?? Articulated lorry
            "\uD83D\uDE97", // ?? Automobile
            "\uD83C\uDFA7", // ?? Headphone
            "\uD83D\uDCF7", // ?? Camera
            "\uD83D\uDCBB", // ?? Laptop
            "\uD83D\uDCFA", // ?? Television
            "\uD83D\uDCE6", // ?? Package
            "\uD83D\uDED2", // ?? Shopping cart
            "\uD83D\uDCB0", // ?? Money bag
            "\uD83D\uDCB5", // ?? Dollar banknote
            "\u002B\uFE0F\u20E3", // ? Plus
            "\u2796", // ? Minus
            "\u2705", // ? Check mark
            "\u274C", // ? Cross mark
            "\u2B55", // ? Hollow red circle
            "\uD83D\uDD34", // ?? Red circle
            "\uD83D\uDFE2", // ?? Green circle
            "\uD83D\uDFE1", // ?? Yellow circle
            "\uD83D\uDD35", // ?? Blue circle
            "\uD83D\uDD36"  // ?? Large orange diamond
        )

        // Opisi emoji-ja za prikaz u spinneru
        val emojiOpisi = listOf(
            "?? Hamburger",
            "?? Èaša sa slamkom",
            "?? Beleške",
            "?? Majica",
            "?? Metla",
            "?? Mobilni telefon",
            "??? Shopping torbe",
            "?? Aktovka",
            "?? Èaša piva",
            "?? Tako",
            "?? Keks",
            "?? Krofna",
            "?? Hleb",
            "?? Jagoda",
            "?? Sir",
            "?? Kljuè",
            "?? Kamion",
            "?? Automobil",
            "?? Slušalice",
            "?? Kamera",
            "?? Laptop",
            "?? Televizor",
            "?? Paket",
            "?? Kolica",
            "?? Kesica novca",
            "?? Novèanica",
            "? Plus",
            "? Minus",
            "? Taèno",
            "? Pogrešno",
            "? Krug",
            "?? Crveni krug",
            "?? Zeleni krug",
            "?? Žuti krug",
            "?? Plavi krug",
            "?? Narandžasti dijamant"
        )
        // Lista boja
        val bojeList = listOf(
            "Zelena svetla" to R.color.green_light,
            "Zelena" to android.R.color.holo_green_light,
            "Zelena tamna" to android.R.color.holo_green_dark,
            "Plava svetla" to R.color.blue_light,
            "Plava" to android.R.color.holo_blue_light,
            "Plava tamna" to android.R.color.holo_blue_dark,
            "Narandžasta" to android.R.color.holo_orange_light,
            "Narandžasta tamna" to android.R.color.holo_orange_dark,
            "Ljubièasta" to android.R.color.holo_purple,
            "Ljubièasta svetla" to R.color.purple_light,
            "Crvena" to android.R.color.holo_red_light,
            "Crvena tamna" to android.R.color.holo_red_dark,
            "Siva" to android.R.color.darker_gray,
            "Žuta" to android.R.color.holo_orange_dark,
            "Tirkizna" to android.R.color.holo_blue_bright
        )

        // Postavi adaptere za spinner-e
        val emojiAdapter = ArrayAdapter(this, android.R.layout.simple_spinner_item, emojiOpisi)
        val bojeAdapter = ArrayAdapter(this, android.R.layout.simple_spinner_item, bojeList.map { it.first })

        emojiAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
        bojeAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)

        spEmoji.adapter = emojiAdapter
        spBoja.adapter = bojeAdapter

        // Selektuj trenutni emoji i boju
        val emojiPosition = emojiList.indexOf(oldKategorija.ikona).takeIf { it >= 0 } ?: 0
        spEmoji.setSelection(emojiPosition)

        // Pronaði indeks boje
        val bojaIndex = bojeList.indexOfFirst { it.second == oldKategorija.boja }
        if (bojaIndex >= 0) {
            spBoja.setSelection(bojaIndex)
        }

        AlertDialog.Builder(this)
            .setTitle("Zameni kategoriju '${oldKategorija.naziv}'")
            .setView(dialogView)
            .setPositiveButton("Zameni") { _, _ ->
                val noviNaziv = etNaziv.text.toString().trim()
                val emojiIndex = spEmoji.selectedItemPosition
                val noviEmoji = emojiList[emojiIndex] // VAŽNO: Uzmi Unicode iz liste
                val novaBoja = bojeList[spBoja.selectedItemPosition].second

                if (noviNaziv.isEmpty()) {
                    Toast.makeText(this, "Unesite naziv kategorije", Toast.LENGTH_SHORT).show()
                    return@setPositiveButton
                }

                if (customCategories.any { it.naziv == noviNaziv }) {
                    Toast.makeText(this, "Kategorija '$noviNaziv' veæ postoji", Toast.LENGTH_SHORT).show()
                    return@setPositiveButton
                }

                if (noviNaziv == oldKategorija.naziv &&
                    noviEmoji == oldKategorija.ikona &&
                    novaBoja == oldKategorija.boja) {
                    Toast.makeText(this, "Niste napravili nikakve promene", Toast.LENGTH_SHORT).show()
                    return@setPositiveButton
                }

                // KREIRAJ NOVU KATEGORIJU
                val novaKategorija = Kategorija(noviEmoji, noviNaziv, novaBoja)
                customCategories.add(novaKategorija)

                // OBELEŽI STARU KATEGORIJU KAO ZAMENJENU
                val sharedPref = getSharedPreferences("replaced_categories", Context.MODE_PRIVATE)
                with(sharedPref.edit()) {
                    putString(oldKategorija.naziv, "$noviEmoji|$noviNaziv|$novaBoja")
                    apply()
                }

                // AŽURIRAJ SVE PROIZVODE
                val staraKategorijaPunNaziv = "${oldKategorija.ikona} ${oldKategorija.naziv}"
                val novaKategorijaPunNaziv = "$noviEmoji $noviNaziv"

                Log.d("EditCategory", "Stara kategorija: '$staraKategorijaPunNaziv'")
                Log.d("EditCategory", "Nova kategorija: '$novaKategorijaPunNaziv'")

                repository.sviProizvodi { sviProizvodi ->
                    var azuriraniProizvodi = 0
                    val proizvodiZaAzuriranje = mutableListOf<Proizvod>()

                    // Pronaði sve proizvode sa starom kategorijom
                    sviProizvodi.forEach { proizvod ->
                        Log.d("EditCategory", "Proveravam proizvod: ${proizvod.naziv}, kategorija: '${proizvod.kategorija}'")

                        // VAŽNO: Proveri da li proizvod ima TAÈNU staru kategoriju
                        if (proizvod.kategorija == staraKategorijaPunNaziv) {
                            Log.d("EditCategory", "Pronaðen proizvod za ažuriranje: ${proizvod.naziv}")
                            val azuriranProizvod = proizvod.copy(
                                kategorija = novaKategorijaPunNaziv
                            )
                            proizvodiZaAzuriranje.add(azuriranProizvod)
                            azuriraniProizvodi++
                        }

                        // DODATNO: Proveri i da li proizvod ima samo naziv bez emoji
                        val kategorijaBezEmoji = extractCategoryName(proizvod.kategorija)
                        if (kategorijaBezEmoji == oldKategorija.naziv && proizvod.kategorija != staraKategorijaPunNaziv) {
                            Log.d("EditCategory", "Pronaðen proizvod sa nazivom bez emoji: ${proizvod.naziv}")
                            val azuriranProizvod = proizvod.copy(
                                kategorija = novaKategorijaPunNaziv
                            )
                            proizvodiZaAzuriranje.add(azuriranProizvod)
                            azuriraniProizvodi++
                        }
                    }

                    // Ažuriraj sve proizvode
                    if (proizvodiZaAzuriranje.isNotEmpty()) {
                        var uspešnoAžurirano = 0
                        proizvodiZaAzuriranje.forEach { azuriranProizvod ->
                            repository.azurirajProizvod(azuriranProizvod) { success ->
                                if (success) {
                                    uspešnoAžurirano++
                                    Log.d("EditCategory",
                                        "Ažuriran proizvod: ${azuriranProizvod.naziv} " +
                                                "($staraKategorijaPunNaziv -> $novaKategorijaPunNaziv)")
                                }

                                // Kada su svi ažurirani, osveži prikaz
                                if (uspešnoAžurirano == proizvodiZaAzuriranje.size) {
                                    runOnUiThread {
                                        // Saèuvaj custom kategorije
                                        saveCustomCategories()

                                        // Osveži prikaz
                                        setupAdapter()

                                        // Prikaži rezultat
                                        val poruka = "Kategorija '${oldKategorija.naziv}' zamenjena sa '$noviNaziv'. " +
                                                "$azuriraniProizvodi proizvoda ažurirano."
                                        Toast.makeText(this, poruka, Toast.LENGTH_LONG).show()

                                        // Pošalji LOCAL broadcast za osvežavanje MainActivity
                                        val intent = Intent("KATEGORIJA_PROMENJENA")
                                        intent.putExtra("STARA_KATEGORIJA", staraKategorijaPunNaziv)
                                        intent.putExtra("NOVA_KATEGORIJA", novaKategorijaPunNaziv)
                                        LocalBroadcastManager.getInstance(this).sendBroadcast(intent)
                                    }
                                }
                            }
                        }
                    } else {
                        runOnUiThread {
                            // Saèuvaj custom kategorije
                            saveCustomCategories()

                            // Nema proizvoda za ažuriranje
                            setupAdapter()
                            Toast.makeText(this,
                                "Kategorija '${oldKategorija.naziv}' zamenjena sa '$noviNaziv'. " +
                                        "Nema proizvoda za ažuriranje.",
                                Toast.LENGTH_LONG).show()

                            // Pošalji LOCAL broadcast za osvežavanje MainActivity
                            val intent = Intent("KATEGORIJA_PROMENJENA")
                            intent.putExtra("STARA_KATEGORIJA", staraKategorijaPunNaziv)
                            intent.putExtra("NOVA_KATEGORIJA", novaKategorijaPunNaziv)
                            LocalBroadcastManager.getInstance(this).sendBroadcast(intent)
                        }
                    }
                }
            }
            .setNegativeButton("Otkaži", null)
            .show()
    }
    /**
     * Pomoæna metoda za ekstrakciju naziva bez emoji
     */
    private fun extractCategoryName(fullCategory: String): String {
        // Ukloni emoji i dodatni whitespace sa poèetka
        return fullCategory.replace(Regex("^[\\p{So}\\s]+"), "").trim()
    }

    // Pomoæna metoda za ekstrakciju naziva bez emoji
    private fun extractNameWithoutEmoji(text: String): String {
        // Ukloni sve emoji i whitespace sa poèetka
        return text.replace(Regex("^[\\p{So}\\s]+"), "").trim()
    }

    // Pomoæna metoda za ekstrakciju emoji iz teksta
    private fun extractEmoji(fullCategory: String): String {
        // Ekstraktuj emoji iz poèetka stringa
        val match = Regex("([\\p{So}])").find(fullCategory)
        return match?.value ?: "??" // Podrazumevana ikona
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\LocalBackupHelper.kt

package com.jovannedeljkovic.superstockgo

import android.content.Context
import android.os.Environment
import android.util.Log
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken
import java.io.*
import java.text.SimpleDateFormat
import java.util.*

class LocalBackupHelper(private val context: Context) {

    companion object {
        private const val BACKUP_DIR = "SuperstockGO_Backups"
        private const val BACKUP_PREFIX = "superstock_backup_"
        private const val BACKUP_EXTENSION = ".json"
    }

    /**
     * Kreira backup svih proizvoda u JSON formatu
     */
    fun createBackup(proizvodi: List<Proizvod>): File? {
        return try {

            // Kreiraj direktorijum za backup
            val backupDir = File(
                Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOCUMENTS),
                BACKUP_DIR
            )

            if (!backupDir.exists()) {
                backupDir.mkdirs()
            }

            // Kreiraj ime fajla sa timestamp-om
            val timestamp = SimpleDateFormat("yyyyMMdd_HHmmss", Locale.getDefault()).format(Date())
            val backupFile = File(backupDir, "${BACKUP_PREFIX}$timestamp$BACKUP_EXTENSION")

            // Konvertuj proizvode u JSON
            val gson = Gson()
            val json = gson.toJson(proizvodi)

            // Saèuvaj u fajl
            FileOutputStream(backupFile).use { fos ->
                fos.write(json.toByteArray())
            }

            Log.d("LocalBackup", "Backup kreiran: ${backupFile.absolutePath}")
            backupFile

        } catch (e: Exception) {
            Log.e("LocalBackup", "Greška pri kreiranju backup-a: ${e.message}")
            null
        }
    }

    /**
     * Uèitava backup iz JSON fajla
     */
    fun restoreFromBackup(backupFile: File): List<Proizvod> {
        return try {
            val json = FileInputStream(backupFile).bufferedReader().use { it.readText() }
            val type = object : TypeToken<List<Proizvod>>() {}.type
            val gson = Gson()
            val proizvodi = gson.fromJson<List<Proizvod>>(json, type)

            Log.d("LocalBackup", "Uèitano ${proizvodi.size} proizvoda iz backup-a")
            proizvodi ?: emptyList()

        } catch (e: Exception) {
            Log.e("LocalBackup", "Greška pri uèitavanju backup-a: ${e.message}")
            emptyList()
        }
    }

    /**
     * Vraæa listu svih dostupnih backup fajlova
     */
    fun getAvailableBackups(): List<File> {
        val backupDir = File(
            Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOCUMENTS),
            BACKUP_DIR
        )

        return if (backupDir.exists() && backupDir.isDirectory) {
            backupDir.listFiles { file ->
                file.name.startsWith(BACKUP_PREFIX) && file.name.endsWith(BACKUP_EXTENSION)
            }?.sortedByDescending { it.lastModified() } ?: emptyList()
        } else {
            emptyList()
        }
    }

    /**
     * Briše stari backup fajlove (zadrži samo poslednjih 10)
     */
    fun cleanupOldBackups() {
        try {
            val backups = getAvailableBackups()
            if (backups.size > 10) {
                backups.drop(10).forEach { it.delete() }
                Log.d("LocalBackup", "Obrisano ${backups.size - 10} starih backup-a")
            }
        } catch (e: Exception) {
            Log.e("LocalBackup", "Greška pri èišæenju backup-a: ${e.message}")
        }
    }


    /**
     * Exportuje podatke u CSV format
     */
    fun exportToCSV(proizvodi: List<Proizvod>): File? {
        return try {
            val exportDir = File(
                Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS),
                "SuperstockGO_Exports"
            )

            if (!exportDir.exists()) {
                exportDir.mkdirs()
            }

            val timestamp = SimpleDateFormat("yyyyMMdd_HHmmss", Locale.getDefault()).format(Date())
            val csvFile = File(exportDir, "superstock_export_$timestamp.csv")

            val csv = StringBuilder()
            // CSV header
            csv.append("ID,Naziv,Kategorija,Kolièina,Datum\n")

            // CSV podaci
            proizvodi.forEach { proizvod ->
                csv.append("${proizvod.id},\"${proizvod.naziv}\",\"${proizvod.kategorija}\",${proizvod.kolicina},${Date()}\n")
            }

            FileOutputStream(csvFile).use { fos ->
                fos.write(csv.toString().toByteArray())
            }

            Log.d("LocalBackup", "CSV export kreiran: ${csvFile.absolutePath}")
            csvFile

        } catch (e: Exception) {
            Log.e("LocalBackup", "Greška pri CSV exportu: ${e.message}")
            null
        }
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\LoginActivity.kt

package com.jovannedeljkovic.superstockgo

import android.content.Context
import android.content.Intent
import android.content.SharedPreferences
import android.os.Bundle
import android.util.Log
import android.widget.Button
import android.widget.EditText
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.firebase.auth.ktx.auth
import com.google.firebase.ktx.Firebase

class LoginActivity : AppCompatActivity() {

    private lateinit var etEmail: EditText
    private lateinit var etPassword: EditText
    private lateinit var btnLogin: Button
    private lateinit var btnRegister: Button
    private lateinit var tvStatus: TextView
    private lateinit var btnContinue: Button
    private lateinit var btnLogout: Button
    private lateinit var tvSwitchUser: TextView

    private lateinit var firebaseHelper: FirebaseHelper
    private lateinit var repository: Repository
    private lateinit var sharedPref: SharedPreferences

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_login)

        firebaseHelper = FirebaseHelper(this)
        repository = Repository(this)
        sharedPref = getSharedPreferences("app_prefs", Context.MODE_PRIVATE)

        // Poveži view-ove
        etEmail = findViewById(R.id.etEmail)
        etPassword = findViewById(R.id.etPassword)
        btnLogin = findViewById(R.id.btnLogin)
        btnRegister = findViewById(R.id.btnRegister)
        tvStatus = findViewById(R.id.tvStatus)
        btnContinue = findViewById(R.id.btnContinue)
        btnLogout = findViewById(R.id.btnLogout)
        tvSwitchUser = findViewById(R.id.tvSwitchUser)

        // Proveri da li treba forsirati logout (ako je korisnik izabrao "Promeni korisnika")
        val forceLogout = sharedPref.getBoolean("force_logout", false)
        if (forceLogout) {
            // Eksplicitno logout
            Firebase.auth.signOut()
            sharedPref.edit().putBoolean("force_logout", false).apply()
            Log.d("LoginActivity", "Forced logout izvršen")
        }

        // Proveri da li treba prikazati login formu odmah
        if (intent.getBooleanExtra("SHOW_LOGIN_FORM", false) || forceLogout) {
            showLoginForm()
            tvStatus.text = "Prijavite se drugim nalogom"
        } else {
            checkCurrentUser()
        }

        btnLogin.setOnClickListener {
            val email = etEmail.text.toString().trim()
            val password = etPassword.text.toString().trim()

            if (email.isEmpty() || password.isEmpty()) {
                Toast.makeText(this, "Unesite email i lozinku", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }

            btnLogin.isEnabled = false
            tvStatus.text = "Prijava u toku..."

            firebaseHelper.login(email, password) { success, message ->
                btnLogin.isEnabled = true

                if (success) {
                    tvStatus.text = "Uspešna prijava!"
                    Toast.makeText(this, "Dobrodošli!", Toast.LENGTH_SHORT).show()

                    // Saèuvaj email za kasnije
                    saveUserEmail(email)

                    // Migriraj stare podatke za ovog korisnika
                    repository.migrirajPodatkeZaTrenutnogKorisnika()

                    // Prebaci na glavnu app
                    startMainApp()
                } else {
                    tvStatus.text = "Greška pri prijavi"
                    Toast.makeText(this, "Greška: $message", Toast.LENGTH_LONG).show()
                }
            }
        }

        btnRegister.setOnClickListener {
            val email = etEmail.text.toString().trim()
            val password = etPassword.text.toString().trim()

            if (email.isEmpty() || password.isEmpty()) {
                Toast.makeText(this, "Unesite email i lozinku", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }

            if (password.length < 6) {
                Toast.makeText(this, "Lozinka mora imati najmanje 6 karaktera", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }

            btnRegister.isEnabled = false
            tvStatus.text = "Registracija u toku..."

            firebaseHelper.register(email, password, "user") { success, message ->
                btnRegister.isEnabled = true

                if (success) {
                    tvStatus.text = "Registracija uspešna!"
                    Toast.makeText(this, "Nalog kreiran. Sada se možete prijaviti.", Toast.LENGTH_LONG).show()

                    // Saèuvaj email za kasnije
                    saveUserEmail(email)

                    // Automatski login nakon registracije
                    firebaseHelper.login(email, password) { loginSuccess, loginMessage ->
                        if (loginSuccess) {
                            // Migriraj stare podatke za novog korisnika
                            repository.migrirajPodatkeZaTrenutnogKorisnika()
                            startMainApp()
                        } else {
                            Toast.makeText(this, "Auto-login greška: $loginMessage", Toast.LENGTH_SHORT).show()
                        }
                    }
                } else {
                    tvStatus.text = "Greška pri registraciji"
                    Toast.makeText(this, "Greška: $message", Toast.LENGTH_LONG).show()
                }
            }
        }

        btnContinue.setOnClickListener {
            startMainApp()
        }

        btnLogout.setOnClickListener {
            showLogoutDialog()
        }

        tvSwitchUser.setOnClickListener {
            showSwitchUserDialog()
        }
    }

    /**
     * Prikazuje login formu (sakriva continue/logout dugmad)
     */
    private fun showLoginForm() {
        etEmail.visibility = EditText.VISIBLE
        etPassword.visibility = EditText.VISIBLE
        btnLogin.visibility = Button.VISIBLE
        btnRegister.visibility = Button.VISIBLE
        btnContinue.visibility = Button.GONE
        btnLogout.visibility = Button.GONE
        tvSwitchUser.visibility = TextView.GONE

        // Obriši polja
        etEmail.text.clear()
        etPassword.text.clear()
        etEmail.requestFocus()
    }

    /**
     * Proverava trenutnog korisnika i podešava UI
     */
    private fun checkCurrentUser() {
        val currentUser = firebaseHelper.getCurrentUser()
        if (currentUser != null) {
            tvStatus.text = "Prijavljen: ${currentUser.email}"

            // Prikaži opciju za nastavak i logout
            btnContinue.text = "NASTAVI KAO ${currentUser.email}"
            btnContinue.visibility = Button.VISIBLE
            btnLogout.visibility = Button.VISIBLE
            tvSwitchUser.visibility = TextView.VISIBLE

            // Sakrij login/register polja
            etEmail.visibility = EditText.GONE
            etPassword.visibility = EditText.GONE
            btnLogin.visibility = Button.GONE
            btnRegister.visibility = Button.GONE

            // Migriraj stare podatke
            repository.migrirajPodatkeZaTrenutnogKorisnika()

            // Saèuvaj email za kasnije
            saveUserEmail(currentUser.email ?: "")
        } else {
            tvStatus.text = "Niste prijavljeni"
            showLoginForm()
        }
    }

    /**
     * Dijalog za logout sa opcijama
     */
    private fun showLogoutDialog() {
        val currentUser = firebaseHelper.getCurrentUser()
        if (currentUser == null) {
            Toast.makeText(this, "Niste prijavljeni", Toast.LENGTH_SHORT).show()
            return
        }

        val options = arrayOf("Odjavi se", "Promeni korisnika", "Otkaži")

        androidx.appcompat.app.AlertDialog.Builder(this)
            .setTitle("Opcije za ${currentUser.email}")
            .setItems(options) { _, which ->
                when (which) {
                    0 -> { // Odjavi se
                        performLogout(false, "Da li ste sigurni da želite da se odjavite?\n\nLokalni podaci æe ostati saèuvani.")
                    }
                    1 -> { // Promeni korisnika
                        performLogout(true, "Da li želite da se odjavite i prijavite drugim korisnikom?\n\nLokalni podaci æe ostati saèuvani.")
                    }
                    // 2 -> Otkaži (ne radi ništa)
                }
            }
            .setNegativeButton("Otkaži", null)
            .show()
    }

    /**
     * Dijalog za promenu korisnika
     */
    private fun showSwitchUserDialog() {
        androidx.appcompat.app.AlertDialog.Builder(this)
            .setTitle("Promena korisnika")
            .setMessage("Da li želite da se prijavite drugim korisnikom?\n\nTrenutni lokalni podaci æe ostati saèuvani.")
            .setPositiveButton("Da, prijavi drugog") { _, _ ->
                // Postavi flag za forsirani logout
                sharedPref.edit().putBoolean("force_logout", true).apply()

                // Eksplicitno logout
                Firebase.auth.signOut()

                // Prikaži login formu
                showLoginForm()
                tvStatus.text = "Prijavite se drugim nalogom"

                Toast.makeText(this, "Prijavite se drugim nalogom", Toast.LENGTH_SHORT).show()
            }
            .setNegativeButton("Ne", null)
            .show()
    }

    /**
     * Izvršava logout sa potvrdom
     */
    private fun performLogout(changeUser: Boolean, message: String) {
        androidx.appcompat.app.AlertDialog.Builder(this)
            .setTitle(if (changeUser) "Promena korisnika" else "Odjava")
            .setMessage(message)
            .setPositiveButton("Da") { _, _ ->
                // Ako želi promenu korisnika, postavi flag
                if (changeUser) {
                    sharedPref.edit().putBoolean("force_logout", true).apply()
                }

                // Firebase logout
                Firebase.auth.signOut()

                // Obriši shared preferences za trenutnog korisnika
                clearCurrentUserData()

                Toast.makeText(this,
                    if (changeUser) "Uspešno odjavljeni. Prijavite se drugim nalogom."
                    else "Uspešno odjavljeni",
                    Toast.LENGTH_SHORT).show()

                if (changeUser) {
                    // Prikaži login formu za drugog korisnika
                    showLoginForm()
                    tvStatus.text = "Prijavite se drugim nalogom"
                } else {
                    // Vrati na poèetno stanje
                    checkCurrentUser()
                }
            }
            .setNegativeButton("Ne", null)
            .show()
    }

    /**
     * Briše podatke trenutnog korisnika
     */
    private fun clearCurrentUserData() {
        try {
            val currentUser = firebaseHelper.getCurrentUser()
            val userId = currentUser?.uid ?: return

            // Obriši shared preferences za ovog korisnika
            val prefNames = listOf(
                "categories_$userId",
                "replaced_categories",
                "user_$userId"
            )

            prefNames.forEach { prefName ->
                getSharedPreferences(prefName, Context.MODE_PRIVATE)
                    .edit()
                    .clear()
                    .apply()
            }

            Log.d("LoginActivity", "Podaci obrisani za user: $userId")
        } catch (e: Exception) {
            Log.e("LoginActivity", "Greška pri brisanju podataka: ${e.message}")
        }
    }

    /**
     * Saèuva email korisnika za kasnije korišæenje
     */
    private fun saveUserEmail(email: String) {
        if (email.isNotEmpty()) {
            // Saèuvaj u listu prethodnih naloga
            val savedAccounts = sharedPref.getStringSet("saved_accounts", mutableSetOf()) ?: mutableSetOf()
            savedAccounts.add(email)
            sharedPref.edit().putStringSet("saved_accounts", savedAccounts).apply()

            // Saèuvaj poslednji korišæeni email
            sharedPref.edit().putString("last_email", email).apply()

            Log.d("LoginActivity", "Email saèuvan: $email")
        }
    }

    private fun startMainApp() {
        val intent = Intent(this, KategorijeActivity::class.java)
        startActivity(intent)
        finish() // Zatvori LoginActivity
    }

    override fun onStart() {
        super.onStart()
        // Proveri status pri svakom otvaranju (ako nismo veæ u onCreate)
        if (!::etEmail.isInitialized) {
            return
        }

        val forceLogout = sharedPref.getBoolean("force_logout", false)
        if (!forceLogout) {
            checkCurrentUser()
        }
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\LokalnaBazaHelper.kt

// app\src\main\java\com\jovannedeljkovic\superstockgo\LokalnaBazaHelper.kt
package com.jovannedeljkovic.superstockgo

import android.content.ContentValues
import android.content.Context
import android.database.sqlite.SQLiteDatabase
import android.database.sqlite.SQLiteOpenHelper
import android.util.Log

class LokalnaBazaHelper(context: Context) : SQLiteOpenHelper(context, "lokalna_baza.db", null, 1) {

    companion object {
        private const val TABLE_NAME = "proizvodi"
        private const val COLUMN_ID = "id"
        private const val COLUMN_NAZIV = "naziv"
        private const val COLUMN_KATEGORIJA = "kategorija"
        private const val COLUMN_KOLICINA = "kolicina"
    }

    override fun onCreate(db: SQLiteDatabase) {
        val createTable = """
            CREATE TABLE $TABLE_NAME (
                $COLUMN_ID INTEGER PRIMARY KEY AUTOINCREMENT,
                $COLUMN_NAZIV TEXT NOT NULL,
                $COLUMN_KATEGORIJA TEXT NOT NULL,
                $COLUMN_KOLICINA INTEGER DEFAULT 0
            )
        """.trimIndent()
        db.execSQL(createTable)
        Log.d("LokalnaBazaHelper", "Tabela kreirana")
    }

    override fun onUpgrade(db: SQLiteDatabase, oldVersion: Int, newVersion: Int) {
        db.execSQL("DROP TABLE IF EXISTS $TABLE_NAME")
        onCreate(db)
    }

    fun dodajProizvod(proizvod: Proizvod): Long {
        val db = writableDatabase
        val values = ContentValues().apply {
            put(COLUMN_NAZIV, proizvod.naziv)
            put(COLUMN_KATEGORIJA, proizvod.kategorija)
            put(COLUMN_KOLICINA, proizvod.kolicina)
        }
        val id = db.insert(TABLE_NAME, null, values)
        Log.d("LokalnaBazaHelper", "Dodat proizvod ID: $id")
        return id
    }

    fun sviProizvodi(): List<Proizvod> {
        val proizvodi = mutableListOf<Proizvod>()
        val db = readableDatabase
        val cursor = db.rawQuery("SELECT * FROM $TABLE_NAME", null)

        cursor.use {
            while (it.moveToNext()) {
                val id = it.getInt(it.getColumnIndexOrThrow(COLUMN_ID))
                val naziv = it.getString(it.getColumnIndexOrThrow(COLUMN_NAZIV))
                val kategorija = it.getString(it.getColumnIndexOrThrow(COLUMN_KATEGORIJA))
                val kolicina = it.getInt(it.getColumnIndexOrThrow(COLUMN_KOLICINA))

                proizvodi.add(Proizvod(id, naziv, kategorija, kolicina))
            }
        }

        Log.d("LokalnaBazaHelper", "Uèitano ${proizvodi.size} proizvoda")
        return proizvodi
    }

    fun azurirajProizvod(proizvod: Proizvod): Int {
        val db = writableDatabase
        val values = ContentValues().apply {
            put(COLUMN_NAZIV, proizvod.naziv)
            put(COLUMN_KATEGORIJA, proizvod.kategorija)
            put(COLUMN_KOLICINA, proizvod.kolicina)
        }
        return db.update(
            TABLE_NAME,
            values,
            "$COLUMN_ID = ?",
            arrayOf(proizvod.id.toString())
        )
    }

    fun obrisiProizvod(id: Int): Int {
        val db = writableDatabase
        return db.delete(TABLE_NAME, "$COLUMN_ID = ?", arrayOf(id.toString()))
    }

    fun pronadjiProizvod(id: Int): Proizvod? {
        val db = readableDatabase
        val cursor = db.query(
            TABLE_NAME,
            null,
            "$COLUMN_ID = ?",
            arrayOf(id.toString()),
            null, null, null
        )

        cursor.use {
            if (it.moveToFirst()) {
                return Proizvod(
                    id = it.getInt(it.getColumnIndexOrThrow(COLUMN_ID)),
                    naziv = it.getString(it.getColumnIndexOrThrow(COLUMN_NAZIV)),
                    kategorija = it.getString(it.getColumnIndexOrThrow(COLUMN_KATEGORIJA)),
                    kolicina = it.getInt(it.getColumnIndexOrThrow(COLUMN_KOLICINA))
                )
            }
        }
        return null
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\MainActivity.kt

package com.jovannedeljkovic.superstockgo

import android.Manifest
import android.app.NotificationChannel
import android.app.NotificationManager
import android.app.PendingIntent
import android.app.ProgressDialog
import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.content.IntentFilter
import android.content.pm.PackageManager
import android.graphics.Color
import android.os.Build
import android.os.Bundle
import android.os.Handler
import android.os.Looper
import android.telephony.SmsManager
import android.util.Log
import android.widget.PopupMenu
import android.widget.Toast
import androidx.appcompat.app.AlertDialog
import androidx.appcompat.app.AppCompatActivity
import androidx.appcompat.widget.Toolbar
import androidx.core.app.ActivityCompat
import androidx.core.app.NotificationCompat
import androidx.core.app.NotificationManagerCompat
import androidx.core.content.ContextCompat
import androidx.localbroadcastmanager.content.LocalBroadcastManager
import androidx.recyclerview.widget.GridLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.google.android.material.floatingactionbutton.FloatingActionButton
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale
import android.view.MenuItem

class MainActivity : AppCompatActivity() {

    private lateinit var repository: Repository
    private lateinit var recyclerView: RecyclerView
    private lateinit var adapter: ProizvodAdapter
    private var trenutniFilter: String = "ALL"
    private var trenutniSort: String = "name_asc"

    // Broadcast receiver-i - samo LocalBroadcastManager
    private lateinit var dataChangeReceiver: BroadcastReceiver
    private lateinit var dataSyncReceiver: BroadcastReceiver
    private lateinit var categoryChangeReceiver: BroadcastReceiver

    // Firebase helper
    private lateinit var firebaseHelper: FirebaseHelper

    companion object {
        private const val REQUEST_ADD_PRODUCT = 1001
        private const val REQUEST_EDIT_PRODUCT = 1002
        private const val SMS_PERMISSION_CODE = 100
        private const val NOTIFICATION_PERMISSION_CODE = 200
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        // ========== TOOLBAR SETUP ==========
        val toolbar: Toolbar = findViewById(R.id.toolbar)
        setSupportActionBar(toolbar)

        // Postavi naslove
        trenutniFilter = intent.getStringExtra("FILTER") ?: "ALL"
        val naslov = when (trenutniFilter) {
            "ALL" -> "?? Sve stavke"
            "LOW_STOCK" -> "?? Niska zaliha"
            else -> {
                val filterBezEmoji = extractNameWithoutEmoji(trenutniFilter)
                "?? $filterBezEmoji"
            }
        }

        supportActionBar?.title = naslov
        supportActionBar?.setDisplayHomeAsUpEnabled(true)

        // Postavi subtitle
        repository = Repository(this)
        firebaseHelper = FirebaseHelper(this)
        val currentUser = firebaseHelper.getCurrentUser()
        if (currentUser != null) {
            supportActionBar?.subtitle = "${getEmoji("cloud")} ${currentUser.email}"
        } else {
            supportActionBar?.subtitle = "?\uFE0F Offline mod"
        }

        // ========== INICIJALIZACIJA ==========
        recyclerView = findViewById(R.id.recyclerView)
        recyclerView.layoutManager = GridLayoutManager(this, 2)

        // Inicijalizuj adapter
        adapter = ProizvodAdapter(
            proizvodi = emptyList(),
            onEditClick = { proizvod ->
                val intent = Intent(this, DodajIzmeniActivity::class.java)
                intent.putExtra("PROIZVOD_ID", proizvod.id)
                startActivityForResult(intent, REQUEST_EDIT_PRODUCT)
            },
            onDeleteClick = { proizvod ->
                showDeleteConfirmationDialog(proizvod)
            },
            onPlusClick = { proizvod ->
                handlePlusClick(proizvod)
            },
            onMinusClick = { proizvod ->
                handleMinusClick(proizvod)
            }
        )

        recyclerView.adapter = adapter

        // Dugme za dodavanje novog proizvoda
        val fabAdd: FloatingActionButton = findViewById(R.id.fabAdd)
        fabAdd.setOnClickListener {
            val intent = Intent(this, DodajIzmeniActivity::class.java)
            if (trenutniFilter != "ALL" && trenutniFilter != "LOW_STOCK") {
                intent.putExtra("KATEGORIJA", trenutniFilter)
            }
            startActivityForResult(intent, REQUEST_ADD_PRODUCT)
        }

        // Inicijalizuj BroadcastReceiver-e za LOCAL broadcast
        initLocalBroadcastReceivers()

        // Registruj Local BroadcastReceiver-e
        registerLocalReceivers()

        // Uèitaj podatke
        osveziPodatke()

        // Proveri dozvole
        checkSmsPermission()
        checkNotificationPermission()

        Log.d("MainActivity", "? MainActivity onCreate završen")
    }

    private fun getEmoji(type: String): String {
        return when(type) {
            "cloud" -> "??"  // Kopirajte emoji direktno ovde
            "offline" -> "??" // Kopirajte emoji direktno ovde
            else -> "??"
        }
    }
    private fun initLocalBroadcastReceivers() {
        dataChangeReceiver = object : BroadcastReceiver() {
            override fun onReceive(context: Context?, intent: Intent?) {
                Log.d("MainActivity", "\uD83D\uDCE1 LOCAL Broadcast primljen - PROIZVOD promenjen")
                osveziPodatke()
            }
        }

        dataSyncReceiver = object : BroadcastReceiver() {
            override fun onReceive(context: Context?, intent: Intent?) {
                Log.d("MainActivity", "\uD83D\uDCE1 LOCAL Broadcast primljen - PODACI osveženi")
                osveziPodatke()
                Toast.makeText(this@MainActivity,
                    "Podaci su sinhronizovani sa Cloud-om",
                    Toast.LENGTH_SHORT).show()
            }
        }

        categoryChangeReceiver = object : BroadcastReceiver() {
            override fun onReceive(context: Context?, intent: Intent?) {
                Log.d("MainActivity", "?? LOCAL Broadcast primljen - KATEGORIJA promenjena/vraæena")
                Log.d("MainActivity", "Action: ${intent?.action}")
                Log.d("MainActivity", "Extra ORIGINAL_KATEGORIJA: ${intent?.getStringExtra("ORIGINAL_KATEGORIJA")}")
                Log.d("MainActivity", "Extra STARA_KATEGORIJA: ${intent?.getStringExtra("STARA_KATEGORIJA")}")
                Log.d("MainActivity", "Extra NOVA_KATEGORIJA: ${intent?.getStringExtra("NOVA_KATEGORIJA")}")

                osveziPodatke()
            }
        }
    }

    private fun registerLocalReceivers() {
        val localBroadcastManager = LocalBroadcastManager.getInstance(this)

        try {
            // Registruj sve receiver-e preko LocalBroadcastManager
            localBroadcastManager.registerReceiver(
                dataChangeReceiver,
                IntentFilter("PROIZVOD_DODAT")
            )

            localBroadcastManager.registerReceiver(
                dataSyncReceiver,
                IntentFilter("PODACI_OSVEŽENI")
            )

            localBroadcastManager.registerReceiver(
                categoryChangeReceiver,
                IntentFilter("KATEGORIJA_PROMENJENA")
            )

            localBroadcastManager.registerReceiver(
                categoryChangeReceiver,  // VAŽNO: Ovo je ista metoda
                IntentFilter("KATEGORIJA_VRAÆENA")
            )

            Log.d("MainActivity", "? LOCAL Broadcast receiveri registrovani")

        } catch (e: Exception) {
            Log.e("MainActivity", "? Greška pri registraciji LOCAL receivera: ${e.message}")
        }
    }



    override fun onCreateOptionsMenu(menu: android.view.Menu): Boolean {
        menuInflater.inflate(R.menu.menu_main, menu)

        if (firebaseHelper.getCurrentUser() != null) {
            // KOPIRAJTE EMOJI: ??
            menu.add(0, 998, 1, "?? Cloud Sync")
        }

        // KOPIRAJTE EMOJI: ??
        menu.add(0, 999, 2, "?? Oèisti duplikate")

        return true
    }

    override fun onOptionsItemSelected(item: android.view.MenuItem): Boolean {
        return when (item.itemId) {
            R.id.menu_sort -> {
                showSortPopupMenu()
                true
            }
            998 -> {
                startActivity(Intent(this, CloudSyncActivity::class.java))
                true
            }
            999 -> {
                showCleanDuplicatesDialog()
                true
            }
            android.R.id.home -> {
                finish()
                true
            }
            else -> super.onOptionsItemSelected(item)
        }
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)
        if ((requestCode == REQUEST_ADD_PRODUCT || requestCode == REQUEST_EDIT_PRODUCT)
            && resultCode == RESULT_OK) {
            Handler(Looper.getMainLooper()).postDelayed({
                osveziPodatke()
            }, 300)
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        try {
            // Deregistruj sve LOCAL receiver-e
            val localBroadcastManager = LocalBroadcastManager.getInstance(this)
            localBroadcastManager.unregisterReceiver(dataChangeReceiver)
            localBroadcastManager.unregisterReceiver(dataSyncReceiver)
            localBroadcastManager.unregisterReceiver(categoryChangeReceiver)

            Log.d("MainActivity", "? LOCAL Broadcast receiveri deregistrovani")
        } catch (e: Exception) {
            Log.e("MainActivity", "? Greška pri deregistraciji LOCAL receivera: ${e.message}")
        }
    }

    private fun showSortPopupMenu() {
        val items = arrayOf(
            "Naziv (A -> Z)",
            "Naziv (Z -> A)",
            "Kolièina (manje -> više)",
            "Kolièina (više -> manje)",
            "Po kategoriji"
        )

        AlertDialog.Builder(this)
            .setTitle("Sortiraj po")
            .setItems(items) { _, which ->
                when (which) {
                    0 -> { trenutniSort = "name_asc" }
                    1 -> { trenutniSort = "name_desc" }
                    2 -> { trenutniSort = "quantity_asc" }
                    3 -> { trenutniSort = "quantity_desc" }
                    4 -> { trenutniSort = "category" }
                }
                osveziPodatke()
                Toast.makeText(this, "Sortirano: ${items[which]}", Toast.LENGTH_SHORT).show()
            }
            .setNegativeButton("Otkaži", null)
            .show()
    }

    private fun showCleanDuplicatesDialog() {
        AlertDialog.Builder(this)
            .setTitle("\uD83E\uDDF9 Èišæenje duplikata")
            .setMessage("Da li želite da skenirate bazu i obrišete sve duplirane proizvode?")
            .setPositiveButton("Skeniraj i oèisti") { dialog, _ ->
                dialog.dismiss()
                cleanDuplicates()
            }
            .setNegativeButton("Otkaži") { dialog, _ ->
                dialog.dismiss()
            }
            .show()
    }

    override fun onSupportNavigateUp(): Boolean {
        finish()
        return true
    }

    override fun onResume() {
        super.onResume()
        Log.d("MainActivity", "?? onResume - osvežavam podatke")
        osveziPodatke()
    }

    /**
     * Forsirano osvežavanje svih aktivnosti
     */
    private fun forceRefreshAllActivities() {
        // Pošalji sve relevantne broadcast-ove
        val intent1 = Intent("PODACI_OSVEŽENI")
        LocalBroadcastManager.getInstance(this).sendBroadcast(intent1)

        val intent2 = Intent("PROIZVOD_DODAT")
        LocalBroadcastManager.getInstance(this).sendBroadcast(intent2)

        val intent3 = Intent("KATEGORIJA_PROMENJENA")
        LocalBroadcastManager.getInstance(this).sendBroadcast(intent3)

        Log.d("KategorijeActivity", "? Svi broadcast-ovi poslati za osvežavanje")
    }
    private fun osveziPodatke() {
        repository.sviProizvodi { proizvodi ->
            val filtrirani = filtriraniProizvodi(proizvodi)
            val sortirani = sortirajProizvode(filtrirani)

            runOnUiThread {
                adapter.updateData(sortirani)
                if (sortirani.isEmpty()) {
                    showEmptyStateMessage()
                }
            }
        }
    }

    private fun showEmptyStateMessage() {
        val message = when (trenutniFilter) {
            "ALL" -> "Nema proizvoda. Dodajte prvi proizvod!"
            "LOW_STOCK" -> "Nema proizvoda sa niskom zalihom. Odlièno! ?"
            else -> "Nema proizvoda u ovoj kategoriji."
        }
        Toast.makeText(this, message, Toast.LENGTH_SHORT).show()
    }

    private fun filtriraniProizvodi(proizvodi: List<Proizvod>): List<Proizvod> {
        return when {
            trenutniFilter == "ALL" -> proizvodi
            trenutniFilter == "LOW_STOCK" -> proizvodi.filter { it.kolicina <= 5 }
            else -> {
                val filterBezEmoji = extractNameWithoutEmoji(trenutniFilter)
                proizvodi.filter { proizvod ->
                    val proizvodBezEmoji = extractNameWithoutEmoji(proizvod.kategorija)
                    proizvodBezEmoji == filterBezEmoji ||
                            proizvod.kategorija.contains(trenutniFilter) ||
                            proizvodBezEmoji.contains(filterBezEmoji)
                }
            }
        }
    }

    private fun sortirajProizvode(proizvodi: List<Proizvod>): List<Proizvod> {
        return when (trenutniSort) {
            "name_asc" -> proizvodi.sortedBy { it.naziv }
            "name_desc" -> proizvodi.sortedByDescending { it.naziv }
            "quantity_asc" -> proizvodi.sortedBy { it.kolicina }
            "quantity_desc" -> proizvodi.sortedByDescending { it.kolicina }
            "category" -> proizvodi.sortedBy { it.kategorija }
            else -> proizvodi.sortedBy { it.naziv }
        }
    }

    private fun extractNameWithoutEmoji(text: String): String {
        return text.replace(Regex("^[\\p{So}\\s]+"), "").trim()
    }

    private fun showDeleteConfirmationDialog(proizvod: Proizvod) {
        AlertDialog.Builder(this)
            .setTitle("Brisanje proizvoda")
            .setMessage("Da li ste sigurni da želite da obrišete '${proizvod.naziv}'?\n\n" +
                    "\uD83D\uDDD1\uFE0F PROIZVOD ÆE BITI OBRISAN SAMO LOKALNO.\n" +
                    "Za brisanje iz Cloud-a koristite Cloud Sync opciju.")
            .setPositiveButton("Obriši lokalno") { _, _ ->
                repository.obrisiProizvod(proizvod) { success ->
                    runOnUiThread {
                        if (success) {
                            Toast.makeText(this,
                                "\uD83D\uDDD1\uFE0F Proizvod '${proizvod.naziv}' je obrisan LOKALNO",
                                Toast.LENGTH_SHORT).show()
                            osveziPodatke()

                            // Pošalji LOCAL broadcast
                            val intent = Intent("PROIZVOD_DODAT")
                            LocalBroadcastManager.getInstance(this).sendBroadcast(intent)
                        } else {
                            Toast.makeText(this, "?\uFE0F Greška pri brisanju", Toast.LENGTH_SHORT).show()
                        }
                    }
                }
            }
            .setNegativeButton("Otkaži", null)
            .show()
    }

    private fun handlePlusClick(proizvod: Proizvod) {
        Log.d("MainActivity", "[PLUS] Klik za: ${proizvod.naziv}")

        val novaKolicina = proizvod.kolicina + 1
        val azuriranProizvod = proizvod.copy(kolicina = novaKolicina)

        repository.azurirajProizvod(azuriranProizvod) { success ->
            runOnUiThread {
                if (success) {
                    Toast.makeText(this@MainActivity,
                        "\uD83D\uDD3C Kolièina za '${proizvod.naziv}' poveæana na $novaKolicina",
                        Toast.LENGTH_SHORT).show()
                    osveziPodatke()

                    // Pošalji LOCAL broadcast
                    val intent = Intent("PROIZVOD_DODAT")
                    LocalBroadcastManager.getInstance(this).sendBroadcast(intent)
                } else {
                    Toast.makeText(this@MainActivity,
                        "\uD83C\uDFE0 Saèuvano samo lokalno",
                        Toast.LENGTH_SHORT).show()
                }
            }
        }
    }

    private fun handleMinusClick(proizvod: Proizvod) {
        Log.d("MainActivity", "[MINUS] Klik za: ${proizvod.naziv}")

        if (proizvod.kolicina > 0) {
            val novaKolicina = proizvod.kolicina - 1
            val azuriranProizvod = proizvod.copy(kolicina = novaKolicina)

            repository.azurirajProizvod(azuriranProizvod) { success ->
                runOnUiThread {
                    if (success) {
                        if (novaKolicina == 0) {
                            Toast.makeText(this@MainActivity,
                                "${EmojiHelper.forToast("warning")} Kolièina za '${proizvod.naziv}' je sada 0!",
                                Toast.LENGTH_LONG).show()
                            posaljiSMSObavestenje(proizvod.naziv, novaKolicina, proizvod.kategorija)
                            pokusajLokalnuNotifikaciju(proizvod)
                        } else {
                            Toast.makeText(this@MainActivity,
                                "\uD83D\uDD3D Kolièina za '${proizvod.naziv}' smanjena na $novaKolicina",
                                Toast.LENGTH_SHORT).show()
                        }
                        osveziPodatke()

                        // Pošalji LOCAL broadcast
                        val intent = Intent("PROIZVOD_DODAT")
                        LocalBroadcastManager.getInstance(this).sendBroadcast(intent)
                    } else {
                        Toast.makeText(this@MainActivity,
                            "\uD83C\uDFE0 Saèuvano samo lokalno",
                            Toast.LENGTH_SHORT).show()
                    }
                }
            }
        } else {
            Toast.makeText(this, "Kolièina je veæ 0", Toast.LENGTH_SHORT).show()
        }
    }

    private fun cleanDuplicates() {
        val progressDialog = ProgressDialog(this).apply {
            setTitle("? Skeniranje duplikata")
            setMessage("Proveravam bazu podataka...")
            setCancelable(false)
            show()
        }

        repository.proveriIIspraviDuplikate { brojDuplikata ->
            runOnUiThread {
                progressDialog.dismiss()
                if (brojDuplikata > 0) {
                    AlertDialog.Builder(this@MainActivity)
                        .setTitle("\uD83E\uDDF9? Èišæenje završeno")
                        .setMessage("Obrisano je $brojDuplikata dupliranih proizvoda.")
                        .setPositiveButton("OK") { dialog, _ ->
                            dialog.dismiss()
                            osveziPodatke()

                            // Pošalji LOCAL broadcast
                            val intent = Intent("PODACI_OSVEŽENI")
                            LocalBroadcastManager.getInstance(this@MainActivity).sendBroadcast(intent)
                        }
                        .show()
                } else {
                    Toast.makeText(
                        this@MainActivity,
                        "\uD83C\uDFC6 Nema dupliranih proizvoda u bazi podataka",
                        Toast.LENGTH_LONG
                    ).show()
                }
            }
        }
    }

    private fun checkSmsPermission() {
        if (ContextCompat.checkSelfPermission(
                this,
                Manifest.permission.SEND_SMS
            ) != PackageManager.PERMISSION_GRANTED
        ) {
            ActivityCompat.requestPermissions(
                this,
                arrayOf(Manifest.permission.SEND_SMS),
                SMS_PERMISSION_CODE
            )
        }
    }

    private fun checkNotificationPermission() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            if (ContextCompat.checkSelfPermission(
                    this,
                    Manifest.permission.POST_NOTIFICATIONS
                ) != PackageManager.PERMISSION_GRANTED
            ) {
                ActivityCompat.requestPermissions(
                    this,
                    arrayOf(Manifest.permission.POST_NOTIFICATIONS),
                    NOTIFICATION_PERMISSION_CODE
                )
            }
        }
    }

    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray
    ) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)
        when (requestCode) {
            SMS_PERMISSION_CODE -> {
                if (grantResults.isNotEmpty() && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                    Toast.makeText(this, "?\uFE0F? SMS dozvola odobrena", Toast.LENGTH_SHORT).show()
                } else {
                    Toast.makeText(this, "? SMS dozvola odbijena", Toast.LENGTH_LONG).show()
                }
            }
        }
    }

    private fun posaljiSMSObavestenje(nazivProizvoda: String, kolicina: Int, kategorija: String) {
        if (ContextCompat.checkSelfPermission(
                this,
                Manifest.permission.SEND_SMS
            ) == PackageManager.PERMISSION_GRANTED
        ) {
            try {
                val SMS_PHONE_NUMBER = "+381646361287"
                val vreme = SimpleDateFormat("dd.MM.yyyy HH:mm", Locale.getDefault()).format(Date())

                // Ekstraktuj emoji iz kategorije
                val emojiRegex = Regex("([\\p{So}])")
                val emojiMatch = emojiRegex.find(kategorija)
                val emoji = emojiMatch?.value ?: "?"

                // Èisti naziv bez emoji
                val cleanCategory = extractNameWithoutEmoji(kategorija)

                val poruka = """
            ?? SuperstockGO UPOZORENJE!
            Proizvod: $nazivProizvoda
            Kategorija: $emoji $cleanCategory
            Kolièina: $kolicina
            Vreme: $vreme
            
            HITNO: Proizvod je ponestao!
            """.trimIndent()

                val smsManager = SmsManager.getDefault()
                val parts = smsManager.divideMessage(poruka)

                smsManager.sendMultipartTextMessage(
                    SMS_PHONE_NUMBER,
                    null,
                    parts,
                    null,
                    null
                )

                Log.d("SMS", "SMS uspešno poslat!")
                Toast.makeText(this, "\uD83D\uDCE8 SMS obaveštenje poslato", Toast.LENGTH_LONG).show()

            } catch (e: Exception) {
                Log.e("SMS", "Greška pri slanju SMS: ${e.message}")
            }
        } else {
            Toast.makeText(this, "Potrebna dozvola za SMS", Toast.LENGTH_SHORT).show()
        }
    }

    private fun pokusajLokalnuNotifikaciju(proizvod: Proizvod) {
        try {
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                if (ContextCompat.checkSelfPermission(
                        this,
                        Manifest.permission.POST_NOTIFICATIONS
                    ) != PackageManager.PERMISSION_GRANTED
                ) {
                    return
                }
            }

            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                val channel = NotificationChannel(
                    "low_stock_channel",
                    "Niska zaliha",
                    NotificationManager.IMPORTANCE_HIGH
                ).apply {
                    description = "Obaveštenja o niskoj zalihi proizvoda"
                    enableVibration(true)
                    vibrationPattern = longArrayOf(0, 500, 200, 500)
                }

                val notificationManager = getSystemService(NotificationManager::class.java)
                notificationManager.createNotificationChannel(channel)
            }

            val intent = Intent(this, MainActivity::class.java).apply {
                flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK
                putExtra("FILTER", "LOW_STOCK")
            }

            val pendingIntent = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                PendingIntent.getActivity(
                    this,
                    0,
                    intent,
                    PendingIntent.FLAG_IMMUTABLE or PendingIntent.FLAG_UPDATE_CURRENT
                )
            } else {
                PendingIntent.getActivity(
                    this,
                    0,
                    intent,
                    PendingIntent.FLAG_UPDATE_CURRENT
                )
            }

            val notification = NotificationCompat.Builder(this, "low_stock_channel")
                .setSmallIcon(R.mipmap.ic_launcher)
                .setContentTitle("\uD83D\uDEA8 SuperstockGO Upozorenje!")
                .setContentText("Proizvod '${proizvod.naziv}' je ponestao!")
                .setStyle(NotificationCompat.BigTextStyle()
                    .bigText("Proizvod: ${proizvod.naziv}\nKategorija: ${extractNameWithoutEmoji(proizvod.kategorija)}\nKolièina: ${proizvod.kolicina}\n\nHITNO: Dodajte novu zalihu!"))
                .setPriority(NotificationCompat.PRIORITY_HIGH)
                .setContentIntent(pendingIntent)
                .setAutoCancel(true)
                .setVibrate(longArrayOf(0, 500, 200, 500))
                .build()

            with(NotificationManagerCompat.from(this)) {
                if (areNotificationsEnabled()) {
                    notify(System.currentTimeMillis().toInt(), notification)
                    Log.d("MainActivity", "\uD83D\uDCE8 Notifikacija poslata za: ${proizvod.naziv}")
                }
            }
        } catch (e: Exception) {
            Log.e("MainActivity", "Greška pri slanju notifikacije: ${e.message}")
        }
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\Proizvod.kt

package com.jovannedeljkovic.superstockgo

import java.util.Locale

data class Proizvod(
    val id: Int = 0,
    val naziv: String = "",
    val kategorija: String = "",
    val kolicina: Int = 0
) {
    // Prazan konstruktor potreban za Firebase
    constructor() : this(0, "", "", 0)

    // VAŽNO: Dodajte ovu metodu za jedinstveni kljuè
    fun getUniqueKey(): String {
        return "${naziv.trim().toLowerCase(Locale.getDefault())}|${kategorija.trim().toLowerCase(Locale.getDefault())}"
    }

    // Dodatna pomoæna metoda za debug
    fun logInfo(tag: String = "Proizvod") {
        println("$tag: ${this.naziv} | ${this.kategorija} | ID: ${this.id} | Key: ${getUniqueKey()}")
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\ProizvodAdapter.kt

package com.jovannedeljkovic.superstockgo

import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.ImageButton
import android.widget.TextView
import androidx.cardview.widget.CardView
import androidx.core.content.ContextCompat
import androidx.recyclerview.widget.RecyclerView

class ProizvodAdapter(
    var proizvodi: List<Proizvod>,
    private val onEditClick: (Proizvod) -> Unit,
    private val onDeleteClick: (Proizvod) -> Unit,
    private val onPlusClick: (Proizvod) -> Unit,
    private val onMinusClick: (Proizvod) -> Unit
) : RecyclerView.Adapter<ProizvodAdapter.ProizvodViewHolder>() {

    class ProizvodViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) {
        val cardView: CardView = itemView.findViewById(R.id.cardView)
        val tvNaziv: TextView = itemView.findViewById(R.id.tvNaziv)
        val tvKategorija: TextView = itemView.findViewById(R.id.tvKategorija)
        val tvKolicina: TextView = itemView.findViewById(R.id.tvKolicina)
        val btnMinus: ImageButton = itemView.findViewById(R.id.btnMinus)
        val btnPlus: ImageButton = itemView.findViewById(R.id.btnPlus)
        val btnEdit: ImageButton = itemView.findViewById(R.id.btnEdit)
        val btnDelete: ImageButton = itemView.findViewById(R.id.btnDelete)
    }

    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ProizvodViewHolder {
        val view = LayoutInflater.from(parent.context)
            .inflate(R.layout.item_proizvod, parent, false)
        return ProizvodViewHolder(view)
    }

    override fun onBindViewHolder(holder: ProizvodViewHolder, position: Int) {
        val proizvod = proizvodi[position]

        holder.tvNaziv.text = proizvod.naziv
        holder.tvKategorija.text = proizvod.kategorija
        holder.tvKolicina.text = "Kolièina: ${proizvod.kolicina}"

        // Oboji kartu - KORISTITE ContextCompat.getColor()
        when {
            proizvod.kolicina <= 0 -> {
                holder.cardView.setCardBackgroundColor(
                    ContextCompat.getColor(holder.itemView.context, R.color.red_light)
                )
                holder.tvKolicina.setTextColor(
                    ContextCompat.getColor(holder.itemView.context, android.R.color.holo_red_dark)
                )
                holder.tvKolicina.text = "? NEMA NA STANJU"
            }
            proizvod.kolicina <= 5 -> {
                holder.cardView.setCardBackgroundColor(
                    ContextCompat.getColor(holder.itemView.context, R.color.orange_light)
                )
                holder.tvKolicina.setTextColor(
                    ContextCompat.getColor(holder.itemView.context, android.R.color.holo_orange_dark)
                )
                holder.tvKolicina.text = "?? Niska: ${proizvod.kolicina}"
            }
            else -> {
                holder.cardView.setCardBackgroundColor(
                    ContextCompat.getColor(holder.itemView.context, R.color.green_light)
                )
                holder.tvKolicina.setTextColor(
                    ContextCompat.getColor(holder.itemView.context, android.R.color.black)
                )
            }
        }

        // Postavi klik listenere
        holder.btnMinus.setOnClickListener {
            onMinusClick(proizvod)
        }

        holder.btnPlus.setOnClickListener {
            onPlusClick(proizvod)
        }

        holder.btnEdit.setOnClickListener {
            onEditClick(proizvod)
        }

        holder.btnDelete.setOnClickListener {
            onDeleteClick(proizvod)
        }
    }

    override fun getItemCount(): Int = proizvodi.size

    fun updateData(newProizvodi: List<Proizvod>) {
        proizvodi = newProizvodi
        notifyDataSetChanged()
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\PushNotificationService.kt

package com.jovannedeljkovic.superstockgo

import android.Manifest
import android.app.NotificationChannel
import android.app.NotificationManager
import android.app.PendingIntent
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.os.Build
import android.util.Log
import androidx.core.app.ActivityCompat
import androidx.core.app.NotificationCompat
import androidx.core.app.NotificationManagerCompat
import com.google.firebase.messaging.FirebaseMessagingService
import com.google.firebase.messaging.RemoteMessage

class PushNotificationService : FirebaseMessagingService() {

    companion object {
        const val CHANNEL_ID = "low_stock_channel"
        const val CHANNEL_NAME = "Niska zaliha notifikacije"
        const val NOTIFICATION_PERMISSION_CODE = 200
    }

    override fun onNewToken(token: String) {
        super.onNewToken(token)
        Log.d("FCM", "New token: $token")
        // Pošalji token vašem serveru
    }

    override fun onMessageReceived(remoteMessage: RemoteMessage) {
        super.onMessageReceived(remoteMessage)

        remoteMessage.notification?.let { notification ->
            if (checkNotificationPermission()) {
                showNotification(
                    notification.title ?: "SuperstockGO Upozorenje",
                    notification.body ?: "Niska zaliha proizvoda"
                )
            } else {
                Log.d("FCM", "Nema dozvole za notifikacije")
            }
        }
    }

    private fun checkNotificationPermission(): Boolean {
        return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            val result = ActivityCompat.checkSelfPermission(
                this,
                Manifest.permission.POST_NOTIFICATIONS
            )
            result == PackageManager.PERMISSION_GRANTED
        } else {
            true
        }
    }

    private fun showNotification(title: String, message: String) {
        createNotificationChannel()

        val intent = Intent(this, MainActivity::class.java).apply {
            flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK
        }

        val pendingIntent = PendingIntent.getActivity(
            this, 0, intent,
            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
        )

        val notification = NotificationCompat.Builder(this, CHANNEL_ID)
            .setSmallIcon(R.mipmap.ic_launcher)
            .setContentTitle(title)
            .setContentText(message)
            .setPriority(NotificationCompat.PRIORITY_HIGH)
            .setContentIntent(pendingIntent)
            .setAutoCancel(true)
            .build()

        if (NotificationManagerCompat.from(this).areNotificationsEnabled()) {
            NotificationManagerCompat.from(this).notify(System.currentTimeMillis().toInt(), notification)
        } else {
            Log.d("FCM", "Notifikacije su onemoguæene u sistemu")
        }
    }

    private fun createNotificationChannel() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            val channel = NotificationChannel(
                CHANNEL_ID,
                CHANNEL_NAME,
                NotificationManager.IMPORTANCE_HIGH
            ).apply {
                description = "Obaveštenja o niskoj zaliži proizvoda"
                enableVibration(true)
                vibrationPattern = longArrayOf(0, 500, 200, 500)
            }

            val notificationManager = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
            notificationManager.createNotificationChannel(channel)
        }
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\Repository.kt

package com.jovannedeljkovic.superstockgo

import android.content.Context
import android.content.Intent
import android.util.Log
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.lang.Exception
import kotlinx.coroutines.delay

class Repository(private val context: Context) {
    private val localDbHelper = DBHelper(context)
    private val firebaseHelper = FirebaseHelper(context)
    private val coroutineScope = CoroutineScope(Dispatchers.IO)
    private val TAG = "Repository"

    fun getCurrentUserId(): String {
        val currentUser = firebaseHelper.getCurrentUser()
        return currentUser?.uid ?: "offline_user_${System.currentTimeMillis()}"
    }

    fun getCurrentUserEmail(): String? {
        return firebaseHelper.getCurrentUser()?.email
    }

    fun isUserLoggedIn(): Boolean {
        return firebaseHelper.getCurrentUser() != null
    }

    fun migrirajPodatkeZaTrenutnogKorisnika() {
        coroutineScope.launch {
            try {
                val userId = getCurrentUserId()
                if (userId != "unknown" && !userId.startsWith("offline_user")) {
                    localDbHelper.migrirajStarePodatke(userId)
                    Log.d(TAG, "Migracija završena za user: $userId")
                }
            } catch (e: Exception) {
                Log.e(TAG, "Greška pri migraciji: ${e.message}")
            }
        }
    }

    // ========== CRUD OPERACIJE - BEZ FIREBASE ==========

    fun dodajProizvod(proizvod: Proizvod, onComplete: (Boolean, String?) -> Unit) {
        coroutineScope.launch {
            try {
                val userId = getCurrentUserId()

                // Proveri duplikate
                val sviProizvodi = localDbHelper.sviProizvodi(userId)
                val postoji = sviProizvodi.any {
                    it.naziv == proizvod.naziv && it.kategorija == proizvod.kategorija
                }

                if (postoji) {
                    withContext(Dispatchers.Main) {
                        onComplete(false, "Proizvod veæ postoji")
                    }
                    return@launch
                }

                val localId = localDbHelper.dodajProizvod(proizvod, userId)

                withContext(Dispatchers.Main) {
                    if (localId > 0) {
                        onComplete(true, "saèuvan")
                        // LOCAL broadcast više ne šaljemo odavde
                        // Pozivajuæa aktivnost æe poslati LOCAL broadcast
                    } else {
                        onComplete(false, "greška pri èuvanju")
                    }
                }
            } catch (e: Exception) {
                Log.e(TAG, "Greška: ${e.message}")
                withContext(Dispatchers.Main) {
                    onComplete(false, "sistemska greška")
                }
            }
        }
    }

    fun sviProizvodi(onComplete: (List<Proizvod>) -> Unit) {
        coroutineScope.launch {
            try {
                val userId = getCurrentUserId()
                val proizvodi = withContext(Dispatchers.IO) {
                    localDbHelper.sviProizvodi(userId)
                }

                // POPRAVI KATEGORIJE PRE NEGO ŠTO IH VRATIŠ
                val popravljeniProizvodi = proizvodi.map { proizvod ->
                    val popravljenaKategorija = proizvod.kategorija
                        .replace("Pie", "Pi e")
                        .replace("PI E", "Pi e")
                        .replace("PICE", "Pi e")
                        .replace("Pice", "Pi e") // za svaki sluèaj

                    proizvod.copy(kategorija = popravljenaKategorija)
                }

                withContext(Dispatchers.Main) {
                    onComplete(popravljeniProizvodi)
                }
            } catch (e: Exception) {
                Log.e(TAG, "Greška pri u itavanju: ${e.message}")
                withContext(Dispatchers.Main) {
                    onComplete(emptyList())
                }
            }
        }
    }

    // VAŽNO: Ova metoda je kljuèna - UKLONJEN FIREBASE
    fun azurirajProizvod(proizvod: Proizvod, onComplete: (Boolean) -> Unit) {
        coroutineScope.launch {
            try {
                val userId = getCurrentUserId()
                val success = localDbHelper.azurirajProizvod(proizvod, userId) > 0

                // SAMO LOKALNO - NEMA FIREBASE POZIVA!
                withContext(Dispatchers.Main) {
                    onComplete(success)
                }
            } catch (e: Exception) {
                Log.e(TAG, "Greška pri ažuriranju: ${e.message}")
                withContext(Dispatchers.Main) {
                    onComplete(false)
                }
            }
        }
    }

    fun obrisiProizvod(proizvod: Proizvod, onComplete: (Boolean) -> Unit) {
        coroutineScope.launch {
            try {
                val userId = getCurrentUserId()
                // SAMO LOKALNO - NEMA FIREBASE!
                val success = localDbHelper.obrisiProizvod(proizvod.id, userId) > 0

                withContext(Dispatchers.Main) {
                    onComplete(success)
                }
            } catch (e: Exception) {
                Log.e(TAG, "Greška pri brisanju: ${e.message}")
                withContext(Dispatchers.Main) {
                    onComplete(false)
                }
            }
        }
    }

    fun pronadjiProizvod(id: Int, onComplete: (Proizvod?) -> Unit) {
        coroutineScope.launch {
            try {
                val userId = getCurrentUserId()
                val sviProizvodi = localDbHelper.sviProizvodi(userId)
                val proizvod = sviProizvodi.find { it.id == id }
                withContext(Dispatchers.Main) {
                    onComplete(proizvod)
                }
            } catch (e: Exception) {
                Log.e(TAG, "Greška pri pronalaženju: ${e.message}")
                withContext(Dispatchers.Main) {
                    onComplete(null)
                }
            }
        }
    }

    suspend fun getProizvodiSuspended(): List<Proizvod> = withContext(Dispatchers.IO) {
        return@withContext try {
            val userId = getCurrentUserId()
            localDbHelper.sviProizvodi(userId)
        } catch (e: Exception) {
            Log.e(TAG, "Greška u getProizvodiSuspended: ${e.message}")
            emptyList()
        }
    }

    fun brojProizvodaZaKorisnika(onComplete: (Int) -> Unit) {
        coroutineScope.launch {
            try {
                val userId = getCurrentUserId()
                val broj = localDbHelper.brojProizvodaPoKorisniku(userId)
                withContext(Dispatchers.Main) {
                    onComplete(broj)
                }
            } catch (e: Exception) {
                Log.e(TAG, "Greška pri brojanju proizvoda: ${e.message}")
                withContext(Dispatchers.Main) {
                    onComplete(0)
                }
            }
        }
    }

    fun proveriIIspraviDuplikate(onComplete: (Int) -> Unit) {
        coroutineScope.launch {
            try {
                val userId = getCurrentUserId()
                val sviProizvodi = withContext(Dispatchers.IO) {
                    localDbHelper.sviProizvodi(userId)
                }

                if (sviProizvodi.isEmpty()) {
                    withContext(Dispatchers.Main) {
                        onComplete(0)
                    }
                    return@launch
                }

                val mapaProizvoda = mutableMapOf<String, MutableList<Proizvod>>()
                val duplikatiZaBrisanje = mutableListOf<Proizvod>()

                sviProizvodi.forEach { proizvod ->
                    val key = proizvod.getUniqueKey()
                    val lista = mapaProizvoda.getOrPut(key) { mutableListOf() }
                    lista.add(proizvod)

                    if (lista.size > 1) {
                        duplikatiZaBrisanje.addAll(lista.drop(1))
                    }
                }

                var uspesnoObrisano = 0
                var greske = 0

                if (duplikatiZaBrisanje.isNotEmpty()) {
                    duplikatiZaBrisanje.forEach { duplikat ->
                        try {
                            val result = withContext(Dispatchers.IO) {
                                localDbHelper.obrisiProizvod(duplikat.id, userId)
                            }

                            if (result > 0) {
                                uspesnoObrisano++
                                Log.d("Repository", "? Obrisan duplikat: '${duplikat.naziv}'")
                            } else {
                                greske++
                                Log.e("Repository", "? Nije uspelo brisanje: '${duplikat.naziv}'")
                            }
                        } catch (e: Exception) {
                            greske++
                            Log.e(TAG, "Exception pri brisanju '${duplikat.naziv}': ${e.message}")
                        }
                        delay(50)
                    }
                }

                withContext(Dispatchers.Main) {
                    onComplete(uspesnoObrisano)
                }
            } catch (e: Exception) {
                Log.e(TAG, "Greška pri skeniranju duplikata: ${e.message}", e)
                withContext(Dispatchers.Main) {
                    onComplete(0)
                }
            }
        }
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\SimpleStatsActivity.kt

package com.jovannedeljkovic.superstockgo

import android.content.Intent
import android.os.Bundle
import android.widget.*
import androidx.appcompat.app.AppCompatActivity
import androidx.appcompat.widget.Toolbar
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.text.SimpleDateFormat
import java.util.*

class SimpleStatsActivity : AppCompatActivity() {

    private lateinit var repository: Repository
    private lateinit var tvTotalProducts: TextView
    private lateinit var tvLowStock: TextView
    private lateinit var tvOutOfStock: TextView
    private lateinit var tvCategoryCount: TextView
    private lateinit var tvLowStockList: TextView
    private lateinit var btnExportCSV: Button
    private lateinit var btnEmailReport: Button  // NOVO
    private lateinit var btnBack: Button
    private lateinit var progressBar: ProgressBar

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_simple_stats)

        // Toolbar
        val toolbar: Toolbar = findViewById(R.id.toolbar)
        toolbar.title = "?? Statistike"
        setSupportActionBar(toolbar)
        supportActionBar?.setDisplayHomeAsUpEnabled(true)

        // Inicijalizacija
        repository = Repository(this)

        // Poveži view-ove
        tvTotalProducts = findViewById(R.id.tvTotalProducts)
        tvLowStock = findViewById(R.id.tvLowStock)
        tvOutOfStock = findViewById(R.id.tvOutOfStock)
        tvCategoryCount = findViewById(R.id.tvCategoryCount)
        tvLowStockList = findViewById(R.id.tvLowStockList)
        btnExportCSV = findViewById(R.id.btnExportCSV)
        btnEmailReport = findViewById(R.id.btnEmailReport)  // NOVO
        btnBack = findViewById(R.id.btnBack)
        progressBar = findViewById(R.id.progressBar)

        // Uèitaj podatke
        loadStatistics()

        // Dugmad
        btnExportCSV.setOnClickListener { exportToCSV() }
        btnEmailReport.setOnClickListener { sendEmailReport() }  // NOVO
        btnBack.setOnClickListener { finish() }
    }

    private fun loadStatistics() {
        progressBar.visibility = ProgressBar.VISIBLE

        CoroutineScope(Dispatchers.IO).launch {
            try {
                val proizvodi = repository.getProizvodiSuspended()

                withContext(Dispatchers.Main) {
                    updateStatistics(proizvodi)
                    progressBar.visibility = ProgressBar.GONE
                }

            } catch (e: Exception) {
                withContext(Dispatchers.Main) {
                    Toast.makeText(this@SimpleStatsActivity,
                        "Greška pri uèitavanju podataka",
                        Toast.LENGTH_SHORT).show()
                    progressBar.visibility = ProgressBar.GONE
                }
            }
        }
    }

    private fun updateStatistics(proizvodi: List<Proizvod>) {
        // Osnovne statistike
        val total = proizvodi.size
        val lowStock = proizvodi.count { it.kolicina in 1..5 }
        val outOfStock = proizvodi.count { it.kolicina == 0 }
        val categories = proizvodi.map { it.kategorija }.distinct().size

        tvTotalProducts.text = "?? Ukupno proizvoda: $total"
        tvLowStock.text = "?? Niska zaliha: $lowStock"
        tvOutOfStock.text = "? Bez zaliha: $outOfStock"
        tvCategoryCount.text = "??? Kategorija: $categories"

        // Top 5 niska zaliha
        val lowStockProducts = proizvodi
            .filter { it.kolicina <= 5 }
            .sortedBy { it.kolicina }
            .take(5)

        val lowStockText = buildString {
            if (lowStockProducts.isEmpty()) {
                append("? Nema proizvoda sa niskom zaliom!")
            } else {
                append("Proizvodi sa niskom zaliom:\n\n")
                lowStockProducts.forEachIndexed { index, proizvod ->
                    append("${index + 1}. ${proizvod.naziv}\n")
                    append("   Kategorija: ${proizvod.kategorija}\n")
                    append("   Kolièina: ${proizvod.kolicina} kom\n\n")
                }
            }
        }
        tvLowStockList.text = lowStockText
    }

    private fun exportToCSV() {
        CoroutineScope(Dispatchers.IO).launch {
            try {
                val proizvodi = repository.getProizvodiSuspended()
                val csv = StringBuilder()

                // CSV header sa UTF-8 encoding
                csv.append("\uFEFF") // UTF-8 BOM za Excel
                csv.append("ID;Naziv;Kategorija;Kolièina;Datum\n")

                val dateFormat = SimpleDateFormat("dd.MM.yyyy", Locale.getDefault())
                proizvodi.forEach { proizvod ->
                    csv.append("${proizvod.id};${proizvod.naziv};${proizvod.kategorija};${proizvod.kolicina};${dateFormat.format(Date())}\n")
                }

                withContext(Dispatchers.Main) {
                    // Prikaži dijalog za deljenje
                    val shareIntent = Intent().apply {
                        action = Intent.ACTION_SEND
                        putExtra(Intent.EXTRA_TEXT, csv.toString())
                        type = "text/csv"
                        putExtra(Intent.EXTRA_SUBJECT, "SuperstockGO Izveštaj")
                    }

                    startActivity(Intent.createChooser(shareIntent, "Saèuvaj CSV"))

                    Toast.makeText(this@SimpleStatsActivity,
                        "? CSV izveštaj spreman",
                        Toast.LENGTH_SHORT).show()
                }

            } catch (e: Exception) {
                withContext(Dispatchers.Main) {
                    Toast.makeText(this@SimpleStatsActivity,
                        "Greška pri exportu: ${e.message}",
                        Toast.LENGTH_SHORT).show()
                }
            }
        }
    }

    // NOVO: METODA ZA EMAIL IZVEŠTAJ
    private fun sendEmailReport() {
        CoroutineScope(Dispatchers.IO).launch {
            try {
                val proizvodi = repository.getProizvodiSuspended()

                val total = proizvodi.size
                val lowStock = proizvodi.count { it.kolicina in 1..5 }
                val outOfStock = proizvodi.count { it.kolicina == 0 }

                val emailBody = """
                SuperstockGO - Izveštaj
                ======================
                
                Datum: ${SimpleDateFormat("dd.MM.yyyy HH:mm", Locale.getDefault()).format(Date())}
                
                ?? Statistika:
                - Ukupno proizvoda: $total
                - Niska zaliha: $lowStock
                - Bez zaliha: $outOfStock
                
                Top 5 niska zaliha:
                ${proizvodi.filter { it.kolicina <= 5 }
                    .sortedBy { it.kolicina }
                    .take(5)
                    .joinToString("\n") { "- ${it.naziv} (${it.kolicina} kom)" }}
                
                Hvala što koristite SuperstockGO!
                """.trimIndent()

                withContext(Dispatchers.Main) {
                    val emailIntent = Intent(Intent.ACTION_SEND).apply {
                        type = "text/plain"
                        putExtra(Intent.EXTRA_EMAIL, arrayOf("jocaned@gmail.com"))
                        putExtra(Intent.EXTRA_SUBJECT, "SuperstockGO Izveštaj")
                        putExtra(Intent.EXTRA_TEXT, emailBody)
                    }

                    try {
                        startActivity(Intent.createChooser(emailIntent, "Pošalji izveštaj"))
                    } catch (e: Exception) {
                        Toast.makeText(this@SimpleStatsActivity,
                            "Nema email aplikacije",
                            Toast.LENGTH_SHORT).show()
                    }
                }

            } catch (e: Exception) {
                withContext(Dispatchers.Main) {
                    Toast.makeText(this@SimpleStatsActivity,
                        "Greška: ${e.message}",
                        Toast.LENGTH_SHORT).show()
                }
            }
        }
    }

    override fun onSupportNavigateUp(): Boolean {
        finish()
        return true
    }
}


FILE: app\src\main\java\com\jovannedeljkovic\superstockgo\StatsActivity.kt

package com.jovannedeljkovic.superstockgo

import android.Manifest
import android.app.DatePickerDialog
import android.content.ContentValues
import android.content.Intent
import android.content.pm.PackageManager
import android.graphics.Color
import android.net.Uri
import android.os.Build
import android.os.Bundle
import android.os.Environment
import android.provider.MediaStore
import android.provider.Settings
import android.text.format.DateFormat
import android.util.Log
import android.widget.*
import androidx.appcompat.app.AlertDialog
import androidx.appcompat.app.AppCompatActivity
import androidx.appcompat.widget.Toolbar
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import androidx.core.content.FileProvider
import androidx.cardview.widget.CardView
import com.github.mikephil.charting.charts.PieChart
import com.github.mikephil.charting.data.PieData
import com.github.mikephil.charting.data.PieDataSet
import com.github.mikephil.charting.data.PieEntry
import com.itextpdf.text.*
import com.itextpdf.text.pdf.PdfPCell
import com.itextpdf.text.pdf.PdfPTable
import com.itextpdf.text.pdf.PdfWriter
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.io.File
import java.io.FileOutputStream
import java.text.SimpleDateFormat
import java.util.*
import androidx.annotation.RequiresApi

class StatsActivity : AppCompatActivity() {

    private lateinit var repository: Repository
    private lateinit var firebaseHelper: FirebaseHelper

    // UI komponente
    private lateinit var tvTotalProducts: TextView
    private lateinit var tvLowStockCount: TextView
    private lateinit var tvOutOfStock: TextView
    private lateinit var tvTotalQuantity: TextView
    private lateinit var tvPeriod: TextView
    private lateinit var tvGeneratedTime: TextView
    private lateinit var tvLowStockList: TextView
    private lateinit var tvCategoryStats: TextView

    private lateinit var spinnerFilter: Spinner
    private lateinit var btnCustomDate: Button
    private lateinit var btnExportPDF: Button
    private lateinit var btnShare: Button
    private lateinit var btnExportCSV: Button
    private lateinit var btnEmailReport: Button
    private lateinit var progressBar: ProgressBar
    private var lastAction: String = ""

    private lateinit var tvAverageQuantity: TextView
    private lateinit var tvTotalValue: TextView
    private lateinit var tvTopCategory: TextView
    private lateinit var tvNeedReorder: TextView
    private lateinit var tvDistribution: TextView


    private lateinit var cardOverview: CardView
    private lateinit var cardLowStock: CardView
    private lateinit var cardCategories: CardView

    // Filter varijable
    private var selectedFilter = "all" // all, today, week, month, custom
    private var customStartDate: Date? = null
    private var customEndDate: Date? = null

    // PDF export
    private val REQUEST_CODE_WRITE_EXTERNAL_STORAGE = 1001
    private val REQUEST_CODE_MANAGE_STORAGE = 1002

    companion object {
        private const val PDF_DIRECTORY = "SuperstockGO_Reports"
        private const val SHARED_PREFS_TIMESTAMPS = "product_timestamps"
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_stats)

        // ========== TOOLBAR ==========
        val toolbar: Toolbar = findViewById(R.id.toolbar)
        toolbar.title = "?? Statistike"
        setSupportActionBar(toolbar)
        supportActionBar?.setDisplayHomeAsUpEnabled(true)

        // ========== INICIJALIZACIJA ==========
        repository = Repository(this)
        firebaseHelper = FirebaseHelper(this)

        // ========== POVEŽI VIEW-OVE ==========
        tvTotalProducts = findViewById(R.id.tvTotalProducts)
        tvLowStockCount = findViewById(R.id.tvLowStockCount)
        tvOutOfStock = findViewById(R.id.tvOutOfStock)
        tvTotalQuantity = findViewById(R.id.tvTotalQuantity)
        tvPeriod = findViewById(R.id.tvPeriod)
        tvGeneratedTime = findViewById(R.id.tvGeneratedTime)
        tvLowStockList = findViewById(R.id.tvLowStockList)
        tvCategoryStats = findViewById(R.id.tvCategoryStats)
        tvAverageQuantity = findViewById(R.id.tvAverageQuantity)
        tvTotalValue = findViewById(R.id.tvTotalValue)
        tvTopCategory = findViewById(R.id.tvTopCategory)
        tvNeedReorder = findViewById(R.id.tvNeedReorder)
        tvDistribution = findViewById(R.id.tvDistribution)

        spinnerFilter = findViewById(R.id.spinnerFilter)
        btnCustomDate = findViewById(R.id.btnCustomDate)
        btnExportPDF = findViewById(R.id.btnExportPDF)
        btnShare = findViewById(R.id.btnShare)
        progressBar = findViewById(R.id.progressBar)

        cardOverview = findViewById(R.id.cardOverview)
        cardLowStock = findViewById(R.id.cardLowStock)
        cardCategories = findViewById(R.id.cardCategories)

        // NOVA DUGMAD
        btnExportCSV = findViewById(R.id.btnExportCSV)
        btnEmailReport = findViewById(R.id.btnEmailReport)

        // ========== POSTAVI VREME ==========
        tvGeneratedTime.text = SimpleDateFormat("dd.MM.yyyy HH:mm", Locale.getDefault()).format(Date())

        // ========== POSTAVI SPINNER ==========
        setupFilterSpinner()

        // ========== POSTAVI KLIK LISTENERE ==========
        btnCustomDate.setOnClickListener {
            showDateRangePicker()
        }

        btnExportPDF.setOnClickListener {
            checkPermissionsAndExportPDF()
        }

        btnExportCSV.setOnClickListener {
            checkPermissionsAndExportCSV()
        }

        btnEmailReport.setOnClickListener {
            sendEmailReport()
        }

        btnShare.setOnClickListener {
            shareReport()
        }

        // ========== UÈITAJ PODATKE ==========
        loadStatistics()
    }

    private fun setupToolbar() {
        val toolbar: Toolbar = findViewById(R.id.toolbar)
        toolbar.title = "\uD83D\uDCCA Statistike i Izveštaji"
        setSupportActionBar(toolbar)
        supportActionBar?.setDisplayHomeAsUpEnabled(true)
    }

    private fun setupViews() {
        tvTotalProducts = findViewById(R.id.tvTotalProducts)
        tvLowStockCount = findViewById(R.id.tvLowStockCount)
        tvOutOfStock = findViewById(R.id.tvOutOfStock)
        tvTotalQuantity = findViewById(R.id.tvTotalQuantity)
        tvPeriod = findViewById(R.id.tvPeriod)
        tvGeneratedTime = findViewById(R.id.tvGeneratedTime)
        tvLowStockList = findViewById(R.id.tvLowStockList)
        tvCategoryStats = findViewById(R.id.tvCategoryStats)

        spinnerFilter = findViewById(R.id.spinnerFilter)
        btnCustomDate = findViewById(R.id.btnCustomDate)
        btnExportPDF = findViewById(R.id.btnExportPDF)
        btnShare = findViewById(R.id.btnShare)
        btnExportCSV = findViewById(R.id.btnExportCSV) // Dodajte u XML
        btnEmailReport = findViewById(R.id.btnEmailReport) // Dodajte u XML
        progressBar = findViewById(R.id.progressBar)

        cardOverview = findViewById(R.id.cardOverview)
        cardLowStock = findViewById(R.id.cardLowStock)
        cardCategories = findViewById(R.id.cardCategories)

        // Postavi trenutno vreme
        tvGeneratedTime.text = SimpleDateFormat("dd.MM.yyyy HH:mm", Locale.getDefault()).format(Date())
    }

    private fun setupFilterSpinner() {
        val filters = arrayOf(
            "Sve vreme",
            "Danas",
            "Ova nedelja",
            "Ovaj mesec",
            "Prilagoðeni period"
        )

        val adapter = ArrayAdapter(this, android.R.layout.simple_spinner_item, filters)
        adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
        spinnerFilter.adapter = adapter

        spinnerFilter.onItemSelectedListener = object : AdapterView.OnItemSelectedListener {
            override fun onItemSelected(parent: AdapterView<*>?, view: android.view.View?, position: Int, id: Long) {
                selectedFilter = when(position) {
                    0 -> "all"
                    1 -> "today"
                    2 -> "week"
                    3 -> "month"
                    4 -> "custom"
                    else -> "all"
                }

                if (selectedFilter == "custom") {
                    btnCustomDate.visibility = Button.VISIBLE
                    showDateRangePicker()
                } else {
                    btnCustomDate.visibility = Button.GONE
                    loadStatistics()
                }
            }

            override fun onNothingSelected(parent: AdapterView<*>?) {}
        }
    }

    private fun setupClickListeners() {
        btnCustomDate.setOnClickListener {
            showDateRangePicker()
        }

        btnExportPDF.setOnClickListener {
            checkPermissionsAndExportPDF()
        }

        btnShare.setOnClickListener {
            shareReport()
        }
        btnExportCSV.setOnClickListener {
            exportToCSV()
        }
        btnEmailReport.setOnClickListener {
            sendEmailReport()
        }
    }

    private fun exportToCSV() {
        progressBar.visibility = ProgressBar.VISIBLE

        CoroutineScope(Dispatchers.IO).launch {
            try {
                val proizvodi = repository.getProizvodiSuspended()
                val csv = StringBuilder()

                // CSV header sa UTF-8 BOM za Excel
                csv.append("\uFEFF") // VAŽNO: UTF-8 BOM
                csv.append("ID;Naziv;Kategorija;Kolièina;Status\n")

                proizvodi.forEach { proizvod ->
                    val status = when {
                        proizvod.kolicina == 0 -> "NEMA ZALIHA"
                        proizvod.kolicina <= 5 -> "NISKA ZALIHA"
                        else -> "OK"
                    }

                    // Koristite ; umesto , zbog srpskih decimala
                    csv.append("${proizvod.id};${proizvod.naziv};${proizvod.kategorija};${proizvod.kolicina};$status\n")
                }

                withContext(Dispatchers.Main) {
                    // Saèuvaj fajl
                    saveCSVFile(csv.toString())
                    progressBar.visibility = ProgressBar.GONE
                }

            } catch (e: Exception) {
                withContext(Dispatchers.Main) {
                    Toast.makeText(this@StatsActivity, "Greška pri exportu CSV: ${e.message}", Toast.LENGTH_SHORT).show()
                    progressBar.visibility = ProgressBar.GONE
                }
            }
        }
    }

    private fun saveCSVFile(csvContent: String) {
        try {
            val timestamp = SimpleDateFormat("yyyyMMdd_HHmmss", Locale.getDefault()).format(Date())
            val fileName = "SuperstockGO_$timestamp.csv"

            // Za Android 10+ koristimo MediaStore
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
                val contentValues = ContentValues().apply {
                    put(MediaStore.MediaColumns.DISPLAY_NAME, fileName)
                    put(MediaStore.MediaColumns.MIME_TYPE, "text/csv")
                    put(MediaStore.MediaColumns.RELATIVE_PATH, Environment.DIRECTORY_DOWNLOADS + "/SuperstockGO")
                }

                val resolver = contentResolver
                val uri = resolver.insert(MediaStore.Downloads.EXTERNAL_CONTENT_URI, contentValues)

                uri?.let {
                    resolver.openOutputStream(it)?.use { stream ->
                        stream.write(csvContent.toByteArray(Charsets.UTF_8))
                    }

                    Toast.makeText(this, "CSV saèuvan u Download/SuperstockGO", Toast.LENGTH_LONG).show()
                }
            } else {
                // Za starije Androide
                val downloadsDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS)
                val superstockDir = File(downloadsDir, "SuperstockGO")
                if (!superstockDir.exists()) {
                    superstockDir.mkdirs()
                }

                val file = File(superstockDir, fileName)
                FileOutputStream(file).use { fos ->
                    fos.write(csvContent.toByteArray(Charsets.UTF_8))
                }

                Toast.makeText(this, "CSV saèuvan: ${file.absolutePath}", Toast.LENGTH_LONG).show()
            }

        } catch (e: Exception) {
            Toast.makeText(this, "Greška pri èuvanju CSV: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    private fun calculateAdvancedStatistics(products: List<Proizvod>) {
        // 1. PROSEÈNA KOLIÈINA PO PROIZVODU
        val averageQuantity = if (products.isNotEmpty()) {
            String.format("%.1f", products.sumOf { it.kolicina } / products.size.toDouble())
        } else "0.0"

        // 2. UKUPNA VREDNOST (pretpostavka: svaki proizvod vredi 100 din)
        val totalValue = products.sumOf { it.kolicina * 100 }

        // 3. NAJZASTUPLJENIJA KATEGORIJA
        val topCategory = products.groupBy { it.kategorija }
            .maxByOrNull { it.value.size }
            ?.key ?: "Nema"

        // 4. PROIZVODI KOJI TREBA NARUÈITI (kolièina = 0)
        val needReorder = products.filter { it.kolicina == 0 }

        // 5. DISTRIBUCIJA PO NIVOIMA ZALIHE
        val distribution = mapOf(
            "Nema" to products.count { it.kolicina == 0 },
            "Kritièno" to products.count { it.kolicina in 1..2 },
            "Nisko" to products.count { it.kolicina in 3..5 },
            "Normalno" to products.count { it.kolicina in 6..20 },
            "Visoko" to products.count { it.kolicina > 20 }
        )

        // Prikažite ove statistike u TextView-ovima
        updateUIWithAdvancedStats(averageQuantity, totalValue, topCategory, needReorder.size, distribution)
    }

    /*private fun calculateAdvancedStatistics(products: List<Proizvod>) {
        // 1. PROSEÈNA KOLIÈINA PO PROIZVODU
        val averageQuantity = if (products.isNotEmpty()) {
            String.format("%.1f", products.sumOf { it.kolicina } / products.size.toDouble())
        } else "0.0"

        // 2. UKUPNA VREDNOST (pretpostavka: svaki proizvod vredi 100 din)
        val totalValue = products.sumOf { it.kolicina * 100 }

        // 3. NAJZASTUPLJENIJA KATEGORIJA
        val topCategory = products.groupBy { it.kategorija }
            .maxByOrNull { it.value.size }
            ?.key ?: "Nema"

        // 4. PROIZVODI KOJI TREBA NARUÈITI (kolièina = 0)
        val needReorder = products.filter { it.kolicina == 0 }

        // 5. DISTRIBUCIJA PO NIVOIMA ZALIHE
        val distribution = mapOf(
            "Nema" to products.count { it.kolicina == 0 },
            "Kritièno" to products.count { it.kolicina in 1..2 },
            "Nisko" to products.count { it.kolicina in 3..5 },
            "Normalno" to products.count { it.kolicina in 6..20 },
            "Visoko" to products.count { it.kolicina > 20 }
        )

        // Prikažite ove statistike u TextView-ovima
        updateUIWithAdvancedStats(averageQuantity, totalValue, topCategory, needReorder.size, distribution)
    }
*/
    private fun updateUIWithAdvancedStats(
        averageQuantity: String,
        totalValue: Int,
        topCategory: String,
        needReorderCount: Int,
        distribution: Map<String, Int>
    ) {
        runOnUiThread {
            // Bezbedno pristupanje TextView-ovima
            val tvAverage = findViewById<TextView?>(R.id.tvAverageQuantity)
            val tvValue = findViewById<TextView?>(R.id.tvTotalValue)
            val tvTopCat = findViewById<TextView?>(R.id.tvTopCategory)
            val tvReorder = findViewById<TextView?>(R.id.tvNeedReorder)
            val tvDist = findViewById<TextView?>(R.id.tvDistribution)

            tvAverage?.text = "Proseèno: $averageQuantity kom"
            tvValue?.text = "Vrednost: $totalValue RSD"
            tvTopCat?.text = "Top kategorija: $topCategory"
            tvReorder?.text = "Za naruèivanje: $needReorderCount"

            // Formatiraj distribuciju
            val distributionText = buildString {
                append("Distribucija zaliha:\n")
                distribution.forEach { (key, value) ->
                    append("• $key: $value\n")
                }
            }
            tvDist?.text = distributionText
        }
    }
    private fun createPieChart(distribution: Map<String, Int>) {
        val pieChart = findViewById<PieChart>(R.id.pieChart)

        val entries = distribution.map {
            PieEntry(it.value.toFloat(), it.key)
        }

        val dataSet = PieDataSet(entries, "Distribucija zaliha")
        dataSet.colors = listOf(
            Color.RED, Color.YELLOW, Color.rgb(255, 165, 0),
            Color.GREEN, Color.rgb(0, 100, 0)
        )

        val data = PieData(dataSet)
        pieChart.data = data
        pieChart.description.text = "Stanje zaliha"
        pieChart.animateY(1000)
        pieChart.invalidate()
    }
    private fun sendEmailReport() {
        progressBar.visibility = ProgressBar.VISIBLE

        CoroutineScope(Dispatchers.IO).launch {
            try {
                val proizvodi = repository.getProizvodiSuspended()

                if (proizvodi.isEmpty()) {
                    withContext(Dispatchers.Main) {
                        progressBar.visibility = ProgressBar.GONE
                        Toast.makeText(this@StatsActivity,
                            "Nema podataka za izveštaj",
                            Toast.LENGTH_SHORT).show()
                    }
                    return@launch
                }

                // GRUPIŠI PO KATEGORIJAMA
                val productsByCategory = proizvodi.groupBy { it.kategorija }

                // KREIRAJ DETALJAN EMAIL SADRŽAJ
                val emailBody = buildString {
                    append("=".repeat(50))
                    append("\n")
                    append("SUPERSTOCKGO - KOMPLETAN IZVEŠTAJ O ZALIHAMA\n")
                    append("=".repeat(50))
                    append("\n\n")

                    append("?? Datum izveštaja: ${SimpleDateFormat("dd.MM.yyyy HH:mm", Locale.getDefault()).format(Date())}")
                    append("\n\n")

                    append("?? OSNOVNE STATISTIKE")
                    append("\n")
                    append("-".repeat(30))
                    append("\n")

                    val total = proizvodi.size
                    val lowStock = proizvodi.count { it.kolicina in 1..5 }
                    val outOfStock = proizvodi.count { it.kolicina == 0 }
                    val totalQuantity = proizvodi.sumOf { it.kolicina }
                    val averageQuantity = if (total > 0) String.format("%.1f", totalQuantity.toDouble() / total) else "0.0"

                    append("• Ukupno proizvoda: $total\n")
                    append("• Ukupna kolièina: $totalQuantity kom\n")
                    append("• Proseèna kolièina: $averageQuantity kom\n")
                    append("• Niska zaliha (1-5 kom): $lowStock\n")
                    append("• Bez zaliha: $outOfStock\n")
                    append("\n")

                    append("?? KOMPLETAN SPISAK PROIZVODA PO KATEGORIJAMA")
                    append("\n")
                    append("=".repeat(50))
                    append("\n\n")

                    // ZA SVAKU KATEGORIJU
                    productsByCategory.forEach { (category, categoryProducts) ->
                        append("??? KATEGORIJA: $category")
                        append(" (${categoryProducts.size} proizvoda, ")
                        append("Ukupno: ${categoryProducts.sumOf { it.kolicina }} kom)")
                        append("\n")
                        append("-".repeat(40))
                        append("\n")

                        // SORTIRAJ PO NAZIVU
                        val sortedProducts = categoryProducts.sortedBy { it.naziv }

                        sortedProducts.forEachIndexed { index, proizvod ->
                            val status = when {
                                proizvod.kolicina == 0 -> "?? NEMA"
                                proizvod.kolicina <= 5 -> "?? NISKO"
                                else -> "?? OK"
                            }

                            append("${index + 1}. ${proizvod.naziv}")
                            append(" | Kolièina: ${proizvod.kolicina} kom")
                            append(" | $status")
                            append("\n")
                        }

                        append("\n")
                    }

                    append("?? SAŽETAK PO KATEGORIJAMA")
                    append("\n")
                    append("-".repeat(30))
                    append("\n")

                    productsByCategory.forEach { (category, categoryProducts) ->
                        val catTotal = categoryProducts.size
                        val catQuantity = categoryProducts.sumOf { it.kolicina }
                        val catLowStock = categoryProducts.count { it.kolicina <= 5 && it.kolicina > 0 }
                        val catOutOfStock = categoryProducts.count { it.kolicina == 0 }

                        append("• $category: $catTotal proizvoda")
                        append(" ($catQuantity kom)")
                        append(" - Nisko: $catLowStock")
                        append(" | Nema: $catOutOfStock")
                        append("\n")
                    }

                    append("\n")
                    append("=".repeat(50))
                    append("\n")
                    append("?? PREPORUKE:\n")

                    // GENERIŠI PREPORUKE
                    val noStockProducts = proizvodi.filter { it.kolicina == 0 }
                    val lowStockProducts = proizvodi.filter { it.kolicina in 1..5 }

                    if (noStockProducts.isNotEmpty()) {
                        append("\n?? HITNO NARUÈITI (nema na stanju):\n")
                        noStockProducts.take(10).forEach { proizvod ->
                            append("   - ${proizvod.naziv} (${proizvod.kategorija})\n")
                        }
                        if (noStockProducts.size > 10) {
                            append("   ... i još ${noStockProducts.size - 10} proizvoda\n")
                        }
                    }

                    if (lowStockProducts.isNotEmpty()) {
                        append("\n?? NARUÈITI USKORO (niska zaliha):\n")
                        lowStockProducts.take(10).forEach { proizvod ->
                            append("   - ${proizvod.naziv} (${proizvod.kategorija}) - ${proizvod.kolicina} kom\n")
                        }
                        if (lowStockProducts.size > 10) {
                            append("   ... i još ${lowStockProducts.size - 10} proizvoda\n")
                        }
                    }

                    if (noStockProducts.isEmpty() && lowStockProducts.isEmpty()) {
                        append("\n? Svi proizvodi su na dovoljnoj zalihi!\n")
                    }

                    append("\n")
                    append("=".repeat(50))
                    append("\n")
                    append("Izveštaj generisan aplikacijom SuperstockGO\n")
                    append("Hvala što koristite naš sistem!\n")
                    append("=".repeat(50))
                }

                withContext(Dispatchers.Main) {
                    progressBar.visibility = ProgressBar.GONE

                    // KREIRAJ EMAIL
                    val dateFormat = SimpleDateFormat("dd.MM.yyyy", Locale.getDefault())
                    val currentDate = dateFormat.format(Date())
                    val emailSubject = "SuperstockGO Kompletan Izveštaj - $currentDate"

                    val emailIntent = Intent(Intent.ACTION_SEND).apply {
                        type = "text/plain"
                        putExtra(Intent.EXTRA_EMAIL, arrayOf("jocaned@gmail.com")) // VAŠ EMAIL
                        putExtra(Intent.EXTRA_SUBJECT, emailSubject)
                        putExtra(Intent.EXTRA_TEXT, emailBody.toString())
                    }

                    try {
                        startActivity(Intent.createChooser(emailIntent, "Pošalji izveštaj na email"))
                    } catch (e: Exception) {
                        Toast.makeText(this@StatsActivity,
                            "Nema email aplikacije instalirane",
                            Toast.LENGTH_SHORT).show()
                    }
                }

            } catch (e: Exception) {
                withContext(Dispatchers.Main) {
                    progressBar.visibility = ProgressBar.GONE
                    Toast.makeText(this@StatsActivity,
                        "Greška pri slanju izveštaja: ${e.message}",
                        Toast.LENGTH_SHORT).show()
                }
            }
        }
    }
    private fun showDateRangePicker() {
        val calendar = Calendar.getInstance()
        val year = calendar.get(Calendar.YEAR)
        val month = calendar.get(Calendar.MONTH)
        val day = calendar.get(Calendar.DAY_OF_MONTH)

        // Dialog za poèetni datum
        DatePickerDialog(this, { _, selectedYear, selectedMonth, selectedDay ->
            val startDate = Calendar.getInstance().apply {
                set(selectedYear, selectedMonth, selectedDay, 0, 0, 0)
                set(Calendar.MILLISECOND, 0)
            }.time

            // Dialog za krajnji datum
            DatePickerDialog(this, { _, endYear, endMonth, endDay ->
                val endDate = Calendar.getInstance().apply {
                    set(endYear, endMonth, endDay, 23, 59, 59)
                    set(Calendar.MILLISECOND, 999)
                }.time

                // Proveri da li je poèetni datum pre krajnjeg
                if (startDate.before(endDate) || startDate == endDate) {
                    customStartDate = startDate
                    customEndDate = endDate

                    // Prikaz perioda
                    val dateFormat = SimpleDateFormat("dd.MM.yyyy", Locale.getDefault())
                    tvPeriod.text = "${dateFormat.format(startDate)} - ${dateFormat.format(endDate)}"

                    loadStatistics()
                } else {
                    Toast.makeText(this, "Poèetni datum mora biti pre krajnjeg!", Toast.LENGTH_SHORT).show()
                    spinnerFilter.setSelection(0) // Vrati na "Sve vreme"
                }

            }, year, month, day).show()

        }, year, month, day).show()
    }

    private fun loadStatistics() {
        progressBar.visibility = ProgressBar.VISIBLE

        CoroutineScope(Dispatchers.IO).launch {
            try {
                val allProducts = withContext(Dispatchers.IO) {
                    repository.getProizvodiSuspended()
                }

                // Filtriranje po vremenu
                val filteredProducts = filterProductsByTime(allProducts)

                withContext(Dispatchers.Main) {
                    // 1. OSNOVNE STATISTIKE
                    updateStatistics(filteredProducts)

                    // 2. NAPREDNE STATISTIKE
                    calculateAdvancedStatistics(filteredProducts)

                    // 3. GRAFIKON (ako postoji u layout-u)
                    try {
                        createPieChart(filteredProducts)
                    } catch (e: Exception) {
                        Log.e("StatsActivity", "Greška pri kreiranju grafikona: ${e.message}")
                    }

                    progressBar.visibility = ProgressBar.GONE
                }

            } catch (e: Exception) {
                Log.e("StatsActivity", "Greška pri uèitavanju statistika: ${e.message}")
                withContext(Dispatchers.Main) {
                    Toast.makeText(this@StatsActivity,
                        "Greška pri uèitavanju podataka",
                        Toast.LENGTH_SHORT).show()
                    progressBar.visibility = ProgressBar.GONE
                }
            }
        }
    }

    private fun checkPermissionsAndExportCSV() {
        lastAction = "CSV"
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
            if (Environment.isExternalStorageManager()) {
                exportToCSVWithMediaStore()
            } else {
                val intent = Intent(Settings.ACTION_MANAGE_APP_ALL_FILES_ACCESS_PERMISSION)
                intent.data = Uri.parse("package:$packageName")
                startActivityForResult(intent, REQUEST_CODE_MANAGE_STORAGE)
            }
        } else {
            if (ContextCompat.checkSelfPermission(this, Manifest.permission.WRITE_EXTERNAL_STORAGE)
                == PackageManager.PERMISSION_GRANTED) {
                exportToCSVWithMediaStore()
            } else {
                ActivityCompat.requestPermissions(
                    this,
                    arrayOf(Manifest.permission.WRITE_EXTERNAL_STORAGE),
                    REQUEST_CODE_WRITE_EXTERNAL_STORAGE
                )
            }
        }
    }

    private fun exportToCSVWithMediaStore() {
        progressBar.visibility = ProgressBar.VISIBLE

        CoroutineScope(Dispatchers.IO).launch {
            try {
                val proizvodi = repository.getProizvodiSuspended()

                if (proizvodi.isEmpty()) {
                    withContext(Dispatchers.Main) {
                        progressBar.visibility = ProgressBar.GONE
                        Toast.makeText(this@StatsActivity,
                            "Nema podataka za export",
                            Toast.LENGTH_SHORT).show()
                    }
                    return@launch
                }

                // KREIRAJ CSV
                val csv = StringBuilder()
                csv.append("\uFEFF") // UTF-8 BOM za Excel

                // HEADER
                csv.append("KATEGORIJA;NAZIV PROIZVODA;KOLICINA;STATUS\n")

                // POPRAVKA SRPSKIH KARAKTERA - ZAMENITE SA ENGLESKIM EKVIVALENTIMA
                val srpskiKarakteri = mapOf(
                    "è" to "c", "æ" to "c", "š" to "s", "ž" to "z", "ð" to "dj",
                    "È" to "C", "Æ" to "C", "Š" to "S", "Ž" to "Z", "Ð" to "Dj"
                )

                // SORTIRAJ
                val sortedProducts = proizvodi.sortedWith(
                    compareBy({ it.kategorija }, { it.naziv })
                )

                // DODAJ PROIZVODE
                sortedProducts.forEach { proizvod ->
                    // POPRAVI SRPSKE KARAKTERE
                    var kategorija = proizvod.kategorija
                    var naziv = proizvod.naziv

                    srpskiKarakteri.forEach { (srpski, engleski) ->
                        kategorija = kategorija.replace(srpski, engleski)
                        naziv = naziv.replace(srpski, engleski)
                    }

                    // SPECIFIÈNE ZAMENE ZA "PIÆE"
                    kategorija = kategorija.replace("Pie", "Pice")
                        .replace("PIÆE", "PICE")
                        .replace("Pi e", "Pice")

                    val status = when {
                        proizvod.kolicina == 0 -> "NEMA ZALIHE"
                        proizvod.kolicina <= 5 -> "NISKA ZALIHA"
                        else -> "DOBRA ZALIHA"
                    }

                    csv.append("$kategorija;$naziv;${proizvod.kolicina};$status\n")
                }

                // SAÈUVAJ
                val success = saveCSVFileCompatible(csv.toString())

                withContext(Dispatchers.Main) {
                    progressBar.visibility = ProgressBar.GONE

                    if (success) {
                        Toast.makeText(this@StatsActivity,
                            "? CSV saèuvan u Downloads/SuperstockGO",
                            Toast.LENGTH_LONG).show()
                    } else {
                        Toast.makeText(this@StatsActivity,
                            "? Greška pri èuvanju CSV",
                            Toast.LENGTH_SHORT).show()
                    }
                }

            } catch (e: Exception) {
                withContext(Dispatchers.Main) {
                    progressBar.visibility = ProgressBar.GONE
                    Toast.makeText(this@StatsActivity,
                        "Greška pri exportu CSV: ${e.message}",
                        Toast.LENGTH_SHORT).show()
                }
            }
        }
    }

    @RequiresApi(Build.VERSION_CODES.Q)
    private fun saveCSVToDownloads(content: String, fileName: String): Boolean {
        return try {
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
                // Android 10+ (API 29+) - koristite MediaStore
                saveCSVWithMediaStore(content, fileName)
            } else {
                // Android 9 i niže - koristite legacy pristup
                saveCSVLegacy(content, fileName)
            }
        } catch (e: Exception) {
            Log.e("StatsActivity", "Greška pri èuvanju CSV: ${e.message}")
            false
        }
    }
    @RequiresApi(Build.VERSION_CODES.Q)
    private fun saveCSVWithMediaStore(csvContent: String, fileName: String): Boolean {
        return try {
            val resolver = contentResolver
            val contentValues = ContentValues().apply {
                put(MediaStore.MediaColumns.DISPLAY_NAME, fileName)
                put(MediaStore.MediaColumns.MIME_TYPE, "text/csv")
                put(MediaStore.MediaColumns.RELATIVE_PATH, Environment.DIRECTORY_DOWNLOADS + "/SuperstockGO")
            }

            val uri = resolver.insert(MediaStore.Downloads.EXTERNAL_CONTENT_URI, contentValues)

            uri?.let {
                resolver.openOutputStream(it)?.use { outputStream ->
                    outputStream.write(csvContent.toByteArray(Charsets.UTF_8))
                }
                true
            } ?: false

        } catch (e: Exception) {
            Log.e("StatsActivity", "Greška pri MediaStore èuvanju: ${e.message}")
            false
        }
    }

    // Za Android 9 i niže
    private fun saveCSVLegacy(csvContent: String, fileName: String): Boolean {
        return try {
            if (!Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED)) {
                return false
            }

            val downloadsDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS)
            val superstockDir = File(downloadsDir, "SuperstockGO")

            if (!superstockDir.exists()) {
                superstockDir.mkdirs()
            }

            val file = File(superstockDir, fileName)
            FileOutputStream(file).use { fos ->
                fos.write(csvContent.toByteArray(Charsets.UTF_8))
            }
            true
        } catch (e: Exception) {
            Log.e("StatsActivity", "Greška pri legacy èuvanju: ${e.message}")
            false
        }
    }

    private fun createPieChart(products: List<Proizvod>) {
        try {
            val pieChart = findViewById<com.github.mikephil.charting.charts.PieChart>(R.id.pieChart)

            // Izraèunaj distribuciju
            val distribution = mapOf(
                "Nema" to products.count { it.kolicina == 0 },
                "Kritièno" to products.count { it.kolicina in 1..2 },
                "Nisko" to products.count { it.kolicina in 3..5 },
                "Normalno" to products.count { it.kolicina in 6..20 },
                "Visoko" to products.count { it.kolicina > 20 }
            )

            // Filter out zero values for better visualization
            val filteredDistribution = distribution.filter { it.value > 0 }

            if (filteredDistribution.isEmpty()) {
                pieChart.clear()
                pieChart.setNoDataText("Nema podataka za grafik")
                pieChart.setNoDataTextColor(Color.GRAY)
                return
            }

            // Kreiraj unose za grafik
            val entries = filteredDistribution.map {
                com.github.mikephil.charting.data.PieEntry(it.value.toFloat(), it.key)
            }

            val dataSet = com.github.mikephil.charting.data.PieDataSet(entries, "Distribucija zaliha")

            // Boje za svaku kategoriju
            val colors = listOf(
                Color.parseColor("#FF5252"), // Crvena za "Nema"
                Color.parseColor("#FF9800"), // Narandžasta za "Kritièno"
                Color.parseColor("#FFEB3B"), // Žuta za "Nisko"
                Color.parseColor("#4CAF50"), // Zelena za "Normalno"
                Color.parseColor("#2E7D32")  // Tamno zelena za "Visoko"
            )

            dataSet.colors = colors.take(filteredDistribution.size)
            dataSet.valueTextSize = 12f
            dataSet.valueTextColor = Color.WHITE

            val data = com.github.mikephil.charting.data.PieData(dataSet)
            pieChart.data = data

            // Konfiguriši izgled
            pieChart.description.text = "Stanje zaliha"
            pieChart.description.textSize = 14f
            pieChart.setEntryLabelTextSize(12f)
            pieChart.setEntryLabelColor(Color.BLACK)

            pieChart.legend.textSize = 12f
            pieChart.legend.verticalAlignment = com.github.mikephil.charting.components.Legend.LegendVerticalAlignment.BOTTOM
            pieChart.legend.horizontalAlignment = com.github.mikephil.charting.components.Legend.LegendHorizontalAlignment.CENTER

            pieChart.setDrawEntryLabels(true)
            pieChart.setUsePercentValues(true)
            pieChart.setDrawHoleEnabled(true)
            pieChart.holeRadius = 30f
            pieChart.transparentCircleRadius = 35f

            // Animiramo grafikon
            pieChart.animateY(1000, com.github.mikephil.charting.animation.Easing.EaseInOutQuad)

            // Osveži prikaz
            pieChart.invalidate()

        } catch (e: Exception) {
            Log.e("StatsActivity", "Greška pri kreiranju grafikona: ${e.message}")
            // Ako ne postoji PieChart u layout-u, ovo æe fail-ovati - to je OK
        }
    }

    private fun filterProductsByTime(products: List<Proizvod>): List<Proizvod> {
        return when(selectedFilter) {
            "all" -> products

            "today" -> {
                val today = Calendar.getInstance().apply {
                    set(Calendar.HOUR_OF_DAY, 0)
                    set(Calendar.MINUTE, 0)
                    set(Calendar.SECOND, 0)
                    set(Calendar.MILLISECOND, 0)
                }.time

                products.filter { proizvod ->
                    // Ovde treba da koristite stvarni datum proizvoda
                    // Za sada æemo pretpostaviti da su svi danas
                    true
                }
            }

            "week" -> {
                val calendar = Calendar.getInstance()
                calendar.add(Calendar.DAY_OF_YEAR, -7)
                val weekAgo = calendar.time

                products.filter { proizvod ->
                    // Ovde treba da koristite stvarni datum proizvoda
                    true
                }
            }

            "month" -> {
                val calendar = Calendar.getInstance()
                calendar.add(Calendar.MONTH, -1)
                val monthAgo = calendar.time

                products.filter { proizvod ->
                    // Ovde treba da koristite stvarni datum proizvoda
                    true
                }
            }

            "custom" -> {
                if (customStartDate != null && customEndDate != null) {
                    products.filter { proizvod ->
                        // Ovde treba da koristite stvarni datum proizvoda
                        true
                    }
                } else {
                    products
                }
            }

            else -> products
        }
    }

    private fun updateStatistics(products: List<Proizvod>) {
        // Osnovne statistike
        val totalProducts = products.size
        val lowStockCount = products.count { it.kolicina in 1..5 }
        val outOfStockCount = products.count { it.kolicina == 0 }
        val totalQuantity = products.sumOf { it.kolicina }

        tvTotalProducts.text = totalProducts.toString()
        tvLowStockCount.text = lowStockCount.toString()
        tvOutOfStock.text = outOfStockCount.toString()
        tvTotalQuantity.text = totalQuantity.toString()

        // Top 5 niska zaliha
        val lowStockProducts = products
            .filter { it.kolicina <= 5 }
            .sortedBy { it.kolicina }
            .take(5)

        val lowStockText = buildString {
            if (lowStockProducts.isEmpty()) {
                append("Nema proizvoda sa niskom zaliom!")
            } else {
                lowStockProducts.forEachIndexed { index, proizvod ->
                    append("${index + 1}. ${proizvod.naziv} - ${proizvod.kolicina} kom\n")
                    append("   Kategorija: ${proizvod.kategorija}\n\n")
                }
            }
        }
        tvLowStockList.text = lowStockText

        // Statistike po kategorijama
        val categoryStats = products
            .groupBy { it.kategorija }
            .mapValues { (_, proizvodi) ->
                mapOf(
                    "count" to proizvodi.size,
                    "totalQuantity" to proizvodi.sumOf { it.kolicina },
                    "lowStock" to proizvodi.count { it.kolicina <= 5 }
                )
            }
            .toList()
            .sortedByDescending { it.second["count"] as Int }

        val categoryText = buildString {
            if (categoryStats.isEmpty()) {
                append("Nema podataka po kategorijama")
            } else {
                categoryStats.take(5).forEach { (category, stats) ->
                    val categoryName = if (category.length > 20) "${category.substring(0, 17)}..." else category
                    append(" $categoryName:\n")
                    append("     Proizvoda: ${stats["count"]}\n")
                    append("     Ukupno: ${stats["totalQuantity"]} kom\n")
                    append("     Niska zaliha: ${stats["lowStock"]}\n\n")
                }
            }
        }
        tvCategoryStats.text = categoryText

        // Ažuriraj prikaz perioda
        updatePeriodText()
    }

    private fun updatePeriodText() {
        val periodText = when(selectedFilter) {
            "all" -> "Sve vreme"
            "today" -> "Danas (${SimpleDateFormat("dd.MM.yyyy", Locale.getDefault()).format(Date())})"
            "week" -> "Ova nedelja"
            "month" -> "Ovaj mesec (${SimpleDateFormat("MMM yyyy", Locale.getDefault()).format(Date())})"
            "custom" -> {
                if (customStartDate != null && customEndDate != null) {
                    val dateFormat = SimpleDateFormat("dd.MM.yyyy", Locale.getDefault())
                    "${dateFormat.format(customStartDate!!)} - ${dateFormat.format(customEndDate!!)}"
                } else {
                    "Prilagoðeni period"
                }
            }
            else -> "Sve vreme"
        }

        tvPeriod.text = periodText
        tvGeneratedTime.text = SimpleDateFormat("dd.MM.yyyy HH:mm", Locale.getDefault()).format(Date())
    }

    // ===== PDF EXPORT =====

    private fun checkPermissionsAndExportPDF() {
        lastAction = "PDF"
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
            if (Environment.isExternalStorageManager()) {
                exportToPDF()
            } else {
                val intent = Intent(Settings.ACTION_MANAGE_APP_ALL_FILES_ACCESS_PERMISSION)
                intent.data = Uri.parse("package:$packageName")
                startActivityForResult(intent, REQUEST_CODE_MANAGE_STORAGE)
            }
        } else {
            if (ContextCompat.checkSelfPermission(this, Manifest.permission.WRITE_EXTERNAL_STORAGE)
                == PackageManager.PERMISSION_GRANTED) {
                exportToPDF()
            } else {
                ActivityCompat.requestPermissions(
                    this,
                    arrayOf(Manifest.permission.WRITE_EXTERNAL_STORAGE),
                    REQUEST_CODE_WRITE_EXTERNAL_STORAGE
                )
            }
        }
    }

    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray
    ) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)

        when (requestCode) {
            REQUEST_CODE_WRITE_EXTERNAL_STORAGE -> {
                if (grantResults.isNotEmpty() && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                    // Proveri šta je pozvano
                    if (lastAction == "PDF") {
                        exportToPDF()
                    } else if (lastAction == "CSV") {
                        exportToCSVWithMediaStore()
                    }
                } else {
                    Toast.makeText(this, "Dozvola odbijena", Toast.LENGTH_LONG).show()
                }
            }
        }
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)

        if (requestCode == REQUEST_CODE_MANAGE_STORAGE) {
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
                if (Environment.isExternalStorageManager()) {
                    exportToPDF()
                } else {
                    Toast.makeText(this, "Doza odbijena. Ne možete generisati PDF.", Toast.LENGTH_LONG).show()
                }
            }
        }
    }

    private fun exportToPDF() {
        progressBar.visibility = ProgressBar.VISIBLE

        CoroutineScope(Dispatchers.IO).launch {
            try {
                val allProducts = withContext(Dispatchers.IO) {
                    repository.getProizvodiSuspended()
                }
                val filteredProducts = filterProductsByTime(allProducts)
                val pdfFile = createPDFReport(filteredProducts)

                withContext(Dispatchers.Main) {
                    progressBar.visibility = ProgressBar.GONE

                    if (pdfFile != null) {
                        showExportSuccessDialog(pdfFile)
                    } else {
                        Toast.makeText(this@StatsActivity,
                            "Greška pri generisanju PDF-a",
                            Toast.LENGTH_SHORT).show()
                    }
                }

            } catch (e: Exception) {
                Log.e("StatsActivity", "Greška pri PDF exportu: ${e.message}", e)
                withContext(Dispatchers.Main) {
                    progressBar.visibility = ProgressBar.GONE
                    Toast.makeText(this@StatsActivity,
                        "Greška: ${e.message}",
                        Toast.LENGTH_LONG).show()
                }
            }
        }
    }

    private fun createPDFReport(products: List<Proizvod>): File? {
        return try {
            // KREIRAJ DIREKTORIJUM
            val downloadsDir = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
                Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS)
            } else {
                File(Environment.getExternalStorageDirectory(), "Download")
            }

            val reportsDir = File(downloadsDir, "SuperstockGO_Reports")
            if (!reportsDir.exists()) {
                reportsDir.mkdirs()
            }

            // KREIRAJ NAZIV FAJLA
            val timestamp = SimpleDateFormat("yyyyMMdd_HHmmss", Locale.getDefault()).format(Date())
            val fileName = "SuperstockGO_$timestamp.pdf"
            val pdfFile = File(reportsDir, fileName)

            // KREIRAJ PDF
            val document = Document(PageSize.A4)
            PdfWriter.getInstance(document, FileOutputStream(pdfFile))
            document.open()

            // DODAJ SADRŽAJ
            addPDFHeader(document)
            addPDFStats(document, products)
            addPDFProductsByCategory(document, products) // OVO JE NOVA METODA
            addPDFFooter(document)

            document.close()

            pdfFile

        } catch (e: Exception) {
            Log.e("StatsActivity", "PDF greška: ${e.message}")
            null
        }
    }

    private fun addPDFHeaderSimple(document: Document) {
        // Naslov BEZ EMOJI-JA (zbog fontova)
        val titleFont = Font(Font.FontFamily.HELVETICA, 24f, Font.BOLD, BaseColor(0, 102, 204))
        val title = Paragraph("SuperstockGO - Izvestaj", titleFont)
        title.alignment = Element.ALIGN_CENTER
        title.spacingAfter = 20f
        document.add(title)

        // Podnaslov
        val subtitleFont = Font(Font.FontFamily.HELVETICA, 14f, Font.NORMAL, BaseColor.DARK_GRAY)
        val subtitle = Paragraph("Izvestaj o stanju zaliha", subtitleFont)
        subtitle.alignment = Element.ALIGN_CENTER
        subtitle.spacingAfter = 10f
        document.add(subtitle)

        // Period
        val periodFont = Font(Font.FontFamily.HELVETICA, 12f, Font.ITALIC, BaseColor.GRAY)
        val period = Paragraph("Period: ${tvPeriod.text}", periodFont)
        period.alignment = Element.ALIGN_CENTER
        period.spacingAfter = 20f
        document.add(period)

        // Datum generisanja
        val date = Paragraph("Generisano: ${tvGeneratedTime.text}", periodFont)
        date.alignment = Element.ALIGN_CENTER
        date.spacingAfter = 30f
        document.add(date)
    }

    private fun addPDFOverviewSimple(document: Document, products: List<Proizvod>) {
        val totalProducts = products.size
        val lowStockCount = products.count { it.kolicina in 1..5 }
        val outOfStockCount = products.count { it.kolicina == 0 }
        val totalQuantity = products.sumOf { it.kolicina }

        // Napredne statistike
        val averageQuantity = if (products.isNotEmpty()) {
            String.format("%.1f", products.sumOf { it.kolicina } / products.size.toDouble())
        } else "0.0"

        val topCategory = products.groupBy { it.kategorija }
            .maxByOrNull { it.value.size }
            ?.key ?: "Nema"

        val overviewFont = Font(Font.FontFamily.HELVETICA, 14f, Font.BOLD, BaseColor.BLACK)
        val overview = Paragraph("Pregled zaliha", overviewFont)
        overview.spacingAfter = 10f
        document.add(overview)

        val contentFont = Font(Font.FontFamily.HELVETICA, 12f, Font.NORMAL, BaseColor.BLACK)

        val content = """
        Ukupan broj proizvoda: $totalProducts
        Ukupna kolicina: $totalQuantity kom
        Prosecna kolicina: $averageQuantity kom
        Proizvoda sa niskom zaliom (1-5 kom): $lowStockCount
        Proizvoda bez zaliha: $outOfStockCount
        Najzastupljenija kategorija: $topCategory
    """.trimIndent()

        val contentPara = Paragraph(content, contentFont)
        contentPara.spacingAfter = 20f
        document.add(contentPara)
    }

    private fun addPDFLowStockSimple(document: Document, products: List<Proizvod>) {
        val lowStockProducts = products
            .filter { it.kolicina <= 5 }
            .sortedBy { it.kolicina }
            .take(10)

        if (lowStockProducts.isNotEmpty()) {
            val titleFont = Font(Font.FontFamily.HELVETICA, 14f, Font.BOLD, BaseColor.RED)
            val title = Paragraph("Proizvodi sa niskom zaliom (Top 10)", titleFont)
            title.spacingAfter = 10f
            document.add(title)

            val contentFont = Font(Font.FontFamily.HELVETICA, 12f, Font.NORMAL, BaseColor.BLACK)

            lowStockProducts.forEachIndexed { index, proizvod ->
                val item = Paragraph("${index + 1}. ${proizvod.naziv} - ${proizvod.kolicina} kom (${proizvod.kategorija})", contentFont)
                document.add(item)
            }

            document.add(Paragraph(" ", contentFont))
            document.add(Paragraph(" ", contentFont))
        }
    }

    private fun addPDFCategoriesSimple(document: Document, products: List<Proizvod>) {
        val categoryStats = products
            .groupBy { it.kategorija }
            .mapValues { (_, proizvodi) ->
                mapOf(
                    "count" to proizvodi.size,
                    "totalQuantity" to proizvodi.sumOf { it.kolicina }
                )
            }

        if (categoryStats.isNotEmpty()) {
            val titleFont = Font(Font.FontFamily.HELVETICA, 14f, Font.BOLD, BaseColor.BLUE)
            val title = Paragraph("Raspodela po kategorijama", titleFont)
            title.spacingAfter = 10f
            document.add(title)

            // Tabela za kategorije
            val table = PdfPTable(3)
            table.widthPercentage = 100f

            // Zaglavlje tabele
            val headerFont = Font(Font.FontFamily.HELVETICA, 12f, Font.BOLD, BaseColor.WHITE)
            val headerBgColor = BaseColor(0, 102, 204)

            arrayOf("Kategorija", "Broj proizvoda", "Ukupna kolicina").forEach { header ->
                val cell = PdfPCell(Phrase(header, headerFont))
                cell.backgroundColor = headerBgColor
                cell.horizontalAlignment = Element.ALIGN_CENTER
                cell.paddingTop = 8f
                cell.paddingBottom = 8f
                cell.paddingLeft = 8f
                cell.paddingRight = 8f
                table.addCell(cell)
            }

            // Podaci
            val cellFont = Font(Font.FontFamily.HELVETICA, 10f, Font.NORMAL, BaseColor.BLACK)

            categoryStats.forEach { (category, stats) ->
                // Kategorija
                val categoryCell = PdfPCell(Phrase(category, cellFont))
                categoryCell.paddingTop = 6f
                categoryCell.paddingBottom = 6f
                categoryCell.paddingLeft = 6f
                categoryCell.paddingRight = 6f
                table.addCell(categoryCell)

                // Broj proizvoda
                val countCell = PdfPCell(Phrase(stats["count"].toString(), cellFont))
                countCell.horizontalAlignment = Element.ALIGN_CENTER
                countCell.paddingTop = 6f
                countCell.paddingBottom = 6f
                countCell.paddingLeft = 6f
                countCell.paddingRight = 6f
                table.addCell(countCell)

                // Kolicina
                val quantityCell = PdfPCell(Phrase(stats["totalQuantity"].toString(), cellFont))
                quantityCell.horizontalAlignment = Element.ALIGN_CENTER
                quantityCell.paddingTop = 6f
                quantityCell.paddingBottom = 6f
                quantityCell.paddingLeft = 6f
                quantityCell.paddingRight = 6f
                table.addCell(quantityCell)
            }

            document.add(table)
            document.add(Paragraph(" ", cellFont))
        }
    }

    private fun addPDFTableSimple(document: Document, products: List<Proizvod>) {
        if (products.isNotEmpty()) {
            val titleFont = Font(Font.FontFamily.HELVETICA, 14f, Font.BOLD, BaseColor.DARK_GRAY)
            val title = Paragraph("Kompletan spisak proizvoda", titleFont)
            title.spacingAfter = 10f
            document.add(title)

            // Tabela
            val table = PdfPTable(4)
            table.widthPercentage = 100f

            // Zaglavlje
            val headerFont = Font(Font.FontFamily.HELVETICA, 10f, Font.BOLD, BaseColor.WHITE)
            val headerBgColor = BaseColor(79, 129, 189)

            arrayOf("Naziv", "Kategorija", "Kolicina", "Status").forEach { header ->
                val cell = PdfPCell(Phrase(header, headerFont))
                cell.backgroundColor = headerBgColor
                cell.horizontalAlignment = Element.ALIGN_CENTER
                cell.paddingTop = 6f
                cell.paddingBottom = 6f
                cell.paddingLeft = 6f
                cell.paddingRight = 6f
                table.addCell(cell)
            }

            // Podaci
            val cellFont = Font(Font.FontFamily.HELVETICA, 9f, Font.NORMAL, BaseColor.BLACK)

            products.sortedBy { it.naziv }.forEach { proizvod ->
                // Naziv
                val nameCell = PdfPCell(Phrase(proizvod.naziv, cellFont))
                nameCell.paddingTop = 4f
                nameCell.paddingBottom = 4f
                nameCell.paddingLeft = 4f
                nameCell.paddingRight = 4f
                table.addCell(nameCell)

                // Kategorija
                val categoryCell = PdfPCell(Phrase(proizvod.kategorija, cellFont))
                categoryCell.paddingTop = 4f
                categoryCell.paddingBottom = 4f
                categoryCell.paddingLeft = 4f
                categoryCell.paddingRight = 4f
                table.addCell(categoryCell)

                // Kolicina
                val quantityCell = PdfPCell(Phrase("${proizvod.kolicina} kom", cellFont))
                quantityCell.horizontalAlignment = Element.ALIGN_CENTER
                quantityCell.paddingTop = 4f
                quantityCell.paddingBottom = 4f
                quantityCell.paddingLeft = 4f
                quantityCell.paddingRight = 4f
                table.addCell(quantityCell)

                // Status
                val status = when {
                    proizvod.kolicina == 0 -> "NEMA"
                    proizvod.kolicina <= 5 -> "NISKO"
                    else -> "OK"
                }

                val statusColor = when {
                    proizvod.kolicina == 0 -> BaseColor.RED
                    proizvod.kolicina <= 5 -> BaseColor.ORANGE
                    else -> BaseColor.GREEN
                }

                val statusFont = Font(Font.FontFamily.HELVETICA, 9f, Font.BOLD, statusColor)
                val statusCell = PdfPCell(Phrase(status, statusFont))
                statusCell.horizontalAlignment = Element.ALIGN_CENTER
                statusCell.paddingTop = 4f
                statusCell.paddingBottom = 4f
                statusCell.paddingLeft = 4f
                statusCell.paddingRight = 4f
                table.addCell(statusCell)
            }

            document.add(table)
        }
    }

    private fun addPDFFooterSimple(document: Document) {
        document.add(Paragraph(" "))
        document.add(Paragraph(" "))

        val footerFont = Font(Font.FontFamily.HELVETICA, 10f, Font.ITALIC, BaseColor.GRAY)
        val footer = Paragraph("Izvestaj generisan aplikacijom SuperstockGO", footerFont)
        footer.alignment = Element.ALIGN_CENTER
        document.add(footer)
    }
    private fun addBasicStatistics(document: Document, products: List<Proizvod>) {
        val total = products.size
        val lowStock = products.count { it.kolicina in 1..5 }
        val outOfStock = products.count { it.kolicina == 0 }
        val totalQuantity = products.sumOf { it.kolicina }

        val statsFont = Font(Font.FontFamily.HELVETICA, 14f, Font.BOLD, BaseColor.BLACK)
        val statsTitle = Paragraph("Osnovne statistike", statsFont)
        statsTitle.spacingAfter = 10f
        document.add(statsTitle)

        val contentFont = Font(Font.FontFamily.HELVETICA, 12f, Font.NORMAL, BaseColor.BLACK)

        val statsText = """
        Ukupan broj proizvoda: $total
        Ukupna kolicina: $totalQuantity kom
        Proizvoda sa niskom zaliom (1-5 kom): $lowStock
        Proizvoda bez zaliha: $outOfStock
    """.trimIndent()

        val contentPara = Paragraph(statsText, contentFont)
        contentPara.spacingAfter = 20f
        document.add(contentPara)
    }

    private fun addProductsTable(document: Document, products: List<Proizvod>) {
        if (products.isEmpty()) return

        val titleFont = Font(Font.FontFamily.HELVETICA, 14f, Font.BOLD, BaseColor.DARK_GRAY)
        val title = Paragraph("Spisak proizvoda", titleFont)
        title.spacingAfter = 10f
        document.add(title)

        // Kreiraj tabelu sa 4 kolone
        val table = PdfPTable(4)
        table.widthPercentage = 100f

        // Zaglavlje tabele
        val headerFont = Font(Font.FontFamily.HELVETICA, 10f, Font.BOLD, BaseColor.WHITE)
        val headerBgColor = BaseColor(79, 129, 189)

        // ENGLESKI NASLOVI da bi PDF radio
        val headers = arrayOf("Name", "Category", "Quantity", "Status")

        headers.forEach { header ->
            val cell = PdfPCell(Phrase(header, headerFont))
            cell.backgroundColor = headerBgColor
            cell.horizontalAlignment = Element.ALIGN_CENTER
            cell.paddingTop = 6f
            cell.paddingBottom = 6f
            table.addCell(cell)
        }

        // Podaci - srpski karakteri æe raditi u sadržaju
        val cellFont = Font(Font.FontFamily.HELVETICA, 9f, Font.NORMAL, BaseColor.BLACK)

        products.sortedBy { it.naziv }.forEach { proizvod ->
            // Naziv (može imati srpske karaktere)
            table.addCell(PdfPCell(Phrase(proizvod.naziv, cellFont)))

            // Kategorija
            table.addCell(PdfPCell(Phrase(proizvod.kategorija, cellFont)))

            // Kolièina
            val quantityCell = PdfPCell(Phrase("${proizvod.kolicina} kom", cellFont))
            quantityCell.horizontalAlignment = Element.ALIGN_CENTER
            table.addCell(quantityCell)

            // Status
            val status = when {
                proizvod.kolicina == 0 -> "NEMA"
                proizvod.kolicina <= 5 -> "NISKO"
                else -> "OK"
            }

            val statusColor = when {
                proizvod.kolicina == 0 -> BaseColor.RED
                proizvod.kolicina <= 5 -> BaseColor.ORANGE
                else -> BaseColor.GREEN
            }

            val statusFont = Font(Font.FontFamily.HELVETICA, 9f, Font.BOLD, statusColor)
            val statusCell = PdfPCell(Phrase(status, statusFont))
            statusCell.horizontalAlignment = Element.ALIGN_CENTER
            table.addCell(statusCell)
        }

        document.add(table)
    }

    // U PDF kreiranju, promenite:
    private fun addPDFHeader(document: Document) {
        val title = Paragraph("SUPERSTOCKGO - KOMPLETAN IZVEŠTAJ\n\n",
            Font(Font.FontFamily.HELVETICA, 20f, Font.BOLD, BaseColor(0, 102, 204)))
        title.alignment = Element.ALIGN_CENTER
        document.add(title)

        val date = Paragraph("Datum: ${SimpleDateFormat("dd.MM.yyyy HH:mm", Locale.getDefault()).format(Date())}\n\n",
            Font(Font.FontFamily.HELVETICA, 12f, Font.NORMAL, BaseColor.BLACK))
        date.alignment = Element.ALIGN_CENTER
        document.add(date)
    }



    private fun addPDFOverview(document: Document, products: List<Proizvod>) {
        val totalProducts = products.size
        val lowStockCount = products.count { it.kolicina in 1..5 }
        val outOfStockCount = products.count { it.kolicina == 0 }
        val totalQuantity = products.sumOf { it.kolicina }

        val overviewFont = Font(Font.FontFamily.HELVETICA, 14f, Font.BOLD, BaseColor.BLACK)
        val overview = Paragraph("Pregled zaliha", overviewFont)
        overview.spacingAfter = 10f
        document.add(overview)

        val contentFont = Font(Font.FontFamily.HELVETICA, 12f, Font.NORMAL, BaseColor.BLACK)

        val content = """
            Ukupan broj proizvoda: $totalProducts
            Ukupna kolièina: $totalQuantity kom
            Proizvoda sa niskom zaliom (1-5 kom): $lowStockCount
            Proizvoda bez zaliha: $outOfStockCount
        """.trimIndent()

        val contentPara = Paragraph(content, contentFont)
        contentPara.spacingAfter = 20f
        document.add(contentPara)
    }

    private fun addPDFLowStock(document: Document, products: List<Proizvod>) {
        val lowStockProducts = products
            .filter { it.kolicina <= 5 }
            .sortedBy { it.kolicina }
            .take(10)

        if (lowStockProducts.isNotEmpty()) {
            val titleFont = Font(Font.FontFamily.HELVETICA, 14f, Font.BOLD, BaseColor.RED)
            val title = Paragraph("Proizvodi sa niskom zaliom (Top 10)", titleFont)
            title.spacingAfter = 10f
            document.add(title)

            val contentFont = Font(Font.FontFamily.HELVETICA, 12f, Font.NORMAL, BaseColor.BLACK)

            lowStockProducts.forEachIndexed { index, proizvod ->
                val item = Paragraph("${index + 1}. ${proizvod.naziv} - ${proizvod.kolicina} kom (${proizvod.kategorija})", contentFont)
                document.add(item)
            }

            document.add(Paragraph(" ", contentFont))
            document.add(Paragraph(" ", contentFont))
        }
    }

    private fun addPDFCategories(document: Document, products: List<Proizvod>) {
        val categoryStats = products
            .groupBy { it.kategorija }
            .mapValues { (_, proizvodi) ->
                mapOf(
                    "count" to proizvodi.size,
                    "totalQuantity" to proizvodi.sumOf { it.kolicina }
                )
            }

        if (categoryStats.isNotEmpty()) {
            val titleFont = Font(Font.FontFamily.HELVETICA, 14f, Font.BOLD, BaseColor.BLUE)
            val title = Paragraph("Raspodela po kategorijama", titleFont)
            title.spacingAfter = 10f
            document.add(title)

            // Tabela za kategorije
            val table = PdfPTable(3)
            table.widthPercentage = 100f

            // Zaglavlje tabele
            val headerFont = Font(Font.FontFamily.HELVETICA, 12f, Font.BOLD, BaseColor.WHITE)
            val headerBgColor = BaseColor(0, 102, 204)

            arrayOf("Kategorija", "Broj proizvoda", "Ukupna kolièina").forEach { header ->
                val cell = PdfPCell(Phrase(header, headerFont))
                cell.backgroundColor = headerBgColor
                cell.horizontalAlignment = Element.ALIGN_CENTER
                cell.paddingTop = 8f
                cell.paddingBottom = 8f
                cell.paddingLeft = 8f
                cell.paddingRight = 8f
                table.addCell(cell)
            }

            // Podaci
            val cellFont = Font(Font.FontFamily.HELVETICA, 10f, Font.NORMAL, BaseColor.BLACK)

            categoryStats.forEach { (category, stats) ->
                // Kategorija
                val categoryCell = PdfPCell(Phrase(category, cellFont))
                categoryCell.paddingTop = 6f
                categoryCell.paddingBottom = 6f
                categoryCell.paddingLeft = 6f
                categoryCell.paddingRight = 6f
                table.addCell(categoryCell)

                // Broj proizvoda
                val countCell = PdfPCell(Phrase(stats["count"].toString(), cellFont))
                countCell.horizontalAlignment = Element.ALIGN_CENTER
                countCell.paddingTop = 6f
                countCell.paddingBottom = 6f
                countCell.paddingLeft = 6f
                countCell.paddingRight = 6f
                table.addCell(countCell)

                // Kolièina
                val quantityCell = PdfPCell(Phrase(stats["totalQuantity"].toString(), cellFont))
                quantityCell.horizontalAlignment = Element.ALIGN_CENTER
                quantityCell.paddingTop = 6f
                quantityCell.paddingBottom = 6f
                quantityCell.paddingLeft = 6f
                quantityCell.paddingRight = 6f
                table.addCell(quantityCell)
            }

            document.add(table)
            document.add(Paragraph(" ", cellFont))
        }
    }

    private fun addPDFTable(document: Document, products: List<Proizvod>) {
        if (products.isNotEmpty()) {
            val titleFont = Font(Font.FontFamily.HELVETICA, 14f, Font.BOLD, BaseColor.DARK_GRAY)
            val title = Paragraph("Kompletan spisak proizvoda", titleFont)
            title.spacingAfter = 10f
            document.add(title)

            // Tabela
            val table = PdfPTable(4)
            table.widthPercentage = 100f

            // Zaglavlje
            val headerFont = Font(Font.FontFamily.HELVETICA, 10f, Font.BOLD, BaseColor.WHITE)
            val headerBgColor = BaseColor(79, 129, 189)

            arrayOf("Naziv", "Kategorija", "Kolièina", "Status").forEach { header ->
                val cell = PdfPCell(Phrase(header, headerFont))
                cell.backgroundColor = headerBgColor
                cell.horizontalAlignment = Element.ALIGN_CENTER
                cell.paddingTop = 6f
                cell.paddingBottom = 6f
                cell.paddingLeft = 6f
                cell.paddingRight = 6f
                table.addCell(cell)
            }

            // Podaci
            val cellFont = Font(Font.FontFamily.HELVETICA, 9f, Font.NORMAL, BaseColor.BLACK)

            products.sortedBy { it.naziv }.forEach { proizvod ->
                // Naziv
                val nameCell = PdfPCell(Phrase(proizvod.naziv, cellFont))
                nameCell.paddingTop = 4f
                nameCell.paddingBottom = 4f
                nameCell.paddingLeft = 4f
                nameCell.paddingRight = 4f
                table.addCell(nameCell)

                // Kategorija
                val categoryCell = PdfPCell(Phrase(proizvod.kategorija, cellFont))
                categoryCell.paddingTop = 4f
                categoryCell.paddingBottom = 4f
                categoryCell.paddingLeft = 4f
                categoryCell.paddingRight = 4f
                table.addCell(categoryCell)

                // Kolièina
                val quantityCell = PdfPCell(Phrase("${proizvod.kolicina} kom", cellFont))
                quantityCell.horizontalAlignment = Element.ALIGN_CENTER
                quantityCell.paddingTop = 4f
                quantityCell.paddingBottom = 4f
                quantityCell.paddingLeft = 4f
                quantityCell.paddingRight = 4f
                table.addCell(quantityCell)

                // Status
                val status = when {
                    proizvod.kolicina == 0 -> "NEMA"
                    proizvod.kolicina <= 5 -> "NISKO"
                    else -> "OK"
                }

                val statusColor = when {
                    proizvod.kolicina == 0 -> BaseColor.RED
                    proizvod.kolicina <= 5 -> BaseColor.ORANGE
                    else -> BaseColor.GREEN
                }

                val statusFont = Font(Font.FontFamily.HELVETICA, 9f, Font.BOLD, statusColor)
                val statusCell = PdfPCell(Phrase(status, statusFont))
                statusCell.horizontalAlignment = Element.ALIGN_CENTER
                statusCell.paddingTop = 4f
                statusCell.paddingBottom = 4f
                statusCell.paddingLeft = 4f
                statusCell.paddingRight = 4f
                table.addCell(statusCell)
            }

            document.add(table)
        }
    }

    // DODAJTE OVU METODU ZA STATISTIKE:
    private fun addPDFStats(document: Document, products: List<Proizvod>) {
        val statsTitle = Paragraph("STATISTIKA\n",
            Font(Font.FontFamily.HELVETICA, 16f, Font.BOLD, BaseColor.BLACK))
        statsTitle.spacingAfter = 10f
        document.add(statsTitle)

        val total = products.size
        val lowStock = products.count { it.kolicina in 1..5 }
        val outOfStock = products.count { it.kolicina == 0 }
        val totalQuantity = products.sumOf { it.kolicina }
        val averageQuantity = if (total > 0)
            String.format("%.1f", totalQuantity.toDouble() / total)
        else "0.0"

        val statsText = """
        Ukupno proizvoda: $total
        Ukupna kolicina: $totalQuantity kom
        Prosecna kolicina: $averageQuantity kom
        Niska zaliha (1-5 kom): $lowStock
        Bez zaliha: $outOfStock
        
    """.trimIndent()

        val stats = Paragraph(statsText,
            Font(Font.FontFamily.HELVETICA, 12f, Font.NORMAL, BaseColor.BLACK))
        stats.spacingAfter = 20f
        document.add(stats)
    }

    // DODAJTE OVU METODU ZA PROIZVODE PO KATEGORIJAMA (KLJUÈNA!):
    private fun addPDFProductsByCategory(document: Document, products: List<Proizvod>) {
        if (products.isEmpty()) return

        val tableTitle = Paragraph("KOMPLETAN SPISAK PROIZVODA\n",
            Font(Font.FontFamily.HELVETICA, 16f, Font.BOLD, BaseColor.BLACK))
        tableTitle.spacingAfter = 15f
        document.add(tableTitle)

        // GRUPIŠI PROIZVODE PO KATEGORIJAMA
        val productsByCategory = products.groupBy { it.kategorija }

        productsByCategory.forEach { (category, categoryProducts) ->
            // NASLOV KATEGORIJE (BEZ EMOJI-JA ZBOG PDF FONTOVA)
            val categoryTitle = Paragraph("KATEGORIJA: $category (${categoryProducts.size} proizvoda)\n",
                Font(Font.FontFamily.HELVETICA, 14f, Font.BOLD, BaseColor(0, 102, 204)))
            categoryTitle.spacingAfter = 10f
            document.add(categoryTitle)

            // KREIRAJ TABELU
            val table = PdfPTable(3)
            table.widthPercentage = 100f
            table.setWidths(floatArrayOf(4f, 1.5f, 1.5f))

            // ZAGLAVLJE
            val headers = arrayOf("NAZIV PROIZVODA", "KOLICINA", "STATUS")
            headers.forEach { header ->
                val cell = PdfPCell(Phrase(header,
                    Font(Font.FontFamily.HELVETICA, 10f, Font.BOLD, BaseColor.WHITE)))
                cell.backgroundColor = BaseColor(79, 129, 189)
                cell.horizontalAlignment = Element.ALIGN_CENTER
                cell.setPadding(5f)
                table.addCell(cell)
            }

            // PROIZVODI
            categoryProducts.sortedBy { it.naziv }.forEach { proizvod ->
                // NAZIV
                table.addCell(PdfPCell(Phrase(proizvod.naziv,
                    Font(Font.FontFamily.HELVETICA, 9f, Font.NORMAL, BaseColor.BLACK))))

                // KOLIÈINA
                val qtyCell = PdfPCell(Phrase("${proizvod.kolicina} kom",
                    Font(Font.FontFamily.HELVETICA, 9f, Font.NORMAL, BaseColor.BLACK)))
                qtyCell.horizontalAlignment = Element.ALIGN_CENTER
                table.addCell(qtyCell)

                // STATUS
                val status = when {
                    proizvod.kolicina == 0 -> "NEMA"
                    proizvod.kolicina <= 5 -> "NISKO"
                    else -> "OK"
                }

                val statusColor = when {
                    proizvod.kolicina == 0 -> BaseColor.RED
                    proizvod.kolicina <= 5 -> BaseColor.ORANGE
                    else -> BaseColor.GREEN
                }

                val statusCell = PdfPCell(Phrase(status,
                    Font(Font.FontFamily.HELVETICA, 9f, Font.BOLD, statusColor)))
                statusCell.horizontalAlignment = Element.ALIGN_CENTER
                table.addCell(statusCell)
            }

            document.add(table)
            document.add(Paragraph("\n"))
        }
    }

    private fun saveCSVFileCompatible(csvContent: String): Boolean {
        return try {
            val timestamp = SimpleDateFormat("yyyyMMdd_HHmmss", Locale.getDefault()).format(Date())
            val fileName = "SuperstockGO_${timestamp}.csv"

            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
                saveCSVWithMediaStore(csvContent, fileName)
            } else {
                saveCSVLegacy(csvContent, fileName)
            }
        } catch (e: Exception) {
            Log.e("StatsActivity", "Greška pri èuvanju CSV: ${e.message}")
            false
        }
    }
    private fun addPDFFooter(document: Document) {
        document.add(Paragraph(" "))
        document.add(Paragraph(" "))

        val footerFont = Font(Font.FontFamily.HELVETICA, 10f, Font.ITALIC, BaseColor.GRAY)
        val footer = Paragraph("Izveštaj generisan aplikacijom SuperstockGO\nwww.superstockgo.com", footerFont)
        footer.alignment = Element.ALIGN_CENTER
        document.add(footer)
    }

    private fun showExportSuccessDialog(pdfFile: File) {
        AlertDialog.Builder(this)
            .setTitle(" PDF uspešno generisan!")
            .setMessage("Izveštaj je saèuvan u: ${pdfFile.absolutePath}")
            .setPositiveButton("Otvori PDF") { _, _ ->
                openPDFFile(pdfFile)
            }
            .setNegativeButton("Podeli") { _, _ ->
                sharePDFFile(pdfFile)
            }
            .setNeutralButton("OK") { _, _ -> }
            .show()
    }

    private fun openPDFFile(pdfFile: File) {
        val uri = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {
            FileProvider.getUriForFile(this, "$packageName.provider", pdfFile)
        } else {
            Uri.fromFile(pdfFile)
        }

        val intent = Intent(Intent.ACTION_VIEW)
        intent.setDataAndType(uri, "application/pdf")
        intent.flags = Intent.FLAG_GRANT_READ_URI_PERMISSION

        if (intent.resolveActivity(packageManager) != null) {
            startActivity(intent)
        } else {
            Toast.makeText(this, "Nema aplikacije za prikaz PDF-a", Toast.LENGTH_SHORT).show()
        }
    }

    private fun sharePDFFile(pdfFile: File) {
        val uri = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {
            FileProvider.getUriForFile(this, "$packageName.provider", pdfFile)
        } else {
            Uri.fromFile(pdfFile)
        }

        val shareIntent = Intent().apply {
            action = Intent.ACTION_SEND
            putExtra(Intent.EXTRA_STREAM, uri)
            type = "application/pdf"
            addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
        }

        startActivity(Intent.createChooser(shareIntent, "Podeli PDF izveštaj"))
    }

    private fun shareReport() {
        progressBar.visibility = ProgressBar.VISIBLE

        CoroutineScope(Dispatchers.IO).launch {
            try {
                val proizvodi = repository.getProizvodiSuspended()

                val shareText = buildString {
                    append("?? SUPERSTOCKGO - PREGLED ZALIHA\n")
                    append("Datum: ${SimpleDateFormat("dd.MM.yyyy", Locale.getDefault()).format(Date())}\n")
                    append("\n")

                    // OSNOVNE STATISTIKE
                    append("?? STATISTIKA:\n")
                    append("• Ukupno proizvoda: ${proizvodi.size}\n")
                    append("• Niska zaliha: ${proizvodi.count { it.kolicina in 1..5 }}\n")
                    append("• Bez zaliha: ${proizvodi.count { it.kolicina == 0 }}\n")
                    append("\n")

                    // TOP 5 PROIZVODA PO KATEGORIJI
                    append("?? NAJVAŽNIJE:\n")

                    // PROIZVODI BEZ ZALIHE
                    val noStock = proizvodi.filter { it.kolicina == 0 }.take(5)
                    if (noStock.isNotEmpty()) {
                        append("?? HITNO NARUÈITI:\n")
                        noStock.forEach {
                            append("   - ${it.naziv} (${it.kategorija})\n")
                        }
                        append("\n")
                    }

                    // PROIZVODI SA NISKOM ZALIHOM
                    val lowStock = proizvodi.filter { it.kolicina in 1..5 }.take(5)
                    if (lowStock.isNotEmpty()) {
                        append("?? NARUÈITI USKORO:\n")
                        lowStock.forEach {
                            append("   - ${it.naziv} (${it.kategorija}) - ${it.kolicina} kom\n")
                        }
                        append("\n")
                    }

                    // UKUPAN BROJ PO KATEGORIJAMA
                    append("?? PO KATEGORIJAMA:\n")
                    proizvodi.groupBy { it.kategorija }.forEach { (category, items) ->
                        append("• $category: ${items.size} proizvoda\n")
                    }

                    append("\n")
                    append("?? Generisano SuperstockGO aplikacijom")
                    append("\n")
                    append("#inventory #stock #superstockgo")
                }

                withContext(Dispatchers.Main) {
                    progressBar.visibility = ProgressBar.GONE

                    val shareIntent = Intent().apply {
                        action = Intent.ACTION_SEND
                        putExtra(Intent.EXTRA_TEXT, shareText.toString())
                        type = "text/plain"
                    }

                    startActivity(Intent.createChooser(shareIntent, "Podeli izveštaj"))
                }
            } catch (e: Exception) {
                withContext(Dispatchers.Main) {
                    progressBar.visibility = ProgressBar.GONE
                    Toast.makeText(this@StatsActivity,
                        "Greška pri deljenju izveštaja",
                        Toast.LENGTH_SHORT).show()
                }
            }
        }
    }

    override fun onSupportNavigateUp(): Boolean {
        finish()
        return true
    }
}


FILE: app\src\main\res\drawable\card_background.xml

<?xml version="1.0" encoding="utf-8"?>
<shape xmlns:android="http://schemas.android.com/apk/res/android">
    <solid android:color="@android:color/white"/>
    <corners android:radius="8dp"/>
    <stroke
        android:width="1dp"
        android:color="@color/darker_gray"/>
</shape>


FILE: app\src\main\res\drawable\ic_cloud_upload.xml

<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="24dp"
    android:height="24dp"
    android:viewportWidth="24"
    android:viewportHeight="24">
    <path
        android:fillColor="#FF000000"
        android:pathData="M19.35,10.04C18.67,6.59 15.64,4 12,4C9.11,4 6.6,5.64 5.35,8.04C2.34,8.36 0,10.91 0,14c0,3.31 2.69,6 6,6h13c2.76,0 5,-2.24 5,-5c0,-2.64 -2.05,-4.78 -4.65,-4.96zM14,13v4h-4v-4H7l5,-5 5,5h-3z"/>
</vector>


FILE: app\src\main\res\drawable\ic_launcher_background.xml

<?xml version="1.0" encoding="utf-8"?>
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="108dp"
    android:height="108dp"
    android:viewportWidth="108"
    android:viewportHeight="108">
    <path android:fillColor="#3DDC84"
          android:pathData="M0,0h108v108h-108z"/>
    <path android:fillColor="#00000000" android:pathData="M9,0L9,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,0L19,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M29,0L29,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M39,0L39,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M49,0L49,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M59,0L59,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M69,0L69,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M79,0L79,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M89,0L89,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M99,0L99,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,9L108,9"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,19L108,19"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,29L108,29"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,39L108,39"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,49L108,49"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,59L108,59"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,69L108,69"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,79L108,79"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,89L108,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,99L108,99"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,29L89,29"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,39L89,39"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,49L89,49"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,59L89,59"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,69L89,69"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,79L89,79"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M29,19L29,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M39,19L39,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M49,19L49,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M59,19L59,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M69,19L69,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M79,19L79,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
</vector>



FILE: app\src\main\res\drawable\ic_launcher_foreground.xml

<vector xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:aapt="http://schemas.android.com/aapt"
    android:width="108dp"
    android:height="108dp"
    android:viewportWidth="108"
    android:viewportHeight="108">
    <path android:pathData="M31,63.928c0,0 6.4,-11 12.1,-13.1c7.2,-2.6 26,-1.4 26,-1.4l38.1,38.1L107,108.928l-32,-1L31,63.928z">
        <aapt:attr name="android:fillColor">
            <gradient
                android:endX="85.84757"
                android:endY="92.4963"
                android:startX="42.9492"
                android:startY="49.59793"
                android:type="linear">
                <item
                    android:color="#44000000"
                    android:offset="0.0" />
                <item
                    android:color="#00000000"
                    android:offset="1.0" />
            </gradient>
        </aapt:attr>
    </path>
    <path
        android:fillColor="#FFFFFF"
        android:fillType="nonZero"
        android:pathData="M65.3,45.828l3.8,-6.6c0.2,-0.4 0.1,-0.9 -0.3,-1.1c-0.4,-0.2 -0.9,-0.1 -1.1,0.3l-3.9,6.7c-6.3,-2.8 -13.4,-2.8 -19.7,0l-3.9,-6.7c-0.2,-0.4 -0.7,-0.5 -1.1,-0.3C38.8,38.328 38.7,38.828 38.9,39.228l3.8,6.6C36.2,49.428 31.7,56.028 31,63.928h46C76.3,56.028 71.8,49.428 65.3,45.828zM43.4,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2c-0.3,-0.7 -0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C45.3,56.528 44.5,57.328 43.4,57.328L43.4,57.328zM64.6,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2s-0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C66.5,56.528 65.6,57.328 64.6,57.328L64.6,57.328z"
        android:strokeWidth="1"
        android:strokeColor="#00000000" />
</vector>


FILE: app\src\main\res\drawable\ic_minus.xml

<?xml version="1.0" encoding="utf-8"?>
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="24dp"
    android:height="24dp"
    android:viewportWidth="24"
    android:viewportHeight="24">
    <path
        android:fillColor="#FF000000"
        android:pathData="M19,13H5v-2h14v2z" />
</vector>


FILE: app\src\main\res\drawable\ic_more_white.xml

<?xml version="1.0" encoding="utf-8"?>
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="24dp"
    android:height="24dp"
    android:viewportWidth="24"
    android:viewportHeight="24"
    android:tint="@color/white">
    <path
        android:fillColor="@android:color/white"
        android:pathData="M12,8c1.1,0 2,-0.9 2,-2s-0.9,-2 -2,-2 -2,0.9 -2,2 0.9,2 2,2zM12,10c-1.1,0 -2,0.9 -2,2s0.9,2 2,2 2,-0.9 2,-2 -0.9,-2 -2,-2zM12,16c-1.1,0 -2,0.9 -2,2s0.9,2 2,2 2,-0.9 2,-2 -0.9,-2 -2,-2z" />
</vector>


FILE: app\src\main\res\drawable\ic_notification.xml

<?xml version="1.0" encoding="utf-8"?>
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="24dp"
    android:height="24dp"
    android:viewportWidth="24"
    android:viewportHeight="24">

    <path
        android:fillColor="#FFFFFF"
        android:pathData="M12,2C6.48,2 2,6.48 2,12s4.48,10 10,10 10,-4.48 10,-10S17.52,2 12,2zM17,15h-4v4h-2v-4H7v-2h4V9h2v4h4v2z"/>

</vector>


FILE: app\src\main\res\layout\activity_backup_restore.xml

<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp">

    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="?? Lokalni Backup &amp; Restore"
        android:textSize="24sp"
        android:textStyle="bold"
        android:layout_marginBottom="16dp" />

    <TextView
        android:id="@+id/tvStatus"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Status: Spreman"
        android:layout_marginBottom="16dp" />

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal"
        android:layout_marginBottom="16dp">

        <Button
            android:id="@+id/btnCreateBackup"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="?? Kreiraj Backup"
            android:layout_marginEnd="8dp"
            android:backgroundTint="@color/purple_500" />

        <Button
            android:id="@+id/btnRestoreBackup"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="?? Restore Backup"
            android:layout_marginStart="8dp"
            android:backgroundTint="@color/teal_700" />

    </LinearLayout>

    <Button
        android:id="@+id/btnExportCSV"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="?? Export u CSV"
        android:layout_marginBottom="16dp"
        android:backgroundTint="@color/green_light" />

    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Dostupni backup fajlovi:"
        android:textStyle="bold"
        android:layout_marginBottom="8dp" />

    <ListView
        android:id="@+id/listViewBackups"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"
        android:layout_marginBottom="16dp" />

    <ProgressBar
        android:id="@+id/progressBar"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_gravity="center"
        android:visibility="gone" />

    <Button
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Nazad"
        android:onClick="finish" />

</LinearLayout>


FILE: app\src\main\res\layout\activity_cloud_sync.xml

<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="24dp"
    android:gravity="center">

    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="?? Cloud Sinhronizacija"
        android:textSize="24sp"
        android:textStyle="bold"
        android:layout_marginBottom="32dp" />

    <Button
        android:id="@+id/btnBackup"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="?? Backup u Cloud"
        android:layout_marginBottom="16dp" />

    <Button
        android:id="@+id/btnRestore"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="?? Restore iz Cloud-a"
        android:layout_marginBottom="16dp" />

    <Button
        android:id="@+id/btnSyncBothWays"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="?? Dvosmerna sinhronizacija"
        android:layout_marginBottom="32dp"
        android:backgroundTint="@color/purple_500"
        android:textColor="@color/white" />

    <ProgressBar
        android:id="@+id/progressBar"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:visibility="gone" />

    <TextView
        android:id="@+id/tvStatus"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Status: Proveravam..."
        android:textSize="16sp"
        android:layout_marginTop="16dp" />

</LinearLayout>


FILE: app\src\main\res\layout\activity_dodaj_izmeni.xml

<?xml version="1.0" encoding="utf-8"?>
<ScrollView xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:padding="16dp">

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="vertical"
        android:padding="16dp">

        <TextView
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="Dodaj/Izmeni proizvod"
            android:textSize="24sp"
            android:textStyle="bold"
            android:layout_marginBottom="24dp" />

        <com.google.android.material.textfield.TextInputLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginBottom="16dp"
            app:hintEnabled="true">

            <com.google.android.material.textfield.TextInputEditText
                android:id="@+id/etNaziv"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:hint="Naziv proizvoda"
                android:inputType="text" />

        </com.google.android.material.textfield.TextInputLayout>

        <com.google.android.material.textfield.TextInputLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginBottom="16dp"
            app:hintEnabled="true">

            <AutoCompleteTextView
                android:id="@+id/autoCompleteKategorija"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:hint="Kategorija"
                android:inputType="text" />

        </com.google.android.material.textfield.TextInputLayout>

        <com.google.android.material.textfield.TextInputLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginBottom="24dp"
            app:hintEnabled="true">

            <com.google.android.material.textfield.TextInputEditText
                android:id="@+id/etKolicina"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:hint="Kolièina"
                android:inputType="number" />

        </com.google.android.material.textfield.TextInputLayout>

        <Button
            android:id="@+id/btnSacuvaj"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="Saèuvaj"
            android:textSize="18sp" />

    </LinearLayout>

</ScrollView>


FILE: app\src\main\res\layout\activity_kategorije.xml

<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:background="@color/light_gray">

    <androidx.appcompat.widget.Toolbar
        android:id="@+id/toolbar"
        android:layout_width="match_parent"
        android:layout_height="?attr/actionBarSize"
        android:background="@color/purple_500"
        android:theme="@style/ThemeOverlay.AppCompat.Dark.ActionBar"
        app:title="SuperstockGO - Kategorije" />

    <androidx.recyclerview.widget.RecyclerView
        android:id="@+id/rvKategorije"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:padding="8dp" />

</LinearLayout>


FILE: app\src\main\res\layout\activity_login.xml

<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:gravity="center"
    android:padding="24dp"
    android:background="@color/purple_500">

    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="SuperstockGO"
        android:textSize="32sp"
        android:textColor="@color/white"
        android:textStyle="bold"
        android:layout_marginBottom="48dp" />

    <com.google.android.material.textfield.TextInputLayout
        android:id="@+id/emailLayout"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginBottom="16dp"
        style="@style/Widget.MaterialComponents.TextInputLayout.OutlinedBox"
        app:boxBackgroundColor="@color/white">

        <com.google.android.material.textfield.TextInputEditText
            android:id="@+id/etEmail"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:hint="Email"
            android:inputType="textEmailAddress"
            android:textColor="@color/black" />

    </com.google.android.material.textfield.TextInputLayout>

    <com.google.android.material.textfield.TextInputLayout
        android:id="@+id/passwordLayout"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginBottom="32dp"
        style="@style/Widget.MaterialComponents.TextInputLayout.OutlinedBox"
        app:boxBackgroundColor="@color/white">

        <com.google.android.material.textfield.TextInputEditText
            android:id="@+id/etPassword"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:hint="Lozinka"
            android:inputType="textPassword"
            android:textColor="@color/black" />

    </com.google.android.material.textfield.TextInputLayout>

    <Button
        android:id="@+id/btnLogin"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="PRIJAVA"
        android:textSize="18sp"
        android:textStyle="bold"
        android:backgroundTint="@color/teal_200"
        android:layout_marginBottom="16dp" />

    <Button
        android:id="@+id/btnRegister"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="REGISTRACIJA"
        android:textSize="16sp"
        android:backgroundTint="@android:color/transparent"
        android:textColor="@color/white" />

    <TextView
        android:id="@+id/tvStatus"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Status: Niste prijavljeni"
        android:textColor="@color/white"
        android:layout_marginTop="24dp" />

    <Button
        android:id="@+id/btnContinue"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="NASTAVI KAO [EMAIL]"
        android:textSize="16sp"
        android:backgroundTint="@color/teal_200"
        android:visibility="gone"
        android:layout_marginTop="16dp" />

    <Button
        android:id="@+id/btnLogout"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="ODJAVI SE"
        android:textSize="14sp"
        android:backgroundTint="@color/red_light"
        android:textColor="@color/white"
        android:visibility="gone"
        android:layout_marginTop="8dp" />

    <TextView
        android:id="@+id/tvSwitchUser"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="?? Drugi korisnik?"
        android:textColor="@color/white"
        android:layout_marginTop="8dp"
        android:visibility="gone"
        android:clickable="true"
        android:focusable="true"
        android:textStyle="bold"
        android:padding="8dp" />

</LinearLayout>


FILE: app\src\main\res\layout\activity_main.xml

<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    tools:context=".MainActivity">

    <androidx.appcompat.widget.Toolbar
        android:id="@+id/toolbar"
        android:layout_width="match_parent"
        android:layout_height="?attr/actionBarSize"
        android:background="@color/purple_500"
        android:theme="@style/ThemeOverlay.AppCompat.Dark.ActionBar" />

    <androidx.recyclerview.widget.RecyclerView
        android:id="@+id/recyclerView"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"
        android:padding="8dp" />

    <com.google.android.material.floatingactionbutton.FloatingActionButton
        android:id="@+id/fabAdd"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_gravity="end|bottom"
        android:layout_margin="16dp"
        android:contentDescription="Dodaj novi proizvod"
        app:srcCompat="@android:drawable/ic_input_add" />

</LinearLayout>


FILE: app\src\main\res\layout\activity_simple_stats.xml

<?xml version="1.0" encoding="utf-8"?>
<ScrollView xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="@color/light_gray">

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="vertical"
        android:padding="16dp">

        <!-- Toolbar -->
        <androidx.appcompat.widget.Toolbar
            android:id="@+id/toolbar"
            android:layout_width="match_parent"
            android:layout_height="?attr/actionBarSize"
            android:background="@color/purple_500"
            app:title="Statistike"
            app:titleTextColor="@color/white" />

        <!-- Osnovne statistike -->
        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="vertical"
            android:layout_marginBottom="16dp"
            android:padding="16dp"
            android:background="@android:color/white"
            android:elevation="4dp">

            <TextView
                android:id="@+id/tvTotalProducts"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="?? Ukupno proizvoda: 0"
                android:textSize="16sp"
                android:layout_marginBottom="8dp" />

            <TextView
                android:id="@+id/tvLowStock"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="?? Niska zaliha: 0"
                android:textSize="16sp"
                android:layout_marginBottom="8dp" />

            <TextView
                android:id="@+id/tvOutOfStock"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="? Bez zaliha: 0"
                android:textSize="16sp"
                android:layout_marginBottom="8dp" />

            <TextView
                android:id="@+id/tvCategoryCount"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="??? Kategorija: 0"
                android:textSize="16sp" />
        </LinearLayout>

        <!-- Niska zaliha lista -->
        <TextView
            android:id="@+id/tvLowStockList"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginBottom="16dp"
            android:padding="16dp"
            android:background="@android:color/white"
            android:elevation="4dp"
            android:text="Uèitavam..."
            android:textSize="14sp"
            android:lineSpacingExtra="4dp" />

        <!-- DUGME ZA CSV -->
        <Button
            android:id="@+id/btnExportCSV"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="?? Izvezi CSV"
            android:layout_marginBottom="8dp"
            android:backgroundTint="@color/purple_500"
            android:textColor="@color/white" />

        <!-- NOVO: DUGME ZA EMAIL -->
        <Button
            android:id="@+id/btnEmailReport"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="?? Pošalji na Email"
            android:layout_marginBottom="16dp"
            android:backgroundTint="@color/teal_700"
            android:textColor="@color/white" />

        <!-- Progress bar -->
        <ProgressBar
            android:id="@+id/progressBar"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_gravity="center"
            android:layout_marginBottom="16dp" />

        <!-- Nazad dugme -->
        <Button
            android:id="@+id/btnBack"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="?? Nazad" />

    </LinearLayout>
</ScrollView>


FILE: app\src\main\res\layout\activity_stats.xml

<?xml version="1.0" encoding="utf-8"?>
<ScrollView xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="@color/light_gray">

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="vertical"
        android:padding="16dp">

        <!-- Toolbar -->
        <androidx.appcompat.widget.Toolbar
            android:id="@+id/toolbar"
            android:layout_width="match_parent"
            android:layout_height="?attr/actionBarSize"
            android:background="@color/purple_500"
            app:title="?? Statistike"
            app:titleTextColor="@color/white" />

        <!-- Filter sekcija -->
        <androidx.cardview.widget.CardView
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginBottom="16dp"
            app:cardCornerRadius="8dp"
            app:cardElevation="4dp">

            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:orientation="vertical"
                android:padding="16dp">

                <TextView
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="?? Filter po vremenu"
                    android:textSize="18sp"
                    android:textStyle="bold"
                    android:layout_marginBottom="12dp" />

                <Spinner
                    android:id="@+id/spinnerFilter"
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:layout_marginBottom="8dp" />

                <Button
                    android:id="@+id/btnCustomDate"
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:text="Odaberi period"
                    android:visibility="gone" />

                <TextView
                    android:id="@+id/tvPeriod"
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="Sve vreme"
                    android:textStyle="italic"
                    android:layout_marginTop="8dp" />

            </LinearLayout>
        </androidx.cardview.widget.CardView>

        <!-- Pregled sekcija -->
        <androidx.cardview.widget.CardView
            android:id="@+id/cardOverview"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginBottom="16dp"
            app:cardCornerRadius="8dp"
            app:cardElevation="4dp">

            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:orientation="vertical"
                android:padding="16dp">

                <TextView
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="?? Pregled"
                    android:textSize="18sp"
                    android:textStyle="bold"
                    android:layout_marginBottom="12dp" />

                <LinearLayout
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:orientation="horizontal"
                    android:layout_marginBottom="8dp">

                    <TextView
                        android:layout_width="0dp"
                        android:layout_height="wrap_content"
                        android:layout_weight="1"
                        android:text="Ukupno proizvoda:" />

                    <TextView
                        android:id="@+id/tvTotalProducts"
                        android:layout_width="wrap_content"
                        android:layout_height="wrap_content"
                        android:text="0"
                        android:textStyle="bold" />

                </LinearLayout>

                <LinearLayout
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:orientation="horizontal"
                    android:layout_marginBottom="8dp">

                    <TextView
                        android:layout_width="0dp"
                        android:layout_height="wrap_content"
                        android:layout_weight="1"
                        android:text="Niska zaliha:" />

                    <TextView
                        android:id="@+id/tvLowStockCount"
                        android:layout_width="wrap_content"
                        android:layout_height="wrap_content"
                        android:text="0"
                        android:textColor="@color/teal_700"
                        android:textStyle="bold" />

                </LinearLayout>

                <LinearLayout
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:orientation="horizontal"
                    android:layout_marginBottom="8dp">

                    <TextView
                        android:layout_width="0dp"
                        android:layout_height="wrap_content"
                        android:layout_weight="1"
                        android:text="Bez zaliha:" />

                    <TextView
                        android:id="@+id/tvOutOfStock"
                        android:layout_width="wrap_content"
                        android:layout_height="wrap_content"
                        android:text="0"
                        android:textColor="@color/teal_700"
                        android:textStyle="bold" />

                </LinearLayout>

                <LinearLayout
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:orientation="horizontal">

                    <TextView
                        android:layout_width="0dp"
                        android:layout_height="wrap_content"
                        android:layout_weight="1"
                        android:text="Ukupna kolièina:" />

                    <TextView
                        android:id="@+id/tvTotalQuantity"
                        android:layout_width="wrap_content"
                        android:layout_height="wrap_content"
                        android:text="0"
                        android:textStyle="bold" />

                </LinearLayout>

            </LinearLayout>
        </androidx.cardview.widget.CardView>

        <!-- NAPREDNE STATISTIKE - OVO JE ISPRAVNO MESTO -->
        <androidx.cardview.widget.CardView
            android:id="@+id/cardAdvancedStats"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginBottom="16dp"
            app:cardCornerRadius="8dp"
            app:cardElevation="4dp">

            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:orientation="vertical"
                android:padding="16dp">

                <TextView
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="?? Napredne statistike"
                    android:textSize="18sp"
                    android:textStyle="bold"
                    android:layout_marginBottom="12dp" />

                <!-- OVDE DODAJTE TEXTVIEW-OVE -->
                <TextView
                    android:id="@+id/tvAverageQuantity"
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="?? Proseèno: 0.0 kom"
                    android:textSize="14sp"
                    android:layout_marginBottom="4dp" />

                <!-- UKLONI TVTotalValue ILI SAKRIJ -->
                <TextView
                    android:id="@+id/tvTotalValue"
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="?? Vrednost: 0 RSD"
                    android:textSize="14sp"
                    android:layout_marginBottom="4dp"
                    android:visibility="gone" /> <!-- SAKRIVAMO GA -->

                <TextView
                    android:id="@+id/tvTopCategory"
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="?? Top kategorija: Nema"
                    android:textSize="14sp"
                    android:layout_marginBottom="4dp" />

                <TextView
                    android:id="@+id/tvNeedReorder"
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="?? Za naruèivanje: 0"
                    android:textSize="14sp"
                    android:layout_marginBottom="8dp" />

                <TextView
                    android:id="@+id/tvDistribution"
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="?? Distribucija zaliha:\n• ?? Nema (0): 0\n• ?? Kritièno (1-2): 0\n• ?? Nisko (3-5): 0\n• ?? Normalno (6-20): 0\n• ?? Visoko (20+): 0"
                    android:textSize="12sp"
                    android:lineSpacingExtra="4dp" />

            </LinearLayout>
        </androidx.cardview.widget.CardView>

        <!-- Niska zaliha sekcija -->
        <androidx.cardview.widget.CardView
            android:id="@+id/cardLowStock"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginBottom="16dp"
            app:cardCornerRadius="8dp"
            app:cardElevation="4dp">

            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:orientation="vertical"
                android:padding="16dp">

                <TextView
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="?? Niska zaliha (Top 5)"
                    android:textSize="18sp"
                    android:textStyle="bold"
                    android:layout_marginBottom="12dp" />

                <ScrollView
                    android:layout_width="match_parent"
                    android:layout_height="200dp">

                    <TextView
                        android:id="@+id/tvLowStockList"
                        android:layout_width="match_parent"
                        android:layout_height="wrap_content"
                        android:text="Nema proizvoda sa niskom zaliom"
                        android:textSize="14sp"
                        android:lineSpacingExtra="4dp" />

                </ScrollView>

            </LinearLayout>
        </androidx.cardview.widget.CardView>

        <!-- GRAFIKON -->
        <androidx.cardview.widget.CardView
            android:id="@+id/cardChart"
            android:layout_width="match_parent"
            android:layout_height="300dp"
            android:layout_marginBottom="16dp"
            app:cardCornerRadius="8dp"
            app:cardElevation="4dp">

            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="match_parent"
                android:orientation="vertical"
                android:padding="16dp">

                <TextView
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="?? Grafikon distribucije"
                    android:textSize="18sp"
                    android:textStyle="bold"
                    android:layout_marginBottom="12dp" />

                <com.github.mikephil.charting.charts.PieChart
                    android:id="@+id/pieChart"
                    android:layout_width="match_parent"
                    android:layout_height="match_parent" />

            </LinearLayout>
        </androidx.cardview.widget.CardView>

        <!-- Kategorije sekcija -->
        <androidx.cardview.widget.CardView
            android:id="@+id/cardCategories"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginBottom="16dp"
            app:cardCornerRadius="8dp"
            app:cardElevation="4dp">

            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:orientation="vertical"
                android:padding="16dp">

                <TextView
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="?? Kategorije (Top 5)"
                    android:textSize="18sp"
                    android:textStyle="bold"
                    android:layout_marginBottom="12dp" />

                <ScrollView
                    android:layout_width="match_parent"
                    android:layout_height="200dp">

                    <TextView
                        android:id="@+id/tvCategoryStats"
                        android:layout_width="match_parent"
                        android:layout_height="wrap_content"
                        android:text="Uèitavam..."
                        android:textSize="14sp"
                        android:lineSpacingExtra="4dp" />

                </ScrollView>

            </LinearLayout>
        </androidx.cardview.widget.CardView>

        <!-- Vreme generisanja -->
        <TextView
            android:id="@+id/tvGeneratedTime"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="?? Generisano: "
            android:textSize="12sp"
            android:textColor="@color/darker_gray"
            android:layout_marginBottom="16dp"
            android:layout_gravity="center" />

        <!-- PRVA LINIJA DUGMADI: PDF i Share -->
        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            android:layout_marginBottom="16dp">

            <Button
                android:id="@+id/btnExportPDF"
                android:layout_width="0dp"
                android:layout_height="wrap_content"
                android:layout_weight="1"
                android:text="?? PDF Izveštaj"
                android:layout_marginEnd="8dp"
                android:backgroundTint="@color/purple_500"
                android:textColor="@color/white" />

            <Button
                android:id="@+id/btnShare"
                android:layout_width="0dp"
                android:layout_height="wrap_content"
                android:layout_weight="1"
                android:text="?? Podeli"
                android:layout_marginStart="8dp"
                android:backgroundTint="@color/teal_200"
                android:textColor="@color/black" />

        </LinearLayout>

        <!-- DRUGA LINIJA DUGMADI: CSV i Email -->
        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            android:layout_marginBottom="24dp">

            <Button
                android:id="@+id/btnExportCSV"
                android:layout_width="0dp"
                android:layout_height="wrap_content"
                android:layout_weight="1"
                android:text="?? CSV Izveštaj"
                android:layout_marginEnd="8dp"
                android:backgroundTint="@color/teal_700"
                android:textColor="@color/white" />

            <Button
                android:id="@+id/btnEmailReport"
                android:layout_width="0dp"
                android:layout_height="wrap_content"
                android:layout_weight="1"
                android:text="?? Email Izveštaj"
                android:layout_marginStart="8dp"
                android:backgroundTint="@color/purple_500"
                android:textColor="@color/white" />

        </LinearLayout>

        <!-- Progress bar -->
        <ProgressBar
            android:id="@+id/progressBar"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_gravity="center"
            android:visibility="gone" />

    </LinearLayout>
</ScrollView>


FILE: app\src\main\res\layout\activity_stats_improved.xml

<?xml version="1.0" encoding="utf-8"?>
<ScrollView xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent">

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="vertical"
        android:padding="16dp">

        <!-- KARTICE SA STATISTIKAMA (Grid) -->
        <GridLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:columnCount="2"
            android:rowCount="3">

            <!-- Kartica 1: Ukupno proizvoda -->
            <androidx.cardview.widget.CardView
                android:layout_width="0dp"
                android:layout_height="120dp"
                android:layout_columnWeight="1"
                android:layout_margin="4dp"
                app:cardBackgroundColor="@color/purple_500"
                app:cardCornerRadius="12dp">

                <LinearLayout
                    android:layout_width="match_parent"
                    android:layout_height="match_parent"
                    android:gravity="center"
                    android:orientation="vertical"
                    android:padding="16dp">

                    <TextView
                        android:text="??"
                        android:textSize="24sp"
                        android:textColor="@color/white" />

                    <TextView
                        android:id="@+id/tvTotalProducts"
                        android:text="0"
                        android:textSize="28sp"
                        android:textColor="@color/white"
                        android:textStyle="bold" />

                    <TextView
                        android:text="Ukupno proizvoda"
                        android:textSize="12sp"
                        android:textColor="@color/white" />
                </LinearLayout>
            </androidx.cardview.widget.CardView>

            <!-- Kartica 2: Ukupna vrednost -->
            <!-- ... ostale kartice ... -->

        </GridLayout>

        <!-- GRAFIKON (opciono) -->
        <com.github.mikephil.charting.charts.PieChart
            android:id="@+id/pieChart"
            android:layout_width="match_parent"
            android:layout_height="300dp"
            android:layout_marginTop="16dp" />

        <!-- LISTA ZA NARUÈIVANJE -->
        <androidx.cardview.widget.CardView
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginTop="16dp">

            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:orientation="vertical"
                android:padding="16dp">

                <TextView
                    android:text="?? HITNO ZA NARUÈIVANJE"
                    android:textSize="18sp"
                    android:textStyle="bold"
                    android:layout_marginBottom="12dp" />

                <ListView
                    android:id="@+id/listReorder"
                    android:layout_width="match_parent"
                    android:layout_height="200dp" />
            </LinearLayout>
        </androidx.cardview.widget.CardView>

        <!-- DUGMADI ZA AKCIJE -->
        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            android:layout_marginTop="16dp">

            <Button
                android:id="@+id/btnExportPDF"
                android:layout_width="0dp"
                android:layout_height="wrap_content"
                android:layout_weight="1"
                android:text="?? PDF"
                android:layout_marginEnd="4dp" />

            <Button
                android:id="@+id/btnExportCSV"
                android:layout_width="0dp"
                android:layout_height="wrap_content"
                android:layout_weight="1"
                android:text="?? CSV"
                android:layout_marginHorizontal="4dp" />

            <Button
                android:id="@+id/btnEmail"
                android:layout_width="0dp"
                android:layout_height="wrap_content"
                android:layout_weight="1"
                android:text="?? Email"
                android:layout_marginStart="4dp" />
        </LinearLayout>

        <!-- PROGRESS BAR -->
        <ProgressBar
            android:id="@+id/progressBar"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_gravity="center"
            android:layout_marginTop="16dp"
            android:visibility="gone" />
    </LinearLayout>
</ScrollView>


FILE: app\src\main\res\layout\dialog_add_category.xml

<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:orientation="vertical"
    android:padding="16dp">

    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Naziv kategorije:"
        android:layout_marginBottom="8dp" />

    <EditText
        android:id="@+id/etNazivKategorije"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:hint="Unesite naziv"
        android:layout_marginBottom="24dp" />

    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Emoji:"
        android:layout_marginBottom="8dp" />

    <Spinner
        android:id="@+id/spEmoji"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginBottom="24dp" />

    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Boja:"
        android:layout_marginBottom="8dp" />

    <Spinner
        android:id="@+id/spBoja"
        android:layout_width="match_parent"
        android:layout_height="wrap_content" />

</LinearLayout>


FILE: app\src\main\res\layout\item_kategorija.xml

<?xml version="1.0" encoding="utf-8"?>
<androidx.cardview.widget.CardView
    xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:id="@+id/cardKategorija"
    android:layout_width="match_parent"
    android:layout_height="100dp"
    android:layout_margin="8dp"
    app:cardCornerRadius="12dp"
    app:cardElevation="4dp">

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:orientation="vertical"
        android:gravity="center"
        android:padding="16dp">

        <TextView
            android:id="@+id/tvIkona"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:textSize="32sp"
            android:fontFamily="monospace"
            android:text="??" />

        <TextView
            android:id="@+id/tvNazivKategorija"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:maxLines="2"
            android:textAlignment="center"
            android:text="Hrana"
            android:textSize="16sp"
            android:textStyle="bold"
            android:layout_marginTop="8dp" />

    </LinearLayout>

</androidx.cardview.widget.CardView>


FILE: app\src\main\res\layout\item_proizvod.xml

<?xml version="1.0" encoding="utf-8"?>
<androidx.cardview.widget.CardView xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:id="@+id/cardView"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:layout_margin="4dp"
    app:cardCornerRadius="8dp"
    app:cardElevation="4dp">

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="vertical"
        android:padding="12dp">

        <TextView
            android:id="@+id/tvNaziv"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="Proizvod"
            android:textSize="18sp"
            android:textStyle="bold" />

        <TextView
            android:id="@+id/tvKategorija"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="Kategorija"
            android:textSize="14sp" />

        <TextView
            android:id="@+id/tvKolicina"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="Kolièina: 0"
            android:textSize="14sp" />

        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            android:layout_marginTop="8dp"
            tools:ignore="ExtraText">


            <ImageButton
                android:id="@+id/btnMinus"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:layout_weight="1"
                android:src="@android:drawable/ic_menu_close_clear_cancel"
                android:background="?attr/selectableItemBackgroundBorderless"
                android:contentDescription="Smanji kolièinu" />

            <ImageButton
                android:id="@+id/btnPlus"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:layout_weight="1"
                android:background="?attr/selectableItemBackgroundBorderless"
                android:src="@android:drawable/ic_input_add"
                android:contentDescription="Poveæaj kolièinu" />

            <ImageButton
                android:id="@+id/btnEdit"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:layout_weight="1"
                android:background="?attr/selectableItemBackgroundBorderless"
                android:src="@android:drawable/ic_menu_edit"
                android:contentDescription="Izmeni" />

            <ImageButton
                android:id="@+id/btnDelete"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:layout_weight="1"
                android:background="?attr/selectableItemBackgroundBorderless"
                android:src="@android:drawable/ic_menu_delete"
                android:contentDescription="Obriši" />

        </LinearLayout>

    </LinearLayout>

</androidx.cardview.widget.CardView>


FILE: app\src\main\res\layout\menu_item_layout.xml

<?xml version="1.0" encoding="utf-8"?>
<TextView xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:textColor="@color/black"
    android:textSize="14sp"
    android:padding="8dp" />


FILE: app\src\main\res\menu\menu_kategorije.xml

<?xml version="1.0" encoding="utf-8"?>
<menu xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto">

    <!-- Bez ikona, samo tekst -->
    <item
        android:id="@+id/menu_add_category"
        android:title="? Dodaj kategoriju"
        app:showAsAction="ifRoom" />

    <item
        android:id="@+id/menu_delete_category"
        android:title="??? Obriši kategoriju"
        app:showAsAction="ifRoom" />

    <item
        android:id="@+id/menu_stats"
        android:title="?? Statistike"
        app:showAsAction="ifRoom" />

    <item
        android:id="@+id/menu_logout"
        android:title="?? Odjava"
        app:showAsAction="ifRoom" />

</menu>


FILE: app\src\main\res\menu\menu_main.xml

<?xml version="1.0" encoding="utf-8"?>
<menu xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto">

    <!-- Glavna sort opcija sa ikonom -->
    <item
        android:id="@+id/menu_sort"
        android:title="?? Sortiraj"
        android:icon="@android:drawable/ic_menu_sort_by_size"
        app:showAsAction="ifRoom" />

</menu>


FILE: app\src\main\res\menu\menu_sort_options.xml

<?xml version="1.0" encoding="utf-8"?>
<menu xmlns:android="http://schemas.android.com/apk/res/android">
    <item
        android:id="@+id/menu_sort_name_asc"
        android:title="Naziv (A › Z)" />

    <item
        android:id="@+id/menu_sort_name_desc"
        android:title="Naziv (Z › A)" />

    <item
        android:id="@+id/menu_sort_quantity_asc"
        android:title="Kolièina (manje › više)" />

    <item
        android:id="@+id/menu_sort_quantity_desc"
        android:title="Kolièina (više › manje)" />

    <item
        android:id="@+id/menu_sort_category"
        android:title="Po kategoriji" />
</menu>


FILE: app\src\main\res\mipmap-anydpi-v26\ic_launcher.xml

<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@drawable/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/logo"/>
</adaptive-icon>


FILE: app\src\main\res\mipmap-anydpi-v26\ic_launcher_round.xml

<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@drawable/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/logo"/>
</adaptive-icon>


FILE: app\src\main\res\values\colors.xml

<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="purple_200">#FFBB86FC</color>
    <color name="purple_500">#FF6200EE</color>
    <color name="purple_700">#FF3700B3</color>
    <color name="teal_200">#FF03DAC5</color>
    <color name="teal_700">#FF018786</color>
    <color name="black">#FF000000</color>
    <color name="white">#FFFFFFFF</color>
    <color name="menu_text_color">#FFFFFF</color>  <!-- Bela za toolbar -->
    <color name="popup_text_color">#000000</color> <!-- Crna za popup -->


    <color name="darker_gray">#757575</color>
    <!-- Ove boje su potrebne za kartice -->
    <color name="light_gray">#F5F5F5</color>
    <color name="red_light">#FFCDD2</color>
    <color name="orange_light">#FFE0B2</color>
    <color name="green_light">#C8E6C9</color>


    <!-- Dodaj i ove ako treba -->
    <color name="blue_light">#BBDEFB</color>
    <color name="purple_light">#E1BEE7</color>
</resources>


FILE: app\src\main\res\values\strings.xml

<resources>
    <string name="app_name">SuperstockGO</string>
</resources>


FILE: app\src\main\res\values\styles.xml

<?xml version="1.0" encoding="utf-8"?>
<resources>
    <!-- Ovaj fajl može biti prazan ili imati druge stilove -->
    <!-- NEMA MenuTextStyle i PopupMenuStyle ovde! -->
</resources>


FILE: app\src\main\res\values\themes.xml

<?xml version="1.0" encoding="utf-8"?>
<resources xmlns:tools="http://schemas.android.com/tools">

    <!-- Osnovna tema -->
    <style name="Theme.SuperstockGO" parent="Theme.MaterialComponents.DayNight.NoActionBar">
        <item name="colorPrimary">@color/purple_500</item>
        <item name="colorPrimaryVariant">@color/purple_700</item>
        <item name="colorOnPrimary">@color/white</item>
        <item name="colorSecondary">@color/teal_200</item>
        <item name="colorSecondaryVariant">@color/teal_700</item>
        <item name="colorOnSecondary">@color/black</item>
        <item name="android:statusBarColor">@color/purple_700</item>

        <!-- OVO JE NAJVAŽNIJE ZA TEKST U MENIJU -->
        <item name="actionMenuTextColor">@color/white</item>

        <!-- VAŽNO: Dodajte ovo za popup meni sa CRNIM tekstom -->
        <item name="popupMenuStyle">@style/PopupMenuStyle</item>
        <item name="android:popupMenuStyle">@style/PopupMenuStyle</item>

        <!-- Toolbar stil -->
        <item name="toolbarStyle">@style/MyToolbarStyle</item>

        <!-- Dialog stilovi -->
        <item name="android:alertDialogTheme">@style/MyAlertDialogStyle</item>
        <item name="android:textColor">@color/black</item>
        <item name="android:textColorHint">@color/darker_gray</item>
    </style>

    <!-- Tema bez ActionBar-a -->
    <style name="Theme.SuperstockGO.NoActionBar" parent="Theme.SuperstockGO">
        <!-- Može ostati prazno -->
    </style>

    <!-- Toolbar stil -->
    <style name="MyToolbarStyle" parent="@style/Widget.AppCompat.Toolbar">
        <item name="titleTextColor">@color/white</item>
        <item name="subtitleTextColor">@color/white</item>
        <item name="android:textColorPrimary">@color/white</item>
        <!-- Dodajte ovo za popup temu -->
        <item name="popupTheme">@style/PopupMenuStyle</item>
    </style>

    <!-- AlertDialog stil -->
    <style name="MyAlertDialogStyle" parent="ThemeOverlay.MaterialComponents.Dialog.Alert">
        <item name="android:textColorPrimary">@color/black</item>
        <item name="android:textColor">@color/black</item>
        <item name="android:textColorHint">@color/darker_gray</item>
        <item name="android:background">@color/white</item>
    </style>

    <!-- Popup Menu stil sa CRNIM tekstom na BELOJ pozadini -->
    <style name="PopupMenuStyle" parent="ThemeOverlay.AppCompat.Light">
        <item name="android:textColor">@color/black</item>      <!-- CRN tekst -->
        <item name="android:background">@color/white</item>     <!-- BELA pozadina -->
        <item name="android:itemBackground">@color/light_gray</item> <!-- Svetlo siva za hover -->
    </style>

    <!-- Light tema za popup meni -->
    <style name="Theme.SuperstockGO.LightPopup" parent="Theme.MaterialComponents.Light.NoActionBar">
        <item name="colorPrimary">@color/purple_500</item>
        <item name="colorPrimaryVariant">@color/purple_700</item>
        <item name="colorOnPrimary">@color/white</item>
        <item name="android:textColor">@color/black</item>
        <item name="android:textColorPrimary">@color/black</item>
        <item name="android:background">@color/white</item>
    </style>

</resources>


FILE: app\src\main\res\xml\backup_rules.xml

<?xml version="1.0" encoding="utf-8"?><!--
   Sample backup rules file; uncomment and customize as necessary.
   See https://developer.android.com/guide/topics/data/autobackup
   for details.
   Note: This file is ignored for devices older than API 31
   See https://developer.android.com/about/versions/12/backup-restore
-->
<full-backup-content>
    <!--
   <include domain="sharedpref" path="."/>
   <exclude domain="sharedpref" path="device.xml"/>
-->
</full-backup-content>


FILE: app\src\main\res\xml\data_extraction_rules.xml

<?xml version="1.0" encoding="utf-8"?>
<data-extraction-rules>
    <cloud-backup>
        <exclude domain="sharedpref" path="."/>
        <exclude domain="database" path="."/>
        <exclude domain="file" path="."/>
        <exclude domain="external" path="."/>
    </cloud-backup>
    <device-transfer>
        <exclude domain="sharedpref" path="."/>
        <exclude domain="database" path="."/>
        <exclude domain="file" path="."/>
        <exclude domain="external" path="."/>
    </device-transfer>
</data-extraction-rules>


FILE: app\src\main\res\xml\file_paths.xml

<?xml version="1.0" encoding="utf-8"?>
<paths xmlns:android="http://schemas.android.com/apk/res/android">
    <!-- External storage -->
    <external-path
        name="external_files"
        path="." />

    <!-- Downloads directory -->
    <external-path
        name="downloads"
        path="Download/" />

    <!-- External files directory -->
    <external-path
        name="external"
        path="." />

    <!-- Cache directory -->
    <cache-path
        name="cache"
        path="." />

    <!-- External cache -->
    <external-cache-path
        name="external_cache"
        path="." />

    <!-- Files directory -->
    <files-path
        name="files"
        path="." />
</paths>


FILE: app\src\test\java\com\jovannedeljkovic\superstockgo\ExampleUnitTest.kt

package com.jovannedeljkovic.superstockgo

import org.junit.Test

import org.junit.Assert.*

/**
 * Example local unit test, which will execute on the development machine (host).
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
class ExampleUnitTest {
    @Test
    fun addition_isCorrect() {
        assertEquals(4, 2 + 2)
    }
}


FILE: gradle\wrapper\gradle-wrapper.properties

#Tue Dec 09 11:59:40 CET 2025
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.13-bin.zip
networkTimeout=10000
validateDistributionUrl=true
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists



